<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expande Tu Futuro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #07070f; color: #e0e0e0; min-height: 100vh; }
.mono { font-family: 'JetBrains Mono', monospace; }
.card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 14px; }
.btn-p { padding: 3px 13px; border-radius: 7px; font-size: 12px; font-weight: 600;
         color: rgba(255,255,255,0.3); transition: all .15s; cursor: pointer; }
.btn-p:hover:not(.active) { color: #fff; background: rgba(255,255,255,0.06); }
.btn-p.active { background: #ff007f; color: #fff; }
#chartWrap { height: 620px; }

/* Toasts */
#toasts { position: fixed; top: 16px; right: 16px; z-index: 1000;
          display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.toast { padding: 11px 15px; border-radius: 11px; font-size: 13px; font-weight: 500;
         max-width: 340px; backdrop-filter: blur(14px); pointer-events: auto;
         animation: slideIn .25s ease; line-height: 1.45; }
.toast.bullish { background: rgba(0,230,118,.12); color: #00e676; border: 1px solid rgba(0,230,118,.25); }
.toast.bearish  { background: rgba(255,68,68,.12);  color: #ff5252; border: 1px solid rgba(255,68,68,.25); }
.toast.info     { background: rgba(255,0,127,.12);  color: #ff69b4; border: 1px solid rgba(255,0,127,.25); }
@keyframes slideIn { from { opacity:0; transform:translateX(12px); } to { opacity:1; transform:none; } }

.alerta-item { padding: 7px 10px; border-radius: 9px; font-size: 11.5px; font-weight: 500; line-height: 1.4; }
.alerta-item.bullish { background: rgba(0,230,118,.07); color: #00e676; }
.alerta-item.bearish  { background: rgba(255,68,68,.07);  color: #ff5252; }
.alerta-item.info     { background: rgba(255,0,127,.07);  color: #ff69b4; }

.fav-row { display: flex; align-items: center; justify-content: space-between;
           padding: 5px 8px; border-radius: 9px; cursor: pointer;
           transition: background .15s; gap: 8px; }
.fav-row:hover { background: rgba(255,255,255,.04); }
.fav-row.active-sym { background: rgba(255,0,127,.07); }

/* Toggle favoritos */
.fav-toggle { width: 100%; display: flex; align-items: center; justify-content: space-between;
              padding: 0 2px 0 2px; cursor: pointer; background: none; border: none; color: inherit; }
.fav-toggle:hover .fav-label { color: rgba(255,255,255,.4); }
.fav-label { font-size: 10px; text-transform: uppercase; letter-spacing: .1em;
             color: rgba(255,255,255,.2); font-weight: 600; transition: color .15s; }
.fav-chevron { font-size: 9px; color: rgba(255,255,255,.2); transition: transform .2s; }
.fav-chevron.open { transform: rotate(0deg); }
.fav-chevron.closed { transform: rotate(-90deg); }
#favList { overflow: hidden; transition: max-height .25s ease, opacity .2s ease; }

input:focus { outline: none; border-color: rgba(255,0,127,.5) !important; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 4px; }
</style>
</head>
<body>

<div id="toasts"></div>

<div class="max-w-[1600px] mx-auto p-4 lg:p-5 flex flex-col gap-4">

  <!-- HEADER -->
  <header class="flex items-center justify-between gap-3 flex-wrap">
    <div class="flex items-center gap-2.5">
      <div class="w-8 h-8 rounded-lg flex items-center justify-center shrink-0"
           style="background:#ff007f;box-shadow:0 0 16px rgba(255,0,127,.35)">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
      </div>
      <span class="text-base font-bold tracking-tight">EXPANDE
        <span style="color:#ff007f">TU FUTURO</span></span>
    </div>

    <div class="flex items-center gap-2 flex-1 max-w-sm">
      <input id="symbolInput" type="text" placeholder="AAPL · BTC-USD · ^GSPC · SPY…"
             class="flex-1 bg-[#111] border border-white/10 rounded-lg px-3 py-2 text-sm transition-all"
             onkeydown="if(event.key==='Enter') doSearch()">
      <button onclick="doSearch()"
              class="px-4 py-2 rounded-lg text-sm font-semibold text-white shrink-0 hover:brightness-110 transition-all"
              style="background:#ff007f">Buscar</button>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="flex flex-col lg:flex-row gap-4">

    <!-- SIDEBAR -->
    <div class="lg:w-[205px] shrink-0 flex flex-col gap-3">

      <!-- Precio + RSI -->
      <div class="card p-4">
        <div id="displaySymbol" class="text-[11px] font-bold tracking-widest mb-1" style="color:#ff007f">---</div>
        <div id="displayPrice" class="mono text-2xl font-semibold leading-tight">---</div>
        <div id="displayChange" class="text-xs mt-1.5 font-medium">--</div>

        <div class="mt-3 pt-3 border-t border-white/5">
          <div class="flex items-center justify-between mb-1.5">
            <span class="text-[10px] text-white/25 uppercase tracking-wider">RSI 14</span>
            <div class="flex items-center gap-1.5">
              <span id="rsiVal" class="mono text-sm font-bold text-white">--</span>
              <span id="rsiLbl" class="text-[9px] px-1.5 py-0.5 rounded font-bold"
                    style="background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">--</span>
            </div>
          </div>
          <div class="relative h-1.5 rounded-full overflow-visible"
               style="background:linear-gradient(to right,#00e67630 0%,#00e67630 30%,rgba(255,255,255,.06) 30%,rgba(255,255,255,.06) 70%,#ff174430 70%,#ff174430 100%)">
            <div id="rsiCur" class="absolute top-1/2 w-2 h-2 rounded-full bg-white shadow"
                 style="left:50%;transform:translate(-50%,-50%);transition:left .4s"></div>
          </div>
        </div>
      </div>

      <!-- Favoritos (colapsable) -->
      <div class="card p-3">
        <button class="fav-toggle" onclick="toggleFavs()">
          <span class="fav-label">Favoritos</span>
          <span id="favChevron" class="fav-chevron open">▼</span>
        </button>
        <div id="favList" style="max-height:400px;opacity:1;">
          <div class="flex flex-col gap-0.5 mt-2" id="favItems"></div>
        </div>
      </div>

      <!-- Alertas activas -->
      <div id="alertBox" class="card p-3 hidden">
        <div class="text-[10px] uppercase tracking-widest text-white/20 font-semibold mb-2 px-1">
          ⚡ Alertas
        </div>
        <div id="alertList" class="flex flex-col gap-1.5 max-h-72 overflow-y-auto pr-0.5"></div>
      </div>

      <!-- Estado monitoreo -->
      <div class="card p-3">
        <div class="flex items-center justify-between">
          <span class="text-[10px] uppercase tracking-widest text-white/20 font-semibold">Vigilancia</span>
          <div class="flex items-center gap-1.5">
            <span id="watchDot" class="w-1.5 h-1.5 rounded-full bg-white/20"></span>
            <span id="watchLabel" class="text-[10px] text-white/20">--</span>
          </div>
        </div>
        <p class="text-[10px] text-white/15 mt-1.5 leading-4">
          Comprueba todos los favoritos cada 5 min y alerta si el precio toca alguna SMA.
        </p>
      </div>

    </div><!-- end sidebar -->

    <!-- CHART -->
    <div class="flex-1 card p-4">
      <div class="flex items-center justify-between mb-4 gap-3 flex-wrap">
        <div class="flex gap-0.5 bg-white/5 p-0.5 rounded-xl">
          <button class="btn-p" data-p="1d"  onclick="setPeriod('1d')">1D</button>
          <button class="btn-p" data-p="5d"  onclick="setPeriod('5d')">5D</button>
          <button class="btn-p active" data-p="1mo" onclick="setPeriod('1mo')">1M</button>
          <button class="btn-p" data-p="6mo" onclick="setPeriod('6mo')">6M</button>
          <button class="btn-p" data-p="1y"  onclick="setPeriod('1y')">1Y</button>
          <button class="btn-p" data-p="2y"  onclick="setPeriod('2y')">2Y</button>
        </div>
        <div class="flex items-center gap-3 flex-wrap" style="font-size:10px;color:rgba(255,255,255,.25)">
          <span><span style="color:rgba(255,255,255,.65)">─</span> Precio</span>
          <span><span style="color:#00ffff70">─</span> SMA20</span>
          <span><span style="color:#ffff0070">─</span> SMA50</span>
          <span><span style="color:#fff17670">─</span> SMA100</span>
          <span><span style="color:#ce93d870">─</span> SMA200</span>
          <span><span style="color:#00ff00">·</span>ST▲ <span style="color:#ff3333">·</span>ST▼</span>
          <span><span style="color:#ff007f">●</span> RSI</span>
        </div>
      </div>
      <div id="chartWrap"><canvas id="mainChart"></canvas></div>
    </div>

  </div>
</div>

<script>
// ── STATE ─────────────────────────────────
let currentSymbol = 'BTC-USD';
let currentPeriod = '1mo';
let mainChart     = null;
let sparkCharts   = {};
let favsOpen      = true;
let watchInterval = null;
// Guardamos las alertas ya mostradas para no repetir toasts
let shownAlerts   = new Set();

const FAVS = [
  { name:'Bitcoin',    ticker:'BTC-USD' },
  { name:'Ethereum',   ticker:'ETH-USD' },
  { name:'S&P 500',    ticker:'^GSPC'   },
  { name:'Nasdaq 100', ticker:'^NDX'    },
  { name:'Apple',      ticker:'AAPL'    },
  { name:'SPY',        ticker:'SPY'     },
  { name:'Oro',        ticker:'GLD'     },
];

// ── INIT ──────────────────────────────────
window.onload = () => {
  buildFavs();
  loadSymbol('BTC-USD');
  startWatcher();
};

// ── TOGGLE FAVORITOS ──────────────────────
function toggleFavs() {
  favsOpen = !favsOpen;
  const list    = document.getElementById('favList');
  const chevron = document.getElementById('favChevron');
  if (favsOpen) {
    list.style.maxHeight = '400px';
    list.style.opacity   = '1';
    chevron.classList.replace('closed','open');
  } else {
    list.style.maxHeight = '0';
    list.style.opacity   = '0';
    chevron.classList.replace('open','closed');
  }
}

// ── FAVORITOS ─────────────────────────────
function favId(ticker) { return ticker.replace(/[^a-z0-9]/gi,'_'); }

function buildFavs() {
  const c = document.getElementById('favItems');
  c.innerHTML = '';
  FAVS.forEach(f => {
    const id  = favId(f.ticker);
    const row = document.createElement('div');
    row.className = 'fav-row';
    row.id = 'fav-' + id;
    row.onclick = () => loadSymbol(f.ticker);
    row.innerHTML = `
      <div class="min-w-0">
        <div class="text-xs font-semibold truncate">${f.name}</div>
        <div class="mono text-[9px] text-white/25">${f.ticker}</div>
      </div>
      <div class="flex flex-col items-end gap-0.5 shrink-0">
        <canvas id="spark-${id}" width="52" height="20"></canvas>
        <span id="pct-${id}" class="mono text-[9px] text-white/25">…</span>
      </div>`;
    c.appendChild(row);
    loadSparkline(f.ticker);
  });
}

async function loadSparkline(ticker) {
  try {
    const res = await fetch(`/api/sparkline/${ticker}`);
    const d   = await res.json();
    if (!d.closes || d.closes.length < 2) return;
    const id  = favId(ticker);
    const cvs = document.getElementById(`spark-${id}`);
    if (!cvs) return;
    if (sparkCharts[ticker]) sparkCharts[ticker].destroy();
    const up = d.pct >= 0;
    sparkCharts[ticker] = new Chart(cvs.getContext('2d'), {
      type: 'line',
      data: {
        labels: d.closes.map((_,i) => i),
        datasets: [{ data: d.closes,
          borderColor: up ? '#00e676' : '#ff4444',
          backgroundColor: up ? 'rgba(0,230,118,.07)' : 'rgba(255,68,68,.07)',
          borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0 }]
      },
      options: { responsive:false, animation:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        scales:{ x:{display:false}, y:{display:false} } }
    });
    const pEl = document.getElementById(`pct-${id}`);
    if (pEl) { pEl.style.color = up ? '#00e676' : '#ff4444'; pEl.innerText = `${up?'+':''}${d.pct.toFixed(2)}%`; }
  } catch(e) {}
}

// ── VIGILANCIA AUTOMÁTICA ─────────────────
function startWatcher() {
  checkAllFavs(); // primera comprobación inmediata
  watchInterval = setInterval(checkAllFavs, 5 * 60 * 1000); // cada 5 min
}

async function checkAllFavs() {
  const tickers = FAVS.map(f => f.ticker).join(',');
  try {
    const res  = await fetch(`/api/watch?tickers=${encodeURIComponent(tickers)}`);
    const data = await res.json();
    if (!data.alertas || data.alertas.length === 0) {
      setWatchStatus('ok');
      return;
    }
    setWatchStatus('alert');
    // Solo mostrar toasts nuevos
    data.alertas.forEach(a => {
      if (!shownAlerts.has(a.msg)) {
        shownAlerts.add(a.msg);
        showToast(a.msg, a.nivel);
        // Limpiar cache de alertas pasadas las 2h para que no se acumule
        setTimeout(() => shownAlerts.delete(a.msg), 2 * 60 * 60 * 1000);
      }
    });
    // Actualizar panel de alertas si estamos en un fav afectado
    renderAlertas(data.alertas.filter(a => a.msg.includes(`[${currentSymbol}]`) || !a.msg.includes('[')));
  } catch(e) {
    setWatchStatus('err');
  }
}

function setWatchStatus(state) {
  const dot   = document.getElementById('watchDot');
  const label = document.getElementById('watchLabel');
  const map   = {
    ok:    ['#00e676', 'Activa'],
    alert: ['#ff007f', '¡Alerta!'],
    err:   ['#555',    'Error'],
  };
  const [color, text] = map[state] || map.ok;
  dot.style.background  = color;
  label.style.color     = color;
  label.innerText       = text;
}

// ── FETCH CHART ───────────────────────────
async function fetchData(symbol, period) {
  const res = await fetch(`/api/chart/${encodeURIComponent(symbol)}?period=${period}`);
  const d   = await res.json();
  if (d.error) throw new Error(d.error);
  return d;
}

// ── RENDER ────────────────────────────────
function renderChart(data) {
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (mainChart) mainChart.destroy();

  mainChart = new Chart(ctx, {
    type: 'line',
    data: { labels: data.chart.labels, datasets: data.chart.datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 200 },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(8,8,20,.93)',
          borderColor: 'rgba(255,255,255,.07)',
          borderWidth: 1,
          titleColor: '#fff',
          bodyColor: 'rgba(255,255,255,.55)',
          padding: 10,
          callbacks: {
            label: ctx => {
              if (ctx.parsed.y === null || ctx.parsed.y === undefined) return null;
              const v = ctx.parsed.y;
              return ` ${ctx.dataset.label}: ${v >= 1000
                ? v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})
                : v.toFixed(4)}`;
            }
          }
        }
      },
      scales: {
        y: {
          display: true, position: 'left',
          grid: { color: 'rgba(255,255,255,.03)', drawBorder: false },
          ticks: { color: 'rgba(255,255,255,.28)', font: { size: 10 },
                   callback: v => v >= 1000 ? v.toLocaleString() : v.toFixed(2) }
        },
        x: {
          grid: { display: false },
          ticks: { color: 'rgba(255,255,255,.22)', font: { size: 10 }, maxTicksLimit: 10 }
        }
      }
    }
  });

  // Panel precio
  document.getElementById('displaySymbol').innerText = currentSymbol;
  document.getElementById('displayPrice').innerText  =
    data.last_price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  const chEl = document.getElementById('displayChange');
  const pre  = data.change >= 0 ? '+' : '';
  chEl.innerText   = `${pre}${data.change.toFixed(2)} (${pre}${data.change_pct.toFixed(2)}%)`;
  chEl.style.color = data.change >= 0 ? '#00e676' : '#ff4444';

  updateRSI(data.rsi_current);
  renderAlertas(data.alertas || []);
}

function updateRSI(v) {
  v = parseFloat(v);
  document.getElementById('rsiVal').innerText = v.toFixed(1);
  document.getElementById('rsiCur').style.left = `calc(${Math.min(Math.max(v,0),100)}% - 4px)`;
  const lbl = document.getElementById('rsiLbl');
  const val = document.getElementById('rsiVal');
  if (v < 30) {
    lbl.innerText = 'SV'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(0,230,118,.12);color:#00e676;font-weight:700;';
    val.style.color = '#00e676';
  } else if (v > 70) {
    lbl.innerText = 'SC'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,68,68,.12);color:#ff5252;font-weight:700;';
    val.style.color = '#ff5252';
  } else {
    lbl.innerText = 'N';  lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);font-weight:700;';
    val.style.color = '#fff';
  }
}

function renderAlertas(alertas) {
  const box  = document.getElementById('alertBox');
  const list = document.getElementById('alertList');
  if (!alertas || alertas.length === 0) { box.classList.add('hidden'); return; }
  box.classList.remove('hidden');
  list.innerHTML = alertas.map(a =>
    `<div class="alerta-item ${a.nivel}">${a.msg}</div>`).join('');
}

function showToast(msg, nivel, duration=7000) {
  const c = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = `toast ${nivel}`;
  t.innerText = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), duration);
}

// ── CONTROL ───────────────────────────────
async function loadSymbol(sym) {
  currentSymbol = sym;
  document.getElementById('symbolInput').value = sym;
  document.querySelectorAll('.fav-row').forEach(r => r.classList.remove('active-sym'));
  const el = document.getElementById('fav-' + favId(sym));
  if (el) el.classList.add('active-sym');
  try {
    const data = await fetchData(sym, currentPeriod);
    renderChart(data);
  } catch(e) {
    showToast('❌ ' + e.message, 'bearish');
  }
}

function doSearch() {
  const sym = document.getElementById('symbolInput').value.trim().toUpperCase();
  if (sym) loadSymbol(sym);
}

function setPeriod(p) {
  currentPeriod = p;
  document.querySelectorAll('.btn-p').forEach(b => b.classList.toggle('active', b.dataset.p === p));
  loadSymbol(currentSymbol);
}
</script>
</body>
</html>
