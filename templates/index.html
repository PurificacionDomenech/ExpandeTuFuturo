<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expande Tu Futuro</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{font-family:'Inter',sans-serif;background:#07070f;color:#e0e0e0;min-height:100vh}
.mono{font-family:'JetBrains Mono',monospace}
.card{background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.07);border-radius:16px}

/* Botones perÃ­odo */
.btn-p{padding:5px 14px;border-radius:8px;font-size:12px;font-weight:600;
  color:rgba(255,255,255,.3);cursor:pointer;background:transparent;border:none;
  font-family:'Inter',sans-serif;transition:all .15s}
.btn-p:hover:not(.active){color:#fff;background:rgba(255,255,255,.06)}
.btn-p.active{background:#ff007f;color:#fff;box-shadow:0 0 12px rgba(255,0,127,.35)}

/* Botones indicador toggle */
.btn-ind{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;
  transition:all .15s;border:1px solid transparent;font-family:'Inter',sans-serif;
  white-space:nowrap}
.btn-ind.off{opacity:.28;filter:grayscale(.6)}

/* Charts */
#plotDiv{width:100%;height:400px}
#rsiDiv{width:100%;height:100px}

/* RSI sidebar bar */
#rsiBar{height:5px;border-radius:3px;background:linear-gradient(to right,
  rgba(0,230,118,.4) 0%,rgba(0,230,118,.4) 30%,rgba(255,255,255,.06) 30%,
  rgba(255,255,255,.06) 70%,rgba(255,68,68,.4) 70%,rgba(255,68,68,.4) 100%);
  position:relative;margin-top:6px}
#rsiCursor{position:absolute;top:50%;width:10px;height:10px;border-radius:50%;
  background:#fff;box-shadow:0 0 6px rgba(255,255,255,.5);
  transform:translate(-50%,-50%);transition:left .4s ease;left:50%}

/* Toasts */
#toasts{position:fixed;top:16px;right:16px;z-index:9999;
  display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:10px 15px;border-radius:11px;font-size:13px;font-weight:500;
  max-width:360px;pointer-events:auto;animation:fadeIn .25s ease;line-height:1.45}
.toast.bullish{background:rgba(0,230,118,.12);color:#00e676;border:1px solid rgba(0,230,118,.25)}
.toast.bearish{background:rgba(255,68,68,.12);color:#ff5252;border:1px solid rgba(255,68,68,.25)}
.toast.info{background:rgba(255,0,127,.12);color:#ff69b4;border:1px solid rgba(255,0,127,.25)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}

/* Alertas sidebar */
.alerta-item{padding:6px 10px;border-radius:8px;font-size:10.5px;font-weight:500;line-height:1.4}
.alerta-item.bullish{background:rgba(0,230,118,.07);color:#00e676}
.alerta-item.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.alerta-item.info{background:rgba(255,0,127,.07);color:#ff69b4}

/* Favoritos grid */
.fav-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);
  border-radius:11px;padding:8px 10px;cursor:pointer;transition:all .15s;
  min-width:0;position:relative}
.fav-card:hover{background:rgba(255,255,255,.045);border-color:rgba(255,0,127,.25)}
.fav-card.active-sym{border-color:rgba(255,0,127,.6);background:rgba(255,0,127,.07)}
/* Estrella de watchlist */
.fav-star{position:absolute;top:6px;right:7px;font-size:11px;cursor:pointer;
  transition:all .15s;user-select:none;line-height:1}
.fav-star.watching{color:#ff007f;text-shadow:0 0 8px rgba(255,0,127,.5)}
.fav-star.not-watching{color:rgba(255,255,255,.15)}
.fav-star:hover{transform:scale(1.3)}
/* Badge de alerta en favorito */
.alert-badge{position:absolute;top:-4px;left:-4px;width:10px;height:10px;
  border-radius:50%;background:#ff007f;box-shadow:0 0 8px rgba(255,0,127,.7);
  animation:pulse 1.5s ease-in-out infinite;border:2px solid #07070f}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.7}}

/* AcordeÃ³n */
.acc-body{overflow:hidden;transition:max-height .35s ease,opacity .25s ease}
.acc-body.closed{max-height:0;opacity:0;pointer-events:none}
.acc-body.open{max-height:4000px;opacity:1}

/* Loading */
#loadWrap{display:none;align-items:center;justify-content:center;height:400px;
  flex-direction:column;gap:14px;color:rgba(255,255,255,.3)}
.spin{width:34px;height:34px;border:3px solid rgba(255,0,127,.15);
  border-top-color:#ff007f;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

input:focus{outline:none;border-color:rgba(255,0,127,.5)!important}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}
</style>
</head>
<body>
<div id="toasts"></div>

<div style="max-width:1600px;margin:0 auto;padding:16px 20px;display:flex;flex-direction:column;gap:14px">

  <!-- HEADER -->
  <header style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:34px;height:34px;border-radius:10px;background:#ff007f;
        box-shadow:0 0 18px rgba(255,0,127,.4);display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg width="16" height="16" fill="none" stroke="#fff" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
      </div>
      <span style="font-size:15px;font-weight:800;letter-spacing:-.3px">EXPANDE <span style="color:#ff007f">TU FUTURO</span></span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex:1;max-width:440px">
      <input id="symbolInput" type="text" placeholder="AAPL Â· BTC-USD Â· ^GSPC Â· SPY Â· VOOâ€¦"
        style="flex:1;background:#111;border:1px solid rgba(255,255,255,.1);border-radius:10px;
          padding:9px 14px;font-size:13px;color:#e0e0e0;font-family:'Inter',sans-serif;transition:all .2s"
        onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()" style="padding:9px 18px;border-radius:10px;background:#ff007f;
        color:#fff;font-size:13px;font-weight:700;border:none;cursor:pointer;white-space:nowrap;
        font-family:'Inter',sans-serif">Buscar</button>
    </div>
  </header>

  <!-- MAIN ROW -->
  <div style="display:flex;gap:14px;flex-wrap:wrap">

    <!-- SIDEBAR -->
    <div style="width:178px;flex-shrink:0;display:flex;flex-direction:column;gap:10px">

      <!-- Precio + RSI -->
      <div class="card" style="padding:15px">
        <div id="dispSym" style="font-size:10px;font-weight:800;letter-spacing:.12em;color:#ff007f;margin-bottom:3px">---</div>
        <div id="dispPrice" class="mono" style="font-size:21px;font-weight:700;line-height:1.15;color:#fff">---</div>
        <div id="dispChange" style="font-size:11px;margin-top:5px;font-weight:600">--</div>
        <div style="margin-top:11px;padding-top:11px;border-top:1px solid rgba(255,255,255,.05)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="font-size:10px;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:.08em">RSI 14</span>
            <div style="display:flex;align-items:center;gap:4px">
              <span id="rsiVal" class="mono" style="font-size:13px;font-weight:700">--</span>
              <span id="rsiLbl" style="font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;
                background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">--</span>
            </div>
          </div>
          <div id="rsiBar"><div id="rsiCursor"></div></div>
        </div>
      </div>

      <!-- Alertas del sÃ­mbolo actual -->
      <div id="alertBox" class="card" style="padding:12px;display:none">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;
          color:rgba(255,255,255,.2);font-weight:700;margin-bottom:7px">âš¡ Alertas activas</div>
        <div id="alertList" style="display:flex;flex-direction:column;gap:5px;max-height:220px;overflow-y:auto"></div>
      </div>

      <!-- Vigilancia -->
      <div class="card" style="padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
          <span style="font-size:11px;font-weight:600">ğŸ”” Vigilancia</span>
          <div style="display:flex;align-items:center;gap:5px">
            <span id="watchDot" style="width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);display:inline-block"></span>
            <span id="watchLabel" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.2)">--</span>
          </div>
        </div>
        <p style="font-size:10px;line-height:1.6;color:rgba(255,255,255,.18)">
          Marca â˜… en un ETF para aÃ±adirlo a vigilancia. Alerta cuando precio toca SMA o cruzan SMA100/200.
        </p>
        <div id="watchCount" style="font-size:10px;margin-top:6px;color:rgba(255,0,127,.6);font-weight:600"></div>
      </div>

    </div>

    <!-- CHART CARD -->
    <div class="card" style="flex:1;min-width:0;padding:16px;display:flex;flex-direction:column;gap:10px">

      <!-- Controles -->
      <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">

        <!-- PerÃ­odos -->
        <div style="display:flex;flex-direction:column;gap:5px">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
            color:rgba(255,255,255,.2);font-weight:700">PerÃ­odo</div>
          <div style="display:flex;gap:2px;background:rgba(255,255,255,.04);padding:3px;border-radius:10px">
            <button class="btn-p active" data-p="3mo" onclick="setPeriod('3mo')">3M</button>
            <button class="btn-p" data-p="6mo" onclick="setPeriod('6mo')">6M</button>
            <button class="btn-p" data-p="1y"  onclick="setPeriod('1y')">1A</button>
            <button class="btn-p" data-p="2y"  onclick="setPeriod('2y')">2A</button>
            <button class="btn-p" data-p="5y"  onclick="setPeriod('5y')">5A</button>
            <button class="btn-p" data-p="max" onclick="setPeriod('max')">MÃX</button>
          </div>
        </div>

        <!-- Indicadores toggle â€” todos en una fila -->
        <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
            color:rgba(255,255,255,.2);font-weight:700">Indicadores</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn-ind" id="tog-sma20"  onclick="toggleInd('sma20')"
              style="background:rgba(0,255,255,.1);color:#00ffff;border-color:rgba(0,255,255,.3)">SMA 20</button>
            <button class="btn-ind" id="tog-sma50"  onclick="toggleInd('sma50')"
              style="background:rgba(255,255,0,.1);color:#ffff00;border-color:rgba(255,255,0,.3)">SMA 50</button>
            <button class="btn-ind" id="tog-sma100" onclick="toggleInd('sma100')"
              style="background:rgba(255,200,100,.1);color:#ffc864;border-color:rgba(255,200,100,.3)">SMA 100</button>
            <button class="btn-ind" id="tog-sma200" onclick="toggleInd('sma200')"
              style="background:rgba(200,150,220,.1);color:#c896dc;border-color:rgba(200,150,220,.3)">SMA 200</button>
            <button class="btn-ind" id="tog-st"     onclick="toggleInd('st')"
              style="background:rgba(0,255,100,.1);color:#00e676;border-color:rgba(0,255,100,.3)">SuperT</button>
            <button class="btn-ind" id="tog-rsi"    onclick="toggleInd('rsi')"
              style="background:rgba(255,0,127,.1);color:#ff69b4;border-color:rgba(255,0,127,.3)">RSI</button>
          </div>
        </div>

      </div>

      <!-- Loading spinner -->
      <div id="loadWrap">
        <div class="spin"></div>
        <span style="font-size:13px">Cargando datosâ€¦</span>
      </div>

      <!-- GrÃ¡ficas -->
      <div id="chartArea" style="display:none;flex-direction:column">
        <div id="plotDiv"></div>
        <!-- RSI panel â€” solo si visible -->
        <div id="rsiWrap">
          <div style="padding:3px 65px 0 10px;display:flex;justify-content:space-between">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
              color:rgba(255,255,255,.18);font-weight:700">RSI 14 â€” seÃ±ales extremas</span>
            <span style="font-size:9px;color:rgba(255,255,255,.15)">
              <span style="color:rgba(0,230,118,.8)">â–² Sobreventa &lt;30</span>
              &nbsp;&nbsp;
              <span style="color:rgba(255,0,127,.8)">â–¼ Sobrecompra &gt;70</span>
            </span>
          </div>
          <div id="rsiDiv"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- FAVORITOS -->
  <div class="card" style="padding:14px">
    <button onclick="toggleFavs()" style="width:100%;display:flex;align-items:center;
      justify-content:space-between;background:transparent;border:none;cursor:pointer;
      color:inherit;font-family:'Inter',sans-serif">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:#ff007f;font-size:15px">â˜…</span>
        <span style="font-size:13px;font-weight:700">Todos los activos</span>
        <span id="favCount" style="font-size:10px;color:rgba(255,255,255,.25)"></span>
        <span id="watchingCount" style="font-size:10px;color:#ff007f;font-weight:700"></span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:10px;color:rgba(255,255,255,.2)">Haz clic en â˜… para aÃ±adir a vigilancia</span>
        <span id="favChevron" style="color:rgba(255,255,255,.3);font-size:11px;
          transition:transform .3s;display:inline-block;transform:rotate(-90deg)">â–¼</span>
      </div>
    </button>
    <div id="favBody" class="acc-body closed">
      <div id="favItems" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(108px,1fr));
        gap:8px;margin-top:12px"></div>
    </div>
  </div>

</div><!-- /wrapper -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATÃLOGO DE ACTIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_ASSETS = [
  // Cripto
  {name:'Bitcoin',    ticker:'BTC-USD', cat:'ğŸª™'},
  {name:'Ethereum',   ticker:'ETH-USD', cat:'ğŸª™'},
  // Ãndices
  {name:'S&P 500',    ticker:'^GSPC',   cat:'ğŸ“Š'},
  {name:'Nasdaq 100', ticker:'^NDX',    cat:'ğŸ“Š'},
  {name:'Dow Jones',  ticker:'^DJI',    cat:'ğŸ“Š'},
  {name:'Russell 2K', ticker:'^RUT',    cat:'ğŸ“Š'},
  // ETFs core
  {name:'SPY',   ticker:'SPY',  cat:'ETF'},
  {name:'VOO',   ticker:'VOO',  cat:'ETF'},
  {name:'VTI',   ticker:'VTI',  cat:'ETF'},
  {name:'QQQ',   ticker:'QQQ',  cat:'ETF'},
  {name:'QQQM',  ticker:'QQQM', cat:'ETF'},
  {name:'SPMO',  ticker:'SPMO', cat:'ETF'},
  {name:'JEPQ',  ticker:'JEPQ', cat:'ETF'},
  {name:'ITOT',  ticker:'ITOT', cat:'ETF'},
  // Dividendos / estilo
  {name:'SCHD',  ticker:'SCHD',  cat:'ETF'},
  {name:'SCHG',  ticker:'SCHG',  cat:'ETF'},
  {name:'VGT',   ticker:'VGT',   cat:'ETF'},
  {name:'VHT',   ticker:'VHT',   cat:'ETF'},
  {name:'VFH',   ticker:'VFH',   cat:'ETF'},
  {name:'VEA',   ticker:'VEA',   cat:'ETF'},
  {name:'VTV',   ticker:'VTV',   cat:'ETF'},
  {name:'VTWO',  ticker:'VTWO',  cat:'ETF'},
  {name:'IWM',   ticker:'IWM',   cat:'ETF'},
  // Sector
  {name:'XLE',   ticker:'XLE',   cat:'ETF'},
  {name:'SMH',   ticker:'SMH',   cat:'ETF'},
  {name:'RSP',   ticker:'RSP',   cat:'ETF'},
  {name:'EEM',   ticker:'EEM',   cat:'ETF'},
  {name:'ILF',   ticker:'ILF',   cat:'ETF'},
  {name:'DIA',   ticker:'DIA',   cat:'ETF'},
  {name:'IOO',   ticker:'IOO',   cat:'ETF'},
  {name:'SPYM',  ticker:'SPYM',  cat:'ETF'},
  {name:'FEPI',  ticker:'FEPI',  cat:'ETF'},
  // Materias primas
  {name:'GLD',   ticker:'GLD',   cat:'ğŸ¥‡'},
  {name:'IAU',   ticker:'IAU',   cat:'ğŸ¥‡'},
  {name:'GDX',   ticker:'GDX',   cat:'ğŸ¥‡'},
  {name:'UGL',   ticker:'UGL',   cat:'ğŸ¥‡'},
  {name:'COPX',  ticker:'COPX',  cat:'â›ï¸'},
  {name:'REMX',  ticker:'REMX',  cat:'â›ï¸'},
  {name:'URNM',  ticker:'URNM',  cat:'âš›ï¸'},
  {name:'URA',   ticker:'URA',   cat:'âš›ï¸'},
  // Acciones
  {name:'Apple', ticker:'AAPL',  cat:'ğŸ’¼'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSymbol  = 'BTC-USD';
let currentPeriod  = '3mo';
let favsOpen       = false;
let indVisible     = {sma20:true, sma50:true, sma100:true, sma200:true, st:true, rsi:true};
let lastData       = null;
let shownAlerts    = new Set();

// watchlist: Set de tickers en vigilancia (persistido en localStorage si disponible)
let watchlist = new Set();
// alertsByTicker: Map<ticker, alertas[]> â€” resultado del Ãºltimo scan
let alertsByTicker = {};

function saveWatchlist(){
  try { localStorage.setItem('etf_watchlist', JSON.stringify([...watchlist])); } catch(e){}
}
function loadWatchlist(){
  try {
    const s = localStorage.getItem('etf_watchlist');
    if (s) watchlist = new Set(JSON.parse(s));
  } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = () => {
  loadWatchlist();
  document.getElementById('favCount').innerText = `â€” ${ALL_ASSETS.length} activos`;
  buildFavGrid();
  updateWatchingCount();
  loadSymbol('BTC-USD');
  startWatcher();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRID DE ACTIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function favId(t){ return t.replace(/[^a-z0-9]/gi,'_'); }

function buildFavGrid(){
  const c = document.getElementById('favItems');
  c.innerHTML = '';
  ALL_ASSETS.forEach(f => {
    const id  = favId(f.ticker);
    const isW = watchlist.has(f.ticker);
    const div = document.createElement('div');
    div.className = 'fav-card';
    div.id = 'fav-'+id;
    div.onclick = (e) => {
      // Si clic en estrella, no abrir grÃ¡fico
      if (e.target.classList.contains('fav-star')) return;
      loadSymbol(f.ticker);
    };
    div.innerHTML = `
      <span class="fav-star ${isW?'watching':'not-watching'}"
        id="star-${id}" title="${isW?'Quitar de vigilancia':'AÃ±adir a vigilancia'}"
        onclick="toggleWatch('${f.ticker}',event)">â˜…</span>
      <div style="display:flex;flex-direction:column;gap:3px;padding-right:12px">
        <span style="font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;
          white-space:nowrap">${f.name}</span>
        <canvas id="spark-${id}" style="width:100%;height:26px;display:block"></canvas>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:9px;color:rgba(255,255,255,.2)">${f.cat} ${f.ticker}</span>
          <span id="pct-${id}" style="font-size:9px;font-weight:700;color:rgba(255,255,255,.25)">â€¦</span>
        </div>
      </div>`;
    c.appendChild(div);
  });
}

function toggleWatch(ticker, e){
  e.stopPropagation();
  const id  = favId(ticker);
  const star = document.getElementById('star-'+id);
  if (watchlist.has(ticker)){
    watchlist.delete(ticker);
    star.className = 'fav-star not-watching';
    star.title = 'AÃ±adir a vigilancia';
  } else {
    watchlist.add(ticker);
    star.className = 'fav-star watching';
    star.title = 'Quitar de vigilancia';
    showToast(`â­ ${ticker} aÃ±adido a vigilancia`, 'info', 3000);
  }
  saveWatchlist();
  updateWatchingCount();
}

function updateWatchingCount(){
  const n = watchlist.size;
  const el = document.getElementById('watchingCount');
  el.innerText = n > 0 ? `â€” ${n} en vigilancia` : '';
  document.getElementById('watchCount').innerText = n > 0 ? `${n} activo${n>1?'s':''} en vigilancia` : '';
}

function refreshStars(){
  ALL_ASSETS.forEach(f => {
    const star = document.getElementById('star-'+favId(f.ticker));
    if (!star) return;
    const isW = watchlist.has(f.ticker);
    star.className = 'fav-star '+(isW?'watching':'not-watching');
  });
}

// Badges de alerta sobre las tarjetas
function applyAlertBadges(){
  ALL_ASSETS.forEach(f => {
    const card = document.getElementById('fav-'+favId(f.ticker));
    if (!card) return;
    const existing = card.querySelector('.alert-badge');
    const hasAlert = alertsByTicker[f.ticker] && alertsByTicker[f.ticker].length > 0;
    if (hasAlert && !existing){
      const badge = document.createElement('span');
      badge.className = 'alert-badge';
      badge.title = alertsByTicker[f.ticker].map(a=>a.msg).join('\n');
      card.appendChild(badge);
    } else if (!hasAlert && existing){
      existing.remove();
    }
  });
}

async function loadSparkline(ticker){
  try {
    const r = await fetch(`/api/sparkline/${ticker}`);
    const d = await r.json();
    if (!d.closes || d.closes.length < 2) return;
    const id  = favId(ticker);
    const cvs = document.getElementById(`spark-${id}`);
    if (!cvs) return;
    const dpr = window.devicePixelRatio || 1;
    const W = cvs.offsetWidth || 100;
    const H = 26;
    cvs.width  = W * dpr;
    cvs.height = H * dpr;
    const ctx  = cvs.getContext('2d');
    ctx.scale(dpr, dpr);
    const mn = Math.min(...d.closes), mx = Math.max(...d.closes);
    const rng = mx - mn || 1;
    const up = d.pct >= 0;
    const col = up ? '#00e676' : '#ff4444';
    const pts = d.closes.map((v,i) => ({
      x: i / (d.closes.length-1) * W,
      y: H - 2 - (v-mn)/rng*(H-6)
    }));
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, up ? 'rgba(0,230,118,.2)' : 'rgba(255,68,68,.2)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.beginPath();
    pts.forEach((p,i)=> i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
    ctx.fillStyle = grad; ctx.fill();
    ctx.beginPath();
    pts.forEach((p,i)=> i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
    ctx.strokeStyle = col; ctx.lineWidth = 1.5; ctx.stroke();
    const pEl = document.getElementById(`pct-${id}`);
    if (pEl){ pEl.style.color = col; pEl.innerText = `${up?'+':''}${d.pct.toFixed(2)}%`; }
  } catch(e){}
}

function toggleFavs(){
  favsOpen = !favsOpen;
  const body    = document.getElementById('favBody');
  const chevron = document.getElementById('favChevron');
  body.classList.toggle('open',    favsOpen);
  body.classList.toggle('closed', !favsOpen);
  chevron.style.transform = favsOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
  if (favsOpen) setTimeout(() => ALL_ASSETS.forEach(f => loadSparkline(f.ticker)), 60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIGILANCIA â€” solo tickers en watchlist
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWatcher(){ checkWatchlist(); setInterval(checkWatchlist, 5*60*1000); }

async function checkWatchlist(){
  if (watchlist.size === 0){ setWatchStatus('idle'); return; }
  const tickers = [...watchlist].join(',');
  try {
    const r = await fetch(`/api/watch?tickers=${encodeURIComponent(tickers)}`);
    const d = await r.json();
    // Agrupar alertas por ticker
    alertsByTicker = {};
    (d.alertas||[]).forEach(a => {
      // El msg tiene formato "[TICKER] mensaje"
      const m = a.msg.match(/^\[([^\]]+)\]/);
      const t = m ? m[1] : 'unknown';
      if (!alertsByTicker[t]) alertsByTicker[t] = [];
      alertsByTicker[t].push(a);
    });
    setWatchStatus(d.alertas && d.alertas.length ? 'alert' : 'ok');
    applyAlertBadges();
    // Toasts solo para nuevas alertas
    (d.alertas||[]).forEach(a => {
      if (!shownAlerts.has(a.msg)){
        shownAlerts.add(a.msg);
        showToast(a.msg, a.nivel);
        setTimeout(()=>shownAlerts.delete(a.msg), 2*3600*1000);
      }
    });
    // Si el sÃ­mbolo actual estÃ¡ en vigilancia, actualizar panel alertas
    if (watchlist.has(currentSymbol)){
      renderAlertas(alertsByTicker[currentSymbol]||[]);
    }
  } catch(e){ setWatchStatus('err'); }
}

function setWatchStatus(s){
  const dot=document.getElementById('watchDot'), lbl=document.getElementById('watchLabel');
  const m={ok:['#00e676','Activa'],alert:['#ff007f','Â¡Alerta!'],err:['#555','Error'],idle:['rgba(255,255,255,.15)','En espera']};
  const [c,t]=m[s]||m.ok;
  dot.style.background=c; lbl.style.color=c; lbl.innerText=t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH CHART DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchData(sym, period){
  const MAP={
    '3mo':['1d','3mo'],'6mo':['1d','6mo'],'1y':['1d','1y'],
    '2y':['1d','2y'],'5y':['1wk','5y'],'max':['1wk','max']
  };
  const [interval]=MAP[period]||['1d','3mo'];
  const r = await fetch(`/api/chart/${encodeURIComponent(sym)}?interval=${interval}`);
  const d = await r.json();
  if (d.error) throw new Error(d.error);
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTLY â€” grÃ¡fico de Ã¡rea lÃ­nea blanca
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BG = '#07070f';

function renderPlotly(apiData){
  const cd     = apiData.chart;
  const dates  = cd.candles.map(c => new Date(c.x));
  const closes = cd.candles.map(c => c.c);
  const lastClose = closes[closes.length-1] || 1;

  // Formato de eje Y segÃºn precio
  const yFmt = lastClose > 500 ? ',.0f' : lastClose > 1 ? ',.2f' : ',.4f';

  const traces = [];

  // â”€â”€ 1. PRECIO â€” lÃ­nea blanca + relleno blanco suave â”€â”€
  traces.push({
    x: dates, y: closes,
    type:'scatter', mode:'lines', name:'Precio',
    line:{ color:'rgba(255,255,255,.95)', width:2, shape:'linear' },
    fill:'tozeroy',
    fillcolor:'rgba(255,255,255,0.07)',
    hovertemplate:'<b>%{x|%d %b %Y}</b><br><b style="color:#fff">$%{y:,.2f}</b><extra></extra>',
  });

  // Helper
  const xy = arr => ({ xs:arr.map(p=>new Date(p.x)), ys:arr.map(p=>p.y) });

  // â”€â”€ 2. SMAs â”€â”€
  const smasCfg = [
    {key:'sma20',  data:cd.sma20,  col:'rgba(0,255,255,.85)',   w:1.2, name:'SMA 20'},
    {key:'sma50',  data:cd.sma50,  col:'rgba(255,255,0,.85)',   w:1.5, name:'SMA 50'},
    {key:'sma100', data:cd.sma100, col:'rgba(255,200,100,.85)', w:1.8, name:'SMA 100'},
    {key:'sma200', data:cd.sma200, col:'rgba(200,150,220,.9)',  w:2.2, name:'SMA 200'},
  ];
  smasCfg.forEach(s => {
    if (!indVisible[s.key]) return;
    const {xs,ys} = xy(s.data);
    traces.push({
      x:xs, y:ys, type:'scatter', mode:'lines', name:s.name,
      line:{color:s.col, width:s.w},
      hovertemplate:`<b>${s.name}</b>: $%{y:,.2f}<extra></extra>`
    });
  });

  // â”€â”€ 3. SUPERTREND â€” puntos pequeÃ±os â”€â”€
  if (indVisible.st){
    const stB = xy(cd.st_buy), stS = xy(cd.st_sell);
    if (stB.xs.length){
      traces.push({
        x:stB.xs, y:stB.ys, type:'scatter', mode:'markers', name:'ST â–²',
        marker:{color:'rgba(0,255,100,.9)', size:3.5, symbol:'circle'},
        hovertemplate:'ST â–²: $%{y:,.2f}<extra></extra>'
      });
    }
    if (stS.xs.length){
      traces.push({
        x:stS.xs, y:stS.ys, type:'scatter', mode:'markers', name:'ST â–¼',
        marker:{color:'rgba(255,50,50,.9)', size:3.5, symbol:'circle'},
        hovertemplate:'ST â–¼: $%{y:,.2f}<extra></extra>'
      });
    }
  }

  // â”€â”€ 4. RSI seÃ±ales sobre el precio â”€â”€
  if (indVisible.rsi){
    const ros = xy(cd.rsi_os), rob = xy(cd.rsi_ob);
    if (ros.xs.length){
      traces.push({
        x:ros.xs, y:ros.ys, type:'scatter', mode:'markers', name:'RSI <30 â–²',
        marker:{color:'#00e676', size:10, symbol:'triangle-up', line:{color:'#07070f',width:1.5}},
        hovertemplate:'ğŸŸ¢ Sobreventa RSI<br>$%{y:,.2f}<extra></extra>'
      });
    }
    if (rob.xs.length){
      traces.push({
        x:rob.xs, y:rob.ys, type:'scatter', mode:'markers', name:'RSI >70 â–¼',
        marker:{color:'#ff007f', size:10, symbol:'triangle-down', line:{color:'#07070f',width:1.5}},
        hovertemplate:'ğŸ”´ Sobrecompra RSI<br>$%{y:,.2f}<extra></extra>'
      });
    }
  }

  const layout = {
    paper_bgcolor:BG, plot_bgcolor:BG,
    margin:{t:10, r:65, b:10, l:10},
    hovermode:'x unified',
    hoverlabel:{
      bgcolor:'rgba(10,10,22,.95)', bordercolor:'rgba(255,255,255,.1)',
      font:{family:'JetBrains Mono,monospace', size:12, color:'#e0e0e0'}
    },
    showlegend:false,
    xaxis:{
      type:'date',
      gridcolor:'rgba(255,255,255,.04)', linecolor:'rgba(255,255,255,.08)',
      tickcolor:'rgba(255,255,255,.08)', tickfont:{color:'rgba(255,255,255,.3)', size:10},
      showspikes:true, spikecolor:'rgba(255,255,255,.12)', spikedash:'dot', spikethickness:1,
      rangeslider:{visible:false}
    },
    yaxis:{
      gridcolor:'rgba(255,255,255,.04)', linecolor:'rgba(255,255,255,.08)',
      tickfont:{color:'rgba(255,255,255,.3)', size:10},
      side:'right', tickformat:yFmt
    },
    dragmode:'pan',
    font:{family:'Inter,sans-serif'}
  };

  Plotly.react('plotDiv', traces, layout,
    {responsive:true, scrollZoom:true, displayModeBar:false, doubleClick:'reset'});

  // â”€â”€ 5. Panel RSI â”€â”€
  const rsiWrap = document.getElementById('rsiWrap');
  if (indVisible.rsi){
    rsiWrap.style.display = 'block';
    renderRSIPanel(cd, dates);
  } else {
    rsiWrap.style.display = 'none';
  }
}

function renderRSIPanel(cd, dates){
  const d0 = dates[0]||new Date(), dN = dates[dates.length-1]||new Date();
  const ros = cd.rsi_os.map(p=>new Date(p.x));
  const rob = cd.rsi_ob.map(p=>new Date(p.x));

  const rsiTraces = [
    {x:[d0,dN],y:[30,30],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',
     line:{color:'rgba(0,230,118,.3)',width:1,dash:'dot'}},
    {x:[d0,dN],y:[70,70],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',
     line:{color:'rgba(255,0,127,.3)',width:1,dash:'dot'}},
    {x:ros, y:ros.map(()=>20), type:'scatter', mode:'markers', name:'SV',
     marker:{color:'#00e676',size:7,symbol:'triangle-up',line:{color:'#07070f',width:1}},
     hovertemplate:'ğŸŸ¢ Sobreventa<extra></extra>'},
    {x:rob, y:rob.map(()=>80), type:'scatter', mode:'markers', name:'SC',
     marker:{color:'#ff007f',size:7,symbol:'triangle-down',line:{color:'#07070f',width:1}},
     hovertemplate:'ğŸ”´ Sobrecompra<extra></extra>'},
  ];

  const rsiLayout = {
    paper_bgcolor:BG, plot_bgcolor:'rgba(255,255,255,.012)',
    margin:{t:4,r:65,b:28,l:10},
    showlegend:false,
    xaxis:{type:'date',gridcolor:'rgba(255,255,255,.03)',linecolor:'rgba(255,255,255,.06)',
      tickfont:{color:'rgba(255,255,255,.22)',size:9},rangeslider:{visible:false}},
    yaxis:{range:[0,100],gridcolor:'rgba(255,255,255,.03)',
      tickfont:{color:'rgba(255,255,255,.22)',size:9},side:'right',tickvals:[30,50,70]},
    shapes:[
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:0, y1:30, fillcolor:'rgba(0,230,118,.04)',line:{width:0}},
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:70,y1:100,fillcolor:'rgba(255,0,127,.04)',line:{width:0}}
    ],
    font:{family:'Inter,sans-serif'}, dragmode:'pan'
  };

  Plotly.react('rsiDiv', rsiTraces, rsiLayout,
    {responsive:true, scrollZoom:false, displayModeBar:false});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleInd(key){
  indVisible[key] = !indVisible[key];
  const btn = document.getElementById('tog-'+key);
  btn.classList.toggle('off', !indVisible[key]);
  if (lastData) renderPlotly(lastData);
}

function setPeriod(p){
  currentPeriod = p;
  document.querySelectorAll('.btn-p').forEach(b=>b.classList.toggle('active', b.dataset.p===p));
  loadSymbol(currentSymbol);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSymbol(sym){
  currentSymbol = sym;
  document.getElementById('symbolInput').value = sym;
  document.querySelectorAll('.fav-card').forEach(c=>c.classList.remove('active-sym'));
  const el = document.getElementById('fav-'+favId(sym));
  if (el) el.classList.add('active-sym');

  document.getElementById('loadWrap').style.display = 'flex';
  document.getElementById('chartArea').style.display = 'none';

  try {
    const data = await fetchData(sym, currentPeriod);
    lastData = data;
    document.getElementById('loadWrap').style.display = 'none';
    document.getElementById('chartArea').style.display = 'flex';
    renderPlotly(data);
    updateSidebar(data);
    // Mostrar alertas si el sÃ­mbolo estÃ¡ en watchlist
    if (watchlist.has(sym) && alertsByTicker[sym]){
      renderAlertas(alertsByTicker[sym]);
    } else {
      renderAlertas(data.alertas||[]);
    }
  } catch(e){
    document.getElementById('loadWrap').style.display = 'none';
    document.getElementById('chartArea').style.display = 'flex';
    showToast('âŒ '+e.message, 'bearish');
  }
}

function doSearch(){
  const s = document.getElementById('symbolInput').value.trim().toUpperCase();
  if (s) loadSymbol(s);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR ACTUALIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSidebar(data){
  document.getElementById('dispSym').innerText = currentSymbol;
  document.getElementById('dispPrice').innerText =
    data.last_price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const chEl = document.getElementById('dispChange');
  const pre  = data.change >= 0 ? '+' : '';
  chEl.innerText   = `${pre}${data.change.toFixed(2)} (${pre}${data.change_pct.toFixed(2)}%)`;
  chEl.style.color = data.change >= 0 ? '#00e676' : '#ff4444';
  updateRSI(data.rsi_current);
}

function updateRSI(v){
  v = parseFloat(v); if (isNaN(v)) return;
  document.getElementById('rsiVal').innerText = v.toFixed(1);
  document.getElementById('rsiCursor').style.left = `calc(${Math.min(Math.max(v,0),100)}% - 5px)`;
  const lbl = document.getElementById('rsiLbl'), val = document.getElementById('rsiVal');
  if (v < 30){
    lbl.innerText='SV'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(0,230,118,.12);color:#00e676;font-weight:700';
    val.style.color='#00e676';
  } else if (v > 70){
    lbl.innerText='SC'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,68,68,.12);color:#ff5252;font-weight:700';
    val.style.color='#ff5252';
  } else {
    lbl.innerText='N'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);font-weight:700';
    val.style.color='#fff';
  }
}

function renderAlertas(alertas){
  const box=document.getElementById('alertBox'), list=document.getElementById('alertList');
  if (!alertas || !alertas.length){ box.style.display='none'; return; }
  box.style.display = 'block';
  list.innerHTML = alertas.map(a=>`<div class="alerta-item ${a.nivel}">${a.msg}</div>`).join('');
}

function showToast(msg, nivel, ms=7000){
  const c=document.getElementById('toasts');
  const t=document.createElement('div');
  t.className=`toast ${nivel}`; t.innerText=msg;
  c.appendChild(t); setTimeout(()=>t.remove(), ms);
}
</script>
</body>
</html>
