<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Expande Tu Futuro</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{-webkit-text-size-adjust:100%}
body{font-family:'Inter',sans-serif;background:#07070f;color:#e0e0e0;
  min-height:100vh;overflow-x:hidden;width:100%}
.mono{font-family:'JetBrains Mono',monospace}
.card{background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.07);border-radius:14px}

/* ‚îÄ‚îÄ WRAPPER ‚îÄ‚îÄ */
#app{width:100%;max-width:1600px;margin:0 auto;
  padding:10px 12px;display:flex;flex-direction:column;gap:10px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
#hdr{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
#hdr-logo{width:30px;height:30px;border-radius:9px;background:#ff007f;
  box-shadow:0 0 14px rgba(255,0,127,.4);display:flex;align-items:center;
  justify-content:center;flex-shrink:0}
#hdr-title{font-size:14px;font-weight:800;letter-spacing:-.2px;white-space:nowrap}
#hdr-search{display:flex;align-items:center;gap:6px;flex:1;min-width:0}
#symbolInput{flex:1;min-width:0;background:#111;border:1px solid rgba(255,255,255,.1);
  border-radius:9px;padding:8px 12px;font-size:13px;color:#e0e0e0;
  font-family:'Inter',sans-serif;transition:border-color .2s;width:100%}
#symbolInput:focus{outline:none;border-color:rgba(255,0,127,.5)}
#btnSearch{padding:8px 14px;border-radius:9px;background:#ff007f;color:#fff;
  font-size:13px;font-weight:700;border:none;cursor:pointer;
  font-family:'Inter',sans-serif;white-space:nowrap;flex-shrink:0}

/* ‚îÄ‚îÄ MAIN LAYOUT: mobile=col, desktop=row ‚îÄ‚îÄ */
#main{display:flex;flex-direction:column;gap:10px;width:100%}
@media(min-width:900px){
  #main{display:grid;grid-template-columns:170px 1fr;align-items:flex-start}
  #sidebar{width:170px}
  #chart-card{width:100%;min-width:0}
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar{display:flex;flex-direction:column;gap:8px;width:100%}

/* Precio widget */
#price-widget{padding:10px}
#dispSym{font-size:9px;font-weight:800;letter-spacing:.1em;color:#ff007f;margin-bottom:1px}
#dispPrice{font-size:18px;font-weight:700;line-height:1.1;color:#fff}
#dispChange{font-size:10px;margin-top:2px;font-weight:600}
#rsiRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
#rsiBar{height:5px;border-radius:3px;position:relative;margin-top:5px;
  background:linear-gradient(to right,
    rgba(0,230,118,.4) 0%,rgba(0,230,118,.4) 30%,
    rgba(255,255,255,.06) 30%,rgba(255,255,255,.06) 70%,
    rgba(255,68,68,.4) 70%,rgba(255,68,68,.4) 100%)}
#rsiCursor{position:absolute;top:50%;width:10px;height:10px;border-radius:50%;
  background:#fff;box-shadow:0 0 5px rgba(255,255,255,.5);
  transform:translate(-50%,-50%);transition:left .4s;left:50%}

/* Vigilancia panel */
#watch-panel{padding:11px}
#watch-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
#watchDot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);
  display:inline-block;flex-shrink:0}
#watch-alerts-list{display:flex;flex-direction:column;gap:5px;
  max-height:260px;overflow-y:auto}
.w-alerta{padding:6px 9px;border-radius:8px;font-size:10px;font-weight:500;line-height:1.45;
  cursor:pointer;transition:filter .15s}
.w-alerta:hover{filter:brightness(1.3)}
.w-alerta .w-ticker{font-weight:800;font-size:10px;margin-right:4px}
.w-alerta.bullish{background:rgba(0,230,118,.07);color:#00e676}
.w-alerta.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.w-alerta.info{background:rgba(255,0,127,.07);color:#ff69b4}

/* Alertas s√≠mbolo activo */
#alertBox{padding:11px;display:none}
.alerta-item{padding:5px 9px;border-radius:7px;font-size:10px;font-weight:500;line-height:1.4}
.alerta-item.bullish{background:rgba(0,230,118,.07);color:#00e676}
.alerta-item.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.alerta-item.info{background:rgba(255,0,127,.07);color:#ff69b4}

/* ‚îÄ‚îÄ CHART CARD ‚îÄ‚îÄ */
#chart-card{padding:13px;display:flex;flex-direction:column;gap:9px;width:100%}
#chartArea{width:100%;margin:0 auto}

/* Controles barra: indicadores */
#ind-bar{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.btn-ind{padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;
  transition:all .15s;border:1px solid transparent;font-family:'Inter',sans-serif;
  white-space:nowrap}
.btn-ind.off{opacity:.25;filter:grayscale(.7)}

/* Chart containers ‚Äî altura din√°mica */
#plotDiv{width:100%;height:min(120vw,600px)}
#rsiWrap{display:block}
#rsiDiv{width:100%;height:min(30vw,150px)}
@media(min-width:900px){
  #plotDiv{height:750px}
  #rsiDiv{height:180px}
}

/* Loading ‚Äî overlay sobre el gr√°fico */
#loadWrap{display:none;position:absolute;inset:0;align-items:center;justify-content:center;
  flex-direction:column;gap:12px;color:rgba(255,255,255,.3);
  background:rgba(7,7,15,.75);z-index:10;border-radius:14px}
.spin{width:32px;height:32px;border:3px solid rgba(255,0,127,.15);
  border-top-color:#ff007f;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ FAVORITOS PANEL ‚îÄ‚îÄ */
#favs-panel{padding:12px}
#favs-hdr{display:flex;align-items:center;justify-content:space-between;cursor:pointer;
  user-select:none;background:none;border:none;width:100%;color:inherit;
  font-family:'Inter',sans-serif;padding:0}
.acc-body{overflow:hidden;transition:max-height .35s ease,opacity .25s ease}
.acc-body.closed{max-height:0!important;opacity:0;pointer-events:none}
.acc-body.open{max-height:5000px;opacity:1}
#favItems{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:10px;margin-top:12px}
	
	/* Scanner Table */
	.scanner-row {
	  border-bottom: 1px solid rgba(255,255,255,0.05);
	  transition: background 0.2s;
	  cursor: pointer;
	}
	.scanner-row:hover {
	  background: rgba(255,255,255,0.03);
	}
	.scanner-row.active-sym {
	  background: rgba(255,0,127,0.05);
	  border-left: 2px solid #ff007f;
	}
	.sma-tag {
	  padding: 1px 4px;
	  border-radius: 3px;
	  color: #fff;
	}
	.signal-tag {
	  padding: 2px 6px;
	  border-radius: 4px;
	  font-size: 9px;
	  font-weight: 800;
	}
	.signal-optimo { background: rgba(0,230,118,0.2); color: #00e676; }
	.signal-interesante { background: rgba(255,200,100,0.2); color: #ffc864; }
	.signal-evitar { background: rgba(255,68,68,0.2); color: #ff5252; }
.fav-star{position:absolute;top:5px;right:6px;font-size:11px;cursor:pointer;
  user-select:none;transition:transform .15s;line-height:1;z-index:2}
.fav-star.watching{color:#ff007f;text-shadow:0 0 8px rgba(255,0,127,.6)}
.fav-star.idle{color:rgba(255,255,255,.14)}
.fav-star:hover{transform:scale(1.4)}
.alert-badge{position:absolute;top:-3px;left:-3px;width:9px;height:9px;
  border-radius:50%;background:#ff007f;box-shadow:0 0 7px rgba(255,0,127,.8);
  animation:pulse 1.5s ease-in-out infinite;border:2px solid #07070f;z-index:3}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.35)}}

/* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
#toasts{position:fixed;top:12px;right:12px;z-index:9999;
  display:flex;flex-direction:column;gap:7px;pointer-events:none;max-width:calc(100vw - 24px)}
.toast{padding:9px 14px;border-radius:10px;font-size:12px;font-weight:500;
  pointer-events:auto;animation:fadeIn .25s ease;line-height:1.45;word-break:break-word}
.toast.bullish{background:rgba(0,230,118,.13);color:#00e676;border:1px solid rgba(0,230,118,.25)}
.toast.bearish{background:rgba(255,68,68,.13);color:#ff5252;border:1px solid rgba(255,68,68,.25)}
.toast.info{background:rgba(255,0,127,.13);color:#ff69b4;border:1px solid rgba(255,0,127,.25)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}

::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
</style>
</head>
<body>
<div id="app">

  <!-- HEADER -->
  <div id="hdr">
    <div id="hdr-logo">
      <svg width="15" height="15" fill="none" stroke="#fff" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
              d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
      </svg>
    </div>
    <span id="hdr-title">EXPANDE <span style="color:#ff007f">TU FUTURO</span></span>
    <div id="hdr-search">
      <input id="symbolInput" type="text" placeholder="AAPL ¬∑ BTC-USD ¬∑ ^GSPC ¬∑ SPY‚Ä¶"
             autocomplete="off" autocorrect="off" autocapitalize="off"
             onkeydown="if(event.key==='Enter')doSearch()">
      <button id="btnSearch" onclick="doSearch()">Buscar</button>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">

    <!-- SIDEBAR -->
    <div id="sidebar">

      <!-- Precio + RSI -->
      <div class="card" id="price-widget">
        <div id="dispSym">---</div>
        <div id="dispPrice" class="mono">---</div>
        <div id="dispChange">--</div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.05)">
          <div id="rsiRow">
            <span style="font-size:10px;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:.08em">RSI 14</span>
            <div style="display:flex;align-items:center;gap:4px">
              <span id="rsiVal" class="mono" style="font-size:13px;font-weight:700">--</span>
              <span id="rsiLbl" style="font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;
                background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">--</span>
            </div>
          </div>
          <div id="rsiBar"><div id="rsiCursor"></div></div>
        </div>
      </div>

      <!-- Alertas s√≠mbolo activo -->
      <div id="alertBox" class="card">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;
          color:rgba(255,255,255,.2);font-weight:700;margin-bottom:6px">‚ö° Alertas ‚Äî <span id="alertSymLabel" style="color:#ff007f"></span></div>
        <div id="alertList" style="display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto"></div>
      </div>

      <!-- VIGILANCIA -->
      <div class="card" id="watch-panel">
        <div id="watch-hdr">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:11px;font-weight:700">üîî Vigilancia</span>
            <span id="watchDot"></span>
          </div>
          <span id="watchLabel" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.2)">--</span>
        </div>
        <!-- Info cuando no hay watchlist -->
        <div id="watchEmpty" style="font-size:10px;line-height:1.6;color:rgba(255,255,255,.2)">
          Marca ‚òÖ en cualquier activo para a√±adirlo. Alertas cuando precio toca SMA o cruzan SMA100/SMA200.
        </div>
        <!-- Lista de alertas semanales por ticker -->
        <div id="watch-alerts-list"></div>
        <div id="watchCount" style="font-size:10px;margin-top:6px;color:rgba(255,0,127,.5);font-weight:600"></div>
      </div>

    </div><!-- /sidebar -->

    <!-- CHART CARD -->
    <div class="card" id="chart-card" style="position:relative">

      <!-- Barra de indicadores -->
      <div id="ind-bar">
        <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
          color:rgba(255,255,255,.18);font-weight:700;margin-right:2px">Ind:</span>
        <button class="btn-ind" id="tog-sma20"
          style="background:rgba(0,255,255,.1);color:#00ffff;border-color:rgba(0,255,255,.3)"
          onclick="toggleInd('sma20')">SMA20</button>
        <button class="btn-ind" id="tog-sma50"
          style="background:rgba(255,255,0,.1);color:#ffff00;border-color:rgba(255,255,0,.3)"
          onclick="toggleInd('sma50')">SMA50</button>
        <button class="btn-ind" id="tog-sma100"
          style="background:rgba(255,200,100,.1);color:#ffc864;border-color:rgba(255,200,100,.3)"
          onclick="toggleInd('sma100')">SMA100</button>
        <button class="btn-ind" id="tog-sma200"
          style="background:rgba(200,150,220,.1);color:#c896dc;border-color:rgba(200,150,220,.3)"
          onclick="toggleInd('sma200')">SMA200</button>
        <button class="btn-ind off" id="tog-st"
          style="background:rgba(0,255,100,.1);color:#00e676;border-color:rgba(0,255,100,.3)"
          onclick="toggleInd('st')">SuperT</button>
        <button class="btn-ind off" id="tog-rsi"
          style="background:rgba(255,0,127,.1);color:#ff69b4;border-color:rgba(255,0,127,.3)"
          onclick="toggleInd('rsi')">RSI</button>
        <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
          <button class="btn-ind" onclick="zoomChart(1.2)" style="background:rgba(255,255,255,.05);color:#fff;padding:4px 10px;font-size:14px">+</button>
          <button class="btn-ind" onclick="zoomChart(0.8)" style="background:rgba(255,255,255,.05);color:#fff;padding:4px 10px;font-size:14px">-</button>
          <span style="font-size:9px;color:rgba(255,255,255,.2);white-space:nowrap;margin-left:4px">
            Doble clic reset
          </span>
        </div>
      </div>

      <!-- Loading -->
      <div id="loadWrap" style="display:none">
        <div class="spin"></div>
        <span style="font-size:12px">Cargando‚Ä¶</span>
      </div>

      <!-- Gr√°ficas -->
      <div id="chartArea" style="display:flex;flex-direction:column">
        <div id="plotDiv"></div>
        <div id="rsiWrap">
          <div style="padding:3px 60px 1px 8px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
              color:rgba(255,255,255,.18);font-weight:700">RSI se√±ales extremas</span>
            <span style="font-size:9px;color:rgba(255,255,255,.2)">
              <span style="color:rgba(0,230,118,.8)">‚ñ≤&lt;30</span>
              &nbsp;
              <span style="color:rgba(255,0,127,.8)">‚ñº&gt;70</span>
            </span>
          </div>
          <div id="rsiDiv"></div>
        </div>
      </div>

    </div><!-- /chart-card -->

  </div><!-- /main -->

  <!-- FAVORITOS / TODOS LOS ACTIVOS -->
  <div class="card" id="favs-panel">
    <button id="favs-hdr" onclick="toggleFavs()">
      <div style="display:flex;align-items:center;gap:7px">
        <span style="color:#ff007f;font-size:14px">‚òÖ</span>
        <span style="font-size:13px;font-weight:700">Todos los activos</span>
        <span id="favCount" style="font-size:10px;color:rgba(255,255,255,.25)"></span>
        <span id="watchingCount" style="font-size:10px;color:#ff007f;font-weight:700"></span>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:10px;color:rgba(255,255,255,.18)">‚òÖ = a√±adir vigilancia</span>
        <span id="favChevron" style="color:rgba(255,255,255,.3);font-size:11px;
          transition:transform .3s;display:inline-block;transform:rotate(-90deg)">‚ñº</span>
      </div>
    </button>
    <div id="favBody" class="acc-body closed">
      <div style="overflow-x:auto; margin-top:12px;">
        <table id="scannerTable" style="width:100%; border-collapse:collapse; font-size:11px; color:#e0e0e0;">
          <thead>
            <tr style="border-bottom:1px solid rgba(255,255,255,0.1); text-align:left; color:rgba(255,255,255,0.4); text-transform:uppercase; letter-spacing:0.05em;">
              <th style="padding:8px 10px;">Activo</th>
              <th style="padding:8px 10px;">Precio</th>
              <th style="padding:8px 10px;">Cambio %</th>
              <th style="padding:8px 10px;">RSI (14)</th>
              <th style="padding:8px 10px;">SMAs (20/50/100/200)</th>
              <th style="padding:8px 10px;">Cruce 100/200</th>
              <th style="padding:8px 10px;">Se√±al</th>
              <th style="padding:8px 10px; text-align:right;">Tendencia</th>
            </tr>
          </thead>
          <tbody id="favItems"></tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /app -->
<div id="toasts"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAT√ÅLOGO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALL_ASSETS = [
  {name:'Bitcoin',    ticker:'BTC-USD',cat:'ü™ô'},
  {name:'Ethereum',   ticker:'ETH-USD',cat:'ü™ô'},
  {name:'S&P 500',    ticker:'^GSPC',  cat:'üìä'},
  {name:'Nasdaq 100', ticker:'^NDX',   cat:'üìä'},
  {name:'Dow Jones',  ticker:'^DJI',   cat:'üìä'},
  {name:'Russell 2K', ticker:'^RUT',   cat:'üìä'},
  {name:'SPY',   ticker:'SPY',  cat:'ETF'},
  {name:'VOO',   ticker:'VOO',  cat:'ETF'},
  {name:'VTI',   ticker:'VTI',  cat:'ETF'},
  {name:'QQQ',   ticker:'QQQ',  cat:'ETF'},
  {name:'QQQM',  ticker:'QQQM', cat:'ETF'},
  {name:'SPMO',  ticker:'SPMO', cat:'ETF'},
  {name:'JEPQ',  ticker:'JEPQ', cat:'ETF'},
  {name:'ITOT',  ticker:'ITOT', cat:'ETF'},
  {name:'SCHD',  ticker:'SCHD', cat:'ETF'},
  {name:'SCHG',  ticker:'SCHG', cat:'ETF'},
  {name:'VGT',   ticker:'VGT',  cat:'ETF'},
  {name:'VHT',   ticker:'VHT',  cat:'ETF'},
  {name:'VFH',   ticker:'VFH',  cat:'ETF'},
  {name:'VEA',   ticker:'VEA',  cat:'ETF'},
  {name:'VTV',   ticker:'VTV',  cat:'ETF'},
  {name:'VTWO',  ticker:'VTWO', cat:'ETF'},
  {name:'IWM',   ticker:'IWM',  cat:'ETF'},
  {name:'XLE',   ticker:'XLE',  cat:'ETF'},
  {name:'SMH',   ticker:'SMH',  cat:'ETF'},
  {name:'RSP',   ticker:'RSP',  cat:'ETF'},
  {name:'EEM',   ticker:'EEM',  cat:'ETF'},
  {name:'ILF',   ticker:'ILF',  cat:'ETF'},
  {name:'DIA',   ticker:'DIA',  cat:'ETF'},
  {name:'IOO',   ticker:'IOO',  cat:'ETF'},
  {name:'SPYM',  ticker:'SPYM', cat:'ETF'},
  {name:'FEPI',  ticker:'FEPI', cat:'ETF'},
  {name:'GLD',   ticker:'GLD',  cat:'ü•á'},
  {name:'IAU',   ticker:'IAU',  cat:'ü•á'},
  {name:'GDX',   ticker:'GDX',  cat:'ü•á'},
  {name:'UGL',   ticker:'UGL',  cat:'ü•á'},
  {name:'COPX',  ticker:'COPX', cat:'‚õèÔ∏è'},
  {name:'REMX',  ticker:'REMX', cat:'‚õèÔ∏è'},
  {name:'URNM',  ticker:'URNM', cat:'‚öõÔ∏è'},
  {name:'URA',   ticker:'URA',  cat:'‚öõÔ∏è'},
  {name:'Apple', ticker:'AAPL', cat:'üíº'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSymbol = 'BTC-USD';
let favsOpen      = false;
let indVisible    = {sma20:true,sma50:true,sma100:true,sma200:true,st:false,rsi:false};
let lastData      = null;
let watchlist     = new Set();
let alertsByTicker = {};   // { ticker: [{msg,nivel,ts},...] } ‚Äî √∫ltimos 7 d√≠as
let shownToasts   = new Set();

function saveWL(){ try{localStorage.setItem('etf_wl',JSON.stringify([...watchlist]))}catch(e){} }
function loadWL(){ try{const s=localStorage.getItem('etf_wl');if(s)watchlist=new Set(JSON.parse(s))}catch(e){} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	window.onload = () => {
	  loadWL();
    try {
      const savedAlerts = localStorage.getItem('etf_alerts');
      if(savedAlerts) alertsByTicker = JSON.parse(savedAlerts);
    } catch(e) {}
	  document.getElementById('favCount').innerText = `‚Äî ${ALL_ASSETS.length} activos`;
	  buildFavGrid();
	  updateWatchingCount();
	  loadSymbol('BTC-USD');
	  startWatcher();
	};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRID DE ACTIVOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function favId(t){ return 'f_'+t.replace(/[^a-z0-9]/gi,'_'); }

	function buildFavGrid(){
	  const c = document.getElementById('favItems');
	  c.innerHTML = '';
	  ALL_ASSETS.forEach(f => {
	    const id  = favId(f.ticker);
	    const isW = watchlist.has(f.ticker);
	    const tr = document.createElement('tr');
	    tr.className = 'scanner-row';
	    tr.id = 'fc-'+id;
	    tr.onclick = e => { if(e.target.closest('.fav-star'))return; loadSymbol(f.ticker); };
	    tr.innerHTML = `
        <td style="padding:10px; white-space:nowrap;">
          <span class="fav-star ${isW?'watching':'idle'}" id="star-${id}"
            title="${isW?'Quitar vigilancia':'A√±adir vigilancia'}"
            onclick="toggleWatch('${f.ticker}',event)" style="position:static; margin-right:8px; font-size:14px;">‚òÖ</span>
          <span style="font-weight:800; color:#fff;">${f.ticker}</span>
          <div style="font-size:9px; color:rgba(255,255,255,0.3);">${f.name}</div>
        </td>
        <td id="price-${id}" class="mono" style="padding:10px; font-weight:700; color:#ff007f;">---</td>
        <td id="pct-${id}" class="mono" style="padding:10px; font-weight:800; color:rgba(255,255,255,0.2);">--%</td>
        <td id="rsi-col-${id}" style="padding:10px;">
          <span id="rsi-val-${id}" class="mono" style="font-weight:700;">--</span>
          <div id="rsi-lbl-${id}" style="font-size:8px; opacity:0.5; text-transform:uppercase;">--</div>
        </td>
        <td id="sma-col-${id}" style="padding:10px;">
          <div style="display:flex; gap:4px; font-size:8px; font-weight:700;">
            <span id="sma20-${id}" title="SMA20">20</span>
            <span id="sma50-${id}" title="SMA50">50</span>
            <span id="sma100-${id}" title="SMA100">100</span>
            <span id="sma200-${id}" title="SMA200">200</span>
          </div>
        </td>
        <td id="cross-${id}" style="padding:10px; font-size:9px; font-weight:700;">--</td>
        <td id="signal-${id}" style="padding:10px;">
          <span style="padding:2px 6px; border-radius:4px; font-size:9px; font-weight:800; background:rgba(255,255,255,0.05); color:rgba(255,255,255,0.2);">ESPERANDO</span>
        </td>
        <td style="padding:10px; text-align:right; width:100px;">
          <canvas id="spark-${id}" style="width:100px; height:24px; display:inline-block;"></canvas>
        </td>`;
	    c.appendChild(tr);
	  });
	}

function refreshStars(){
  ALL_ASSETS.forEach(f => {
    const star = document.getElementById('star-'+favId(f.ticker));
    if(!star)return;
    const isW = watchlist.has(f.ticker);
    star.className = 'fav-star '+(isW?'watching':'idle');
    star.title = isW ? 'Quitar vigilancia' : 'A√±adir vigilancia';
  });
}

function toggleWatch(ticker, e){
  e.stopPropagation();
  if(watchlist.has(ticker)){
    watchlist.delete(ticker);
    showToast(`Eliminado de vigilancia: ${ticker}`, 'info', 2500);
  } else {
    watchlist.add(ticker);
    showToast(`‚≠ê ${ticker} a√±adido a vigilancia`, 'info', 2500);
  }
  saveWL(); refreshStars(); updateWatchingCount(); renderWatchPanel();
}

function updateWatchingCount(){
  const n = watchlist.size;
  document.getElementById('watchingCount').innerText = n>0 ? `‚Äî ${n} ‚òÖ` : '';
  document.getElementById('watchCount').innerText    = n>0 ? `${n} activo${n>1?'s':''} en vigilancia` : '';
}

async function loadSparkline(ticker){
  try {
    const r = await fetch(`/api/sparkline/${ticker}`);
    const d = await r.json();
    if(!d.closes||d.closes.length<2)return;
    const id  = favId(ticker);
    
    // 1. Sparkline
    const cvs = document.getElementById(`spark-${id}`);
    if(cvs){
      const dpr = window.devicePixelRatio||1;
      const W = 100, H=24;
      cvs.width=W*dpr; cvs.height=H*dpr;
      const ctx=cvs.getContext('2d'); ctx.scale(dpr,dpr);
      const mn=Math.min(...d.closes),mx=Math.max(...d.closes),rng=mx-mn||1;
      const up=d.pct>=0, col=up?'#00e676':'#ff4444';
      const pts=d.closes.map((v,i)=>({x:i/(d.closes.length-1)*W, y:H-2-(v-mn)/rng*(H-6)}));
      const gr=ctx.createLinearGradient(0,0,0,H);
      gr.addColorStop(0,up?'rgba(0,230,118,.2)':'rgba(255,68,68,.2)');
      gr.addColorStop(1,'rgba(0,0,0,0)');
      ctx.beginPath(); pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
      ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
      ctx.fillStyle=gr; ctx.fill();
      ctx.beginPath(); pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
      ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.stroke();
      
      // 2. Precio y Cambio
      const pEl=document.getElementById(`pct-${id}`);
      if(pEl){ pEl.style.color=col; pEl.innerText=`${up?'+':''}${d.pct.toFixed(2)}%`; pEl.style.opacity="1"; }
      const prEl=document.getElementById(`price-${id}`);
      if(prEl){ prEl.innerText = d.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); prEl.style.color = col; }
    }

    // 3. RSI
    const rsiVal = document.getElementById(`rsi-val-${id}`);
    const rsiLbl = document.getElementById(`rsi-lbl-${id}`);
    if(rsiVal && d.rsi){
      rsiVal.innerText = d.rsi.toFixed(1);
      if(d.rsi > 70){ rsiVal.style.color="#ff007f"; rsiLbl.innerText="Sobrecompra"; rsiLbl.style.color="#ff007f"; }
      else if(d.rsi < 30){ rsiVal.style.color="#00e676"; rsiLbl.innerText="Sobreventa"; rsiLbl.style.color="#00e676"; }
      else { rsiVal.style.color="#fff"; rsiLbl.innerText="Neutral"; rsiLbl.style.color="rgba(255,255,255,0.3)"; }
    }

    // 4. SMAs Proximidad
    const smas = {sma20:d.sma20, sma50:d.sma50, sma100:d.sma100, sma200:d.sma200};
    let nearSMA = false;
    for(let key in smas){
      const el = document.getElementById(`${key}-${id}`);
      if(el && smas[key]){
        const dist = Math.abs(d.price - smas[key]) / smas[key];
        if(dist < 0.005){ el.style.color="#ff007f"; el.style.textDecoration="underline"; nearSMA=true; }
        else if(d.price > smas[key]){ el.style.color="#00e676"; }
        else { el.style.color="#ff4444"; }
      }
    }

    // 5. Cruce 100/200
    const crossEl = document.getElementById(`cross-${id}`);
    if(crossEl && d.sma100 && d.sma200 && d.prev_sma100 && d.prev_sma200){
      if(d.prev_sma100 < d.prev_sma200 && d.sma100 >= d.sma200){ crossEl.innerText="GOLDEN"; crossEl.style.color="#00e676"; }
      else if(d.prev_sma100 > d.prev_sma200 && d.sma100 <= d.sma200){ crossEl.innerText="DEATH"; crossEl.style.color="#ff4444"; }
      else { crossEl.innerText="--"; crossEl.style.color="rgba(255,255,255,0.2)"; }
    }

    // 6. Se√±al
    const sigEl = document.getElementById(`signal-${id}`);
    if(sigEl){
      let signal = "ESPERAR", cls = "signal-tag";
      if(d.rsi < 35 && nearSMA && d.price > d.sma200){ signal="√ìPTIMO"; cls+=" signal-optimo"; }
      else if(d.rsi < 45 || nearSMA){ signal="INTERESANTE"; cls+=" signal-interesante"; }
      else if(d.rsi > 65){ signal="EVITAR"; cls+=" signal-evitar"; }
      sigEl.innerHTML = `<span class="${cls}">${signal}</span>`;
    }

  }catch(e){ console.error(e); }
}

function toggleFavs(){
  favsOpen=!favsOpen;
  document.getElementById('favBody').classList.toggle('open',favsOpen);
  document.getElementById('favBody').classList.toggle('closed',!favsOpen);
  document.getElementById('favChevron').style.transform=favsOpen?'rotate(0deg)':'rotate(-90deg)';
  if(favsOpen) setTimeout(()=>ALL_ASSETS.forEach(f=>loadSparkline(f.ticker)),60);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIGILANCIA ‚Äî panel con alertas de la √∫ltima semana
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startWatcher(){ checkWatchlist(); setInterval(checkWatchlist, 5*60*1000); }

async function checkWatchlist(){
  if(watchlist.size===0){ setWatchStatus('idle'); renderWatchPanel(); return; }
  const tickers=[...watchlist].join(',');
  try {
    const r=await fetch(`/api/watch?tickers=${encodeURIComponent(tickers)}`);
    const d=await r.json();

    // Agrupar alertas por ticker; a√±adir timestamp "ahora" para filtrado semanal
    const now = Date.now();
    (d.alertas||[]).forEach(a => {
      const m = a.msg.match(/^\[([^\]]+)\]/);
      const t = m?m[1]:'?';
      if(!alertsByTicker[t]) alertsByTicker[t]=[];
      // Evitar duplicados
      const isDup = alertsByTicker[t].some(x=>x.msg===a.msg && now-x.ts < 5*60*1000);
      if(!isDup) alertsByTicker[t].push({msg:a.msg, nivel:a.nivel, ts:now});
    });

    // Guardar alertas en localStorage para persistencia
    localStorage.setItem('etf_alerts', JSON.stringify(alertsByTicker));

    // Limpiar entradas > 7 d√≠as
    const week = 7*24*3600*1000;
    Object.keys(alertsByTicker).forEach(t=>{
      alertsByTicker[t]=alertsByTicker[t].filter(x=>now-x.ts<week);
      if(alertsByTicker[t].length===0) delete alertsByTicker[t];
    });

    const total = Object.values(alertsByTicker).reduce((s,a)=>s+a.length,0);
    setWatchStatus(total>0?'alert':'ok');
    applyAlertBadges();
    renderWatchPanel();

    // Toasts solo para alertas nuevas
    (d.alertas||[]).forEach(a=>{
      if(!shownToasts.has(a.msg)){
        shownToasts.add(a.msg);
        showToast(a.msg, a.nivel);
        setTimeout(()=>shownToasts.delete(a.msg), 2*3600*1000);
      }
    });

    // Si el s√≠mbolo activo est√° en watchlist, refrescar su panel de alertas
    if(watchlist.has(currentSymbol)) renderCurrentAlerts();
  }catch(e){ setWatchStatus('err'); }
}

function setWatchStatus(s){
  const dot=document.getElementById('watchDot'),lbl=document.getElementById('watchLabel');
  const m={ok:['#00e676','Activa'],alert:['#ff007f','¬°Alerta!'],err:['#555','Error'],idle:['rgba(255,255,255,.15)','En espera']};
  const[c,t]=m[s]||m.ok;
  dot.style.background=c; lbl.style.color=c; lbl.innerText=t;
}

function renderWatchPanel(){
  const emptyEl   = document.getElementById('watchEmpty');
  const listEl    = document.getElementById('watch-alerts-list');
  const countEl   = document.getElementById('watchCount');

  if(watchlist.size===0){
    emptyEl.style.display='block';
    listEl.innerHTML='';
    countEl.innerText='';
    return;
  }
  emptyEl.style.display='none';

  // Construir lista agrupada por ticker con alertas de √∫ltimos 7 d√≠as
  const now = Date.now();
  const week = 7*24*3600*1000;
  let html='';
  let totalAlertas=0;

  [...watchlist].forEach(ticker=>{
    const alerts=(alertsByTicker[ticker]||[]).filter(x=>now-x.ts<week);
    if(!alerts.length) return;
    totalAlertas+=alerts.length;
    html+=`<div style="margin-bottom:6px">
      <div style="font-size:9px;font-weight:800;letter-spacing:.08em;
        color:rgba(255,255,255,.35);text-transform:uppercase;margin-bottom:3px;
        display:flex;align-items:center;justify-content:space-between">
        <span>${ticker}</span>
        <span style="color:rgba(255,255,255,.2);font-weight:400">${alerts.length} alerta${alerts.length>1?'s':''}</span>
      </div>`;
    alerts.slice().reverse().forEach(a=>{
      const rel=relTime(a.ts);
      const dateStr = new Date(a.ts).toLocaleDateString('es-ES', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
      html+=`<div class="w-alerta ${a.nivel}" onclick="loadSymbol('${ticker}')">
        <span class="w-ticker">${ticker}</span>${a.msg.replace(/^\[[^\]]+\]\s*/,'')}
        <div style="font-size:8px;opacity:.5;margin-top:2px;display:flex;justify-content:space-between">
          <span>${dateStr}</span>
          <span>${rel}</span>
        </div>
      </div>`;
    });
    html+='</div>';
  });

  if(!html){
    html=`<div style="font-size:10px;color:rgba(255,255,255,.2);padding:4px 0">
      Sin alertas en los √∫ltimos 7 d√≠as para los activos vigilados.</div>`;
  }
  listEl.innerHTML=html;
  countEl.innerText=totalAlertas>0
    ? `${totalAlertas} alerta${totalAlertas>1?'s':''} esta semana`
    : `${watchlist.size} activo${watchlist.size>1?'s':''} vigilados ‚Äî sin alertas recientes`;
}

function relTime(ts){
  const diff=Date.now()-ts;
  if(diff<60000)return'ahora';
  if(diff<3600000)return`${Math.floor(diff/60000)}m`;
  if(diff<86400000)return`${Math.floor(diff/3600000)}h`;
  return`${Math.floor(diff/86400000)}d`;
}

function applyAlertBadges(){
  const now=Date.now(), week=7*24*3600*1000;
  ALL_ASSETS.forEach(f=>{
    const card=document.getElementById('fc-'+favId(f.ticker));
    if(!card)return;
    const existing=card.querySelector('.alert-badge');
    const alerts=(alertsByTicker[f.ticker]||[]).filter(x=>now-x.ts<week);
    const hasAlert=watchlist.has(f.ticker)&&alerts.length>0;
    if(hasAlert&&!existing){
      const b=document.createElement('span');
      b.className='alert-badge';
      b.title=alerts.map(a=>a.msg).join('\n');
      card.appendChild(b);
    } else if(!hasAlert&&existing){ existing.remove(); }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FETCH ‚Äî siempre m√°ximo, velas diarias
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchData(sym){
  // Siempre max per√≠odo con velas diarias (1d/max)
  const r=await fetch(`/api/chart/${encodeURIComponent(sym)}?interval=1d`);
  const d=await r.json();
  if(d.error) throw new Error(d.error);
  return d;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLOTLY RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BG='#07070f';

function renderPlotly(apiData){
  const cd    = apiData.chart;
  const dates = cd.candles.map(c=>new Date(c.x));
  const closes= cd.candles.map(c=>c.c);
  const last  = closes[closes.length-1]||1;
  const yFmt  = last>500?',.0f':last>1?',.2f':',.4f';
  const traces=[];

  // ‚îÄ‚îÄ Precio: l√≠nea blanca + relleno blanco suave ‚îÄ‚îÄ
  traces.push({
    x:dates, y:closes,
    type:'scatter', mode:'lines', name:'Precio',
    line:{color:'rgba(255,255,255,1)',width:1,shape:'linear'},
    fill:'tozeroy', fillcolor:'rgba(255,255,255,.08)',
    hovertemplate:'<b>%{x|%d %b %Y}</b><br><b>$%{y:,.2f}</b><extra></extra>',
  });

  const xy=arr=>({xs:arr.map(p=>new Date(p.x)),ys:arr.map(p=>p.y)});

  // ‚îÄ‚îÄ SMAs ‚îÄ‚îÄ
  const smasCfg=[
    {key:'sma20', data:cd.sma20, col:'rgba(0,255,255,.85)',  w:1.2,name:'SMA 20'},
    {key:'sma50', data:cd.sma50, col:'rgba(255,255,0,.85)',  w:1.5,name:'SMA 50'},
    {key:'sma100',data:cd.sma100,col:'rgba(255,200,100,.85)',w:1.8,name:'SMA 100'},
    {key:'sma200',data:cd.sma200,col:'rgba(200,150,220,.9)', w:2.2,name:'SMA 200'},
  ];
  smasCfg.forEach(s=>{
    if(!indVisible[s.key])return;
    const{xs,ys}=xy(s.data);
    traces.push({x:xs,y:ys,type:'scatter',mode:'lines',name:s.name,
      line:{color:s.col,width:s.w},
      hovertemplate:`<b>${s.name}</b>: $%{y:,.2f}<extra></extra>`});
  });

  // ‚îÄ‚îÄ Supertrend ‚Äî puntos muy peque√±os ‚îÄ‚îÄ
  if(indVisible.st){
    const stB=xy(cd.st_buy),stS=xy(cd.st_sell);
    if(stB.xs.length) traces.push({x:stB.xs,y:stB.ys,type:'scatter',mode:'markers',name:'ST‚ñ≤',
      marker:{color:'rgba(0,255,100,.8)',size:3,symbol:'circle'},
      hovertemplate:'ST‚ñ≤: $%{y:,.2f}<extra></extra>'});
    if(stS.xs.length) traces.push({x:stS.xs,y:stS.ys,type:'scatter',mode:'markers',name:'ST‚ñº',
      marker:{color:'rgba(255,50,50,.8)',size:3,symbol:'circle'},
      hovertemplate:'ST‚ñº: $%{y:,.2f}<extra></extra>'});
  }

  // ‚îÄ‚îÄ RSI se√±ales ‚îÄ‚îÄ
  if(indVisible.rsi){
    const ros=xy(cd.rsi_os),rob=xy(cd.rsi_ob);
    if(ros.xs.length) traces.push({x:ros.xs,y:ros.ys,type:'scatter',mode:'markers',name:'RSI<30',
      marker:{color:'#00e676',size:9,symbol:'triangle-up',line:{color:'#07070f',width:1.5}},
      hovertemplate:'üü¢ Sobreventa<br>$%{y:,.2f}<extra></extra>'});
    if(rob.xs.length) traces.push({x:rob.xs,y:rob.ys,type:'scatter',mode:'markers',name:'RSI>70',
      marker:{color:'#ff007f',size:9,symbol:'triangle-down',line:{color:'#07070f',width:1.5}},
      hovertemplate:'üî¥ Sobrecompra<br>$%{y:,.2f}<extra></extra>'});
  }

  const layout={
    paper_bgcolor:BG, plot_bgcolor:'#0a0a12',
    margin:{t:12,r:60,b:50,l:50},
    hovermode:'x unified',
    hoverlabel:{bgcolor:'rgba(10,10,22,.95)',bordercolor:'rgba(255,255,255,.1)',
      font:{family:'JetBrains Mono,monospace',size:11,color:'#e0e0e0'}},
    showlegend:false,
    xaxis:{type:'date',
      gridcolor:'rgba(255,255,255,.04)',linecolor:'rgba(255,255,255,.07)',
      tickcolor:'rgba(255,255,255,.2)',tickfont:{color:'rgba(255,255,255,.45)',size:9},
      tickformat:'%d',
      dtick: 86400000 * 2,
      tickvals: dates.filter((d, i) => i % 2 === 0 || d.getDate() === 1),
      showspikes:true,spikecolor:'rgba(255,255,255,.1)',spikedash:'dot',spikethickness:1,
      rangeslider:{visible:false}},
    yaxis:{gridcolor:'rgba(255,255,255,.04)',linecolor:'rgba(255,255,255,.07)',
      tickfont:{color:'rgba(255,255,255,.4)',size:9},side:'right',tickformat:yFmt},
    dragmode:'pan',font:{family:'Inter,sans-serif'}
  };

    // Si ya existe el gr√°fico, intentar mantener el rango actual de X
    const div = document.getElementById('plotDiv');
    if(div && div.layout && div.layout.xaxis && div.layout.xaxis.range) {
      layout.xaxis.range = div.layout.xaxis.range;
    } else {
      // Por defecto, mostrar los √∫ltimos 2 meses
      const lastDate = dates[dates.length - 1];
      if(lastDate) {
        const twoMonthsAgo = new Date(lastDate.getTime() - 60 * 24 * 60 * 60 * 1000);
        layout.xaxis.range = [twoMonthsAgo.toISOString(), lastDate.toISOString()];
      }
    }

    Plotly.react('plotDiv',traces,layout,
    {responsive:true,scrollZoom:true,displayModeBar:false,doubleClick:'reset'});

  // ‚îÄ‚îÄ RSI panel ‚îÄ‚îÄ
  const rsiWrap=document.getElementById('rsiWrap');
  if(indVisible.rsi){
    rsiWrap.style.display='block';
    renderRSIPanel(cd,dates);
  } else {
    rsiWrap.style.display='none';
  }
}

function renderRSIPanel(cd,dates){
  const d0=dates[0]||new Date(), dN=dates[dates.length-1]||new Date();
  const ros=cd.rsi_os.map(p=>new Date(p.x));
  const rob=cd.rsi_ob.map(p=>new Date(p.x));
  const rt=[
    {x:[d0,dN],y:[30,30],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',
     line:{color:'rgba(0,230,118,.3)',width:1,dash:'dot'}},
    {x:[d0,dN],y:[70,70],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',
     line:{color:'rgba(255,0,127,.3)',width:1,dash:'dot'}},
    {x:ros,y:ros.map(()=>20),type:'scatter',mode:'markers',name:'SV',
     marker:{color:'#00e676',size:6,symbol:'triangle-up',line:{color:'#07070f',width:1}},
     hovertemplate:'üü¢ Sobreventa<extra></extra>'},
    {x:rob,y:rob.map(()=>80),type:'scatter',mode:'markers',name:'SC',
     marker:{color:'#ff007f',size:6,symbol:'triangle-down',line:{color:'#07070f',width:1}},
     hovertemplate:'üî¥ Sobrecompra<extra></extra>'},
  ];
  const rl={
    paper_bgcolor:BG,plot_bgcolor:'rgba(255,255,255,.01)',
    margin:{t:8,r:60,b:40,l:50},showlegend:false,
    xaxis:{type:'date',gridcolor:'rgba(255,255,255,.03)',linecolor:'rgba(255,255,255,.05)',
      tickfont:{color:'rgba(255,255,255,.3)',size:9},tickformat:'%d %b',rangeslider:{visible:false}},
    yaxis:{range:[0,100],gridcolor:'rgba(255,255,255,.03)',
      tickfont:{color:'rgba(255,255,255,.2)',size:8},side:'right',tickvals:[30,50,70]},
    shapes:[
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:0,y1:30,fillcolor:'rgba(0,230,118,.04)',line:{width:0}},
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:70,y1:100,fillcolor:'rgba(255,0,127,.04)',line:{width:0}}
    ],
    font:{family:'Inter,sans-serif'},dragmode:'pan'
  };
  Plotly.react('rsiDiv',rt,rl,{responsive:true,scrollZoom:false,displayModeBar:false});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleInd(key){
  indVisible[key]=!indVisible[key];
  document.getElementById('tog-'+key).classList.toggle('off',!indVisible[key]);
  
  // Actualizar visualizaci√≥n de botones
  const btn = document.getElementById('tog-'+key);
  if(btn) {
    if(indVisible[key]) {
      btn.classList.remove('off');
    } else {
      btn.classList.add('off');
    }
  }

  if(lastData) renderPlotly(lastData);
}

function zoomChart(factor){
  const div = document.getElementById('plotDiv');
  if(!div || !div.layout || !div.layout.xaxis) return;
  const xRange = div.layout.xaxis.range;
  if(!xRange || xRange.length < 2) return;
  
  const start = new Date(xRange[0]).getTime();
  const end = new Date(xRange[1]).getTime();
  const center = (start + end) / 2;
  const newHalfWidth = ((end - start) / 2) / factor;
  
  const newRange = [
    new Date(center - newHalfWidth).toISOString(),
    new Date(center + newHalfWidth).toISOString()
  ];
  
  Plotly.relayout('plotDiv', { 'xaxis.range': newRange });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARGA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSymbol(sym){
  currentSymbol=sym;
  document.getElementById('symbolInput').value=sym;
  document.querySelectorAll('.fav-card').forEach(c=>c.classList.remove('active-sym'));
  const el=document.getElementById('fc-'+favId(sym));
  if(el) el.classList.add('active-sym');

  // show spinner, keep chart visible underneath
  document.getElementById('loadWrap').style.display='flex';

  try {
    const data=await fetchData(sym);
    lastData=data;
    document.getElementById('loadWrap').style.display='none';
    renderPlotly(data);
    updateSidebar(data);
    renderCurrentAlerts();
  } catch(e){
    document.getElementById('loadWrap').style.display='none';
    showToast('‚ùå '+e.message,'bearish');
  }
}

function renderCurrentAlerts(){
  // Muestra en el sidebar las alertas del s√≠mbolo actualmente en gr√°fico
  const fromWatch = watchlist.has(currentSymbol) ? (alertsByTicker[currentSymbol]||[]) : [];
  const fromData  = lastData ? (lastData.alertas||[]) : [];
  // Unir, priorizar las de watchlist
  const all = fromWatch.length ? fromWatch.map(a=>({msg:a.msg,nivel:a.nivel})) : fromData;
  renderAlertas(all);
}

function doSearch(){
  const s=document.getElementById('symbolInput').value.trim().toUpperCase();
  if(s) loadSymbol(s);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSidebar(data){
  document.getElementById('dispSym').innerText=currentSymbol;
  document.getElementById('dispPrice').innerText=
    data.last_price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const chEl=document.getElementById('dispChange');
  const pre=data.change>=0?'+':'';
  chEl.innerText=`${pre}${data.change.toFixed(2)} (${pre}${data.change_pct.toFixed(2)}%)`;
  chEl.style.color=data.change>=0?'#00e676':'#ff4444';
  updateRSI(data.rsi_current);
  document.getElementById('alertSymLabel').innerText=currentSymbol;
}

function updateRSI(v){
  v=parseFloat(v); if(isNaN(v))return;
  document.getElementById('rsiVal').innerText=v.toFixed(1);
  document.getElementById('rsiCursor').style.left=`calc(${Math.min(Math.max(v,0),100)}% - 5px)`;
  const lbl=document.getElementById('rsiLbl'),val=document.getElementById('rsiVal');
  if(v<30){
    lbl.innerText='SV';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(0,230,118,.12);color:#00e676;font-weight:700';
    val.style.color='#00e676';
  } else if(v>70){
    lbl.innerText='SC';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,68,68,.12);color:#ff5252;font-weight:700';
    val.style.color='#ff5252';
  } else {
    lbl.innerText='N';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);font-weight:700';
    val.style.color='#fff';
  }
}

function renderAlertas(alertas){
  const box=document.getElementById('alertBox'),list=document.getElementById('alertList');
  if(!alertas||!alertas.length){box.style.display='none';return;}
  box.style.display='block';
  list.innerHTML=alertas.map(a=>`<div class="alerta-item ${a.nivel}">${a.msg.replace(/^\[[^\]]+\]\s*/,'')}</div>`).join('');
}

function showToast(msg,nivel,ms=6000){
  const c=document.getElementById('toasts');
  const t=document.createElement('div');
  t.className=`toast ${nivel}`; t.innerText=msg;
  c.appendChild(t); setTimeout(()=>t.remove(),ms);
}
</script>
</body>
</html>
