<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Expande Tu Futuro</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{-webkit-text-size-adjust:100%}
body{font-family:'Syne',sans-serif;background:#07070f;color:#e0e0e0;min-height:100vh;overflow-x:hidden}
.mono{font-family:'Space Mono',monospace}
.card{background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.07);border-radius:14px}

#app{width:100%;max-width:1600px;margin:0 auto;padding:10px 12px;display:flex;flex-direction:column;gap:10px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
#hdr{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
#hdr-logo{width:30px;height:30px;border-radius:9px;background:#ff007f;box-shadow:0 0 14px rgba(255,0,127,.4);
  display:flex;align-items:center;justify-content:center;flex-shrink:0}
#hdr-title{font-size:14px;font-weight:800;letter-spacing:-.2px;white-space:nowrap}
#hdr-badge{font-size:9px;padding:2px 7px;border-radius:4px;background:rgba(255,0,127,.12);
  color:#ff69b4;border:1px solid rgba(255,0,127,.25);font-weight:700;letter-spacing:.08em;white-space:nowrap}
#hdr-search{display:flex;align-items:center;gap:6px;flex:1;min-width:0}
#symbolInput{flex:1;min-width:0;background:#111;border:1px solid rgba(255,255,255,.1);border-radius:9px;
  padding:8px 12px;font-size:13px;color:#e0e0e0;font-family:'Syne',sans-serif;transition:border-color .2s}
#symbolInput:focus{outline:none;border-color:rgba(255,0,127,.5)}
#btnSearch{padding:8px 14px;border-radius:9px;background:#ff007f;color:#fff;font-size:13px;font-weight:700;
  border:none;cursor:pointer;font-family:'Syne',sans-serif;white-space:nowrap;flex-shrink:0}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#main{display:flex;flex-direction:column;gap:10px;width:100%}
@media(min-width:900px){
  #main{display:grid;grid-template-columns:170px 1fr;align-items:flex-start}
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar{display:flex;flex-direction:column;gap:8px}
#price-widget{padding:13px}
#dispSym{font-size:10px;font-weight:800;letter-spacing:.12em;color:#ff007f;margin-bottom:2px}
#dispPrice{font-size:20px;font-weight:700;line-height:1.2;color:#fff}
#dispChange{font-size:11px;margin-top:4px;font-weight:600}
#smaInfo{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.05);
  font-size:9px;color:rgba(255,255,255,.25);letter-spacing:.06em}
#rsiRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
#rsiBar{height:5px;border-radius:3px;position:relative;margin-top:5px;
  background:linear-gradient(to right,rgba(0,230,118,.4) 0%,rgba(0,230,118,.4) 30%,
    rgba(255,255,255,.06) 30%,rgba(255,255,255,.06) 70%,rgba(255,68,68,.4) 70%,rgba(255,68,68,.4) 100%)}
#rsiCursor{position:absolute;top:50%;width:10px;height:10px;border-radius:50%;background:#fff;
  box-shadow:0 0 5px rgba(255,255,255,.5);transform:translate(-50%,-50%);transition:left .4s;left:50%}

#watch-panel{padding:11px}
#watch-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
#watchDot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);display:inline-block;flex-shrink:0}
#watch-alerts-list{display:flex;flex-direction:column;gap:5px;max-height:260px;overflow-y:auto}
@media(max-width:899px){#watch-alerts-list{max-height:none;overflow-y:visible}}
.w-alerta{padding:6px 9px;border-radius:8px;font-size:10px;font-weight:500;line-height:1.45;cursor:pointer;transition:filter .15s}
.w-alerta:hover{filter:brightness(1.3)}
.w-alerta .w-ticker{font-weight:800;font-size:10px;margin-right:4px}
.w-alerta.bullish{background:rgba(0,230,118,.07);color:#00e676}
.w-alerta.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.w-alerta.info{background:rgba(255,0,127,.07);color:#ff69b4}
#alertBox{padding:11px;display:none}
.alerta-item{padding:5px 9px;border-radius:7px;font-size:10px;font-weight:500;line-height:1.4}
.alerta-item.bullish{background:rgba(0,230,118,.07);color:#00e676}
.alerta-item.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.alerta-item.info{background:rgba(255,0,127,.07);color:#ff69b4}

/* ‚îÄ‚îÄ CHART CARD ‚îÄ‚îÄ */
#chart-card{padding:13px;display:flex;flex-direction:column;gap:9px;position:relative}

/* TV-BAR ‚Äî siempre visible */
#tv-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;
  padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.05)}
#ind-bar{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.btn-ind{padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;
  transition:all .15s;border:1px solid transparent;font-family:'Syne',sans-serif;white-space:nowrap}
.btn-ind.off{opacity:.25;filter:grayscale(.7)}
#plotDiv{width:100%;height:min(120vw,600px)}
#rsiWrap{display:none}
#rsiDiv{width:100%;height:min(30vw,150px)}
@media(min-width:900px){
  #plotDiv{height:750px}
  #rsiDiv{height:180px}
  #favBody .table-wrap::-webkit-scrollbar{height:6px}
  #favBody .table-wrap::-webkit-scrollbar-track{background:rgba(255,255,255,.04);border-radius:3px}
  #favBody .table-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}
  #favBody .table-wrap::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.3)}
}
#loadWrap{display:none;position:absolute;inset:0;align-items:center;justify-content:center;
  flex-direction:column;gap:12px;color:rgba(255,255,255,.3);background:rgba(7,7,15,.75);z-index:10;border-radius:14px}
.spin{width:32px;height:32px;border:3px solid rgba(255,0,127,.15);border-top-color:#ff007f;
  border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ */
#favs-panel{overflow:hidden}
#favs-hdr{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;
  background:none;border:none;width:100%;color:inherit;font-family:'Syne',sans-serif;padding:14px 16px}
.acc-body{overflow:hidden;transition:max-height .35s ease,opacity .25s ease}
.acc-body.closed{max-height:0!important;opacity:0;pointer-events:none}
.acc-body.open{max-height:9999px;opacity:1}
#assetsTable{width:100%;border-collapse:collapse;min-width:780px}
#assetsTable thead th{padding:8px 12px;font-size:10px;font-weight:700;letter-spacing:.07em;
  color:rgba(255,255,255,.3);text-transform:uppercase;white-space:nowrap;
  background:#07070f;border-bottom:1px solid rgba(255,255,255,.07);text-align:left}
#assetsTable thead th.r{text-align:right}
#assetsTable thead th.c{text-align:center}
.asset-row{border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;transition:background .12s;
  border-left:3px solid transparent}
.asset-row:hover{background:rgba(255,255,255,.025)!important}
.asset-row.active-sym{background:rgba(255,0,127,.04)!important;border-left-color:#ff007f!important}
.asset-row td{padding:8px 12px;white-space:nowrap;vertical-align:middle}
@media(max-width:899px){
  .asset-row td{padding:5px 7px}
  #assetsTable thead th{padding:6px 7px;font-size:9px}
}
.fav-star{font-size:13px;cursor:pointer;user-select:none;transition:transform .15s;line-height:1}
.fav-star.watching{color:#ff007f;text-shadow:0 0 8px rgba(255,0,127,.6)}
.fav-star.idle{color:rgba(255,255,255,.15)}
.fav-star:hover{transform:scale(1.4)}

/* Estado badges */
.badge{display:inline-block;padding:2px 8px;border-radius:5px;font-size:10px;font-weight:700}
.badge.favorable{background:rgba(0,230,118,.15);color:#00e676}
.badge.interesante{background:rgba(255,215,0,.12);color:#ffd700}
.badge.considerar{background:rgba(255,140,0,.12);color:#ff8c00}
.badge.no_favorable{background:rgba(255,255,255,.05);color:rgba(255,255,255,.28)}

/* SMA p√≠ldoras */
.sma-pill{display:inline-block;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;margin:1px}

/* TOASTS */
#toasts{position:fixed;top:12px;right:12px;z-index:9999;display:flex;flex-direction:column;
  gap:7px;pointer-events:none;max-width:calc(100vw - 24px)}
.toast{padding:9px 14px;border-radius:10px;font-size:12px;font-weight:500;pointer-events:auto;
  animation:fadeIn .25s ease;line-height:1.45;word-break:break-word}
.toast.bullish{background:rgba(0,230,118,.13);color:#00e676;border:1px solid rgba(0,230,118,.25)}
.toast.bearish{background:rgba(255,68,68,.13);color:#ff5252;border:1px solid rgba(255,68,68,.25)}
.toast.info{background:rgba(255,0,127,.13);color:#ff69b4;border:1px solid rgba(255,0,127,.25)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
</style>
</head>
<body>
<div id="app">

  <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
  <div id="hdr">
    <div id="hdr-logo">
      <svg width="15" height="15" fill="none" stroke="#fff" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
      </svg>
    </div>
    <span id="hdr-title">EXPANDE <span style="color:#ff007f">TU FUTURO</span></span>
    <span id="hdr-badge">1D ¬∑ SMAs</span>
    <div id="hdr-search">
      <input id="symbolInput" type="text" placeholder="AAPL ¬∑ BTC-USD ¬∑ ^GSPC ¬∑ SPY‚Ä¶"
             autocomplete="off" autocorrect="off" autocapitalize="off"
             onkeydown="if(event.key==='Enter')doSearch()">
      <button id="btnSearch" onclick="doSearch()">Buscar</button>
    </div>
  </div>

  <div id="main">

    <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
    <div id="sidebar">
      <div class="card" id="price-widget">
        <div id="dispSym">---</div>
        <div id="dispPrice" class="mono">---</div>
        <div id="dispChange">--</div>
        <div id="smaInfo">SMA 20 ¬∑ 50 ¬∑ 100 ¬∑ 200</div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.05)">
          <div id="rsiRow">
            <span style="font-size:10px;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:.08em">RSI 14</span>
            <div style="display:flex;align-items:center;gap:4px">
              <span id="rsiVal" class="mono" style="font-size:13px;font-weight:700">--</span>
              <span id="rsiLbl" style="font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">--</span>
            </div>
          </div>
          <div id="rsiBar"><div id="rsiCursor"></div></div>
        </div>
      </div>

      <div id="alertBox" class="card">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.2);font-weight:700;margin-bottom:6px">
          ‚ö° Alertas ‚Äî <span id="alertSymLabel" style="color:#ff007f"></span>
        </div>
        <div id="alertList" style="display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto"></div>
      </div>

      <div class="card" id="watch-panel">
        <div id="watch-hdr" onclick="toggleWatchPanel()" style="cursor:pointer;user-select:none">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:11px;font-weight:700">üîî Vigilancia</span>
            <span id="watchDot"></span>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <span id="watchLabel" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.2)">--</span>
            <span id="watchChevron" style="color:rgba(255,255,255,.3);font-size:10px;transition:transform .3s;transform:rotate(-90deg)">‚ñº</span>
          </div>
        </div>
        <div id="watchBody" class="acc-body closed">
          <div id="watchEmpty" style="font-size:10px;line-height:1.6;color:rgba(255,255,255,.2)">
            Marca ‚òÖ en cualquier activo para a√±adirlo. Alertas cuando precio toca SMAs o cruzan SMA100/SMA200.
          </div>
          <div id="watch-alerts-list"></div>
          <div id="watchCount" style="font-size:10px;margin-top:6px;color:rgba(255,0,127,.5);font-weight:600"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ GR√ÅFICO ‚îÄ‚îÄ -->
    <div class="card" id="chart-card">

      <!-- TV-BAR: siempre visible -->
      <div id="tv-bar">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:10px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.1em">Gr√°fico 1D</span>
          <button onclick="toggleChart()" id="btnToggleChart"
            style="font-size:10px;padding:3px 10px;border-radius:6px;border:1px solid rgba(255,255,255,.12);
            background:rgba(255,255,255,.05);color:rgba(255,255,255,.5);cursor:pointer;font-family:'Syne',sans-serif">
            ‚ñº Abrir gr√°fico
          </button>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <button class="btn-ind" onclick="abrirTradingView()"
            style="background:rgba(41,98,255,.15);color:#2962ff;border-color:rgba(41,98,255,.4);padding:4px 10px;font-size:10px">
            üìà TradingView
          </button>
          <button class="btn-ind" onclick="window.open('https://es.tradingview.com/script/zQDMj0ly/','_blank')"
            style="background:rgba(41,98,255,.08);color:#6b8fff;border-color:rgba(41,98,255,.25);padding:4px 10px;font-size:10px">
            ‚òÖ Indicador ETF
          </button>
        </div>
      </div>

      <!-- CONTENIDO PLEGABLE -->
      <div id="chartBody" style="display:none">
        <div id="ind-bar">
          <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.18);font-weight:700;margin-right:2px">Ind:</span>
          <button class="btn-ind" id="tog-sma20"  style="background:rgba(0,255,255,.1);color:#00ffff;border-color:rgba(0,255,255,.3)"      onclick="toggleInd('sma20')">SMA20</button>
          <button class="btn-ind" id="tog-sma50"  style="background:rgba(255,255,0,.1);color:#ffff00;border-color:rgba(255,255,0,.3)"      onclick="toggleInd('sma50')">SMA50</button>
          <button class="btn-ind" id="tog-sma100" style="background:rgba(255,200,100,.1);color:#ffc864;border-color:rgba(255,200,100,.3)"  onclick="toggleInd('sma100')">SMA100</button>
          <button class="btn-ind" id="tog-sma200" style="background:rgba(200,150,220,.1);color:#c896dc;border-color:rgba(200,150,220,.3)"  onclick="toggleInd('sma200')">SMA200</button>
          <button class="btn-ind off" id="tog-st" style="background:rgba(0,255,100,.1);color:#00e676;border-color:rgba(0,255,100,.3)"      onclick="toggleInd('st')">SuperT</button>
          <button class="btn-ind off" id="tog-rsi"style="background:rgba(255,0,127,.1);color:#ff69b4;border-color:rgba(255,0,127,.3)"      onclick="toggleInd('rsi')">RSI</button>
          <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
            <button class="btn-ind" onclick="zoomChart(1.2)" style="background:rgba(255,255,255,.05);color:#fff;padding:4px 10px;font-size:14px">+</button>
            <button class="btn-ind" onclick="zoomChart(0.8)" style="background:rgba(255,255,255,.05);color:#fff;padding:4px 10px;font-size:14px">-</button>
            <button class="btn-ind" onclick="resetZoom2m()" style="background:rgba(255,0,127,.08);color:#ff69b4;border-color:rgba(255,0,127,.25);padding:4px 10px;font-size:10px">‚Ü∫ 2M</button>
            <span style="font-size:9px;color:rgba(255,255,255,.2);white-space:nowrap">Doble clic reset</span>
          </div>
        </div>

        <div id="loadWrap">
          <div class="spin"></div>
          <span style="font-size:12px">Cargando 1D‚Ä¶</span>
        </div>

        <div style="display:flex;flex-direction:column">
          <div id="plotDiv"></div>
          <div id="rsiWrap">
            <div style="padding:3px 60px 1px 8px;display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.18);font-weight:700">RSI 14 ¬∑ se√±ales extremas</span>
              <span style="font-size:9px;color:rgba(255,255,255,.2)">
                <span style="color:rgba(0,230,118,.8)">‚ñ≤&lt;30</span>&nbsp;
                <span style="color:rgba(255,0,127,.8)">‚ñº&gt;70</span>
              </span>
            </div>
            <div id="rsiDiv"></div>
          </div>
        </div>
      </div><!-- fin chartBody -->

    </div><!-- fin chart-card -->
  </div><!-- fin #main -->

  <!-- ‚îÄ‚îÄ TABLA ACTIVOS: abierta por defecto ‚îÄ‚îÄ -->
  <div class="card" id="favs-panel">
    <button id="favs-hdr" onclick="toggleFavs()">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:#ff007f;font-size:14px">‚òÖ</span>
        <span style="font-size:13px;font-weight:700">Todos los activos</span>
        <span id="favCount" style="font-size:10px;color:rgba(255,255,255,.25)"></span>
        <span id="watchingCount" style="font-size:10px;color:#ff007f;font-weight:700"></span>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:10px;color:rgba(255,255,255,.18)">‚òÖ vigilancia ¬∑ clic fila = gr√°fico</span>
        <span id="favChevron" style="color:rgba(255,255,255,.3);font-size:11px;transition:transform .3s">‚ñº</span>
      </div>
    </button>
    <!-- clase "open" directamente ‚Üí abierta sin JS al cargar -->
    <div id="favBody" class="acc-body open">
      <div class="table-wrap" style="overflow-x:auto;-webkit-overflow-scrolling:touch;overflow-y:visible">
        <table id="assetsTable">
          <thead>
            <tr>
              <th>‚òÖ Activo</th>
              <th class="c">Tendencia</th>
              <th class="r">Precio</th>
              <th class="r">Cambio %</th>
              <th class="c">RSI 14</th>
              <th class="c">Medias m√≥viles</th>
              <th class="c">Cruce 100/200</th>
              <th class="c">Estado</th>
            </tr>
          </thead>
          <tbody id="favItems"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
<div id="toasts"></div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   DATOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const DISPLAY_NAMES = {
  'BTC-USD':'BTC ¬∑ Bitcoin','ETH-USD':'ETH ¬∑ Ethereum',
  '^GSPC':'SPX ¬∑ S&P 500','^NDX':'NQ ¬∑ Nasdaq 100','^DJI':'YM ¬∑ Dow Jones','^RUT':'RTY ¬∑ Russell 2000',
  'SPY':'SPY ¬∑ S&P 500 ETF','VOO':'VOO ¬∑ Vanguard S&P','VTI':'VTI ¬∑ Mercado Total',
  'QQQ':'QQQ ¬∑ Nasdaq ETF','QQQM':'QQQM ¬∑ Nasdaq Mini','SPMO':'SPMO ¬∑ Momentum SP',
  'JEPQ':'JEPQ ¬∑ Income Nasdaq','ITOT':'ITOT ¬∑ iShares Total','SCHD':'SCHD ¬∑ Dividendos',
  'SCHG':'SCHG ¬∑ Growth','VGT':'VGT ¬∑ Tecnolog√≠a','VHT':'VHT ¬∑ Salud',
  'VFH':'VFH ¬∑ Financiero','VEA':'VEA ¬∑ Europa Asia','VTV':'VTV ¬∑ Value',
  'VTWO':'VTWO ¬∑ Russell 2K','IWM':'IWM ¬∑ Small Cap','XLE':'XLE ¬∑ Energ√≠a',
  'SMH':'SMH ¬∑ Semiconductores','RSP':'RSP ¬∑ SP Equi-pond','EEM':'EEM ¬∑ Emergentes',
  'ILF':'ILF ¬∑ Latinoam√©rica','DIA':'DIA ¬∑ Dow Jones ETF','IOO':'IOO ¬∑ Global 100',
  'SPYM':'SPYM ¬∑ SP Apal. 1.5x','FEPI':'FEPI ¬∑ Tech Income','GLD':'GLD ¬∑ Oro ETF',
  'IAU':'IAU ¬∑ Oro iShares','GDX':'GDX ¬∑ Mineras Oro','UGL':'UGL ¬∑ Oro 2x',
  'COPX':'COPX ¬∑ Cobre ETF','REMX':'REMX ¬∑ Tierras Raras','URNM':'URNM ¬∑ Uranio ETF',
  'URA':'URA ¬∑ Uranio Global','AAPL':'AAPL ¬∑ Apple',
};

const ALL_ASSETS = [
  {name:'Bitcoin',   ticker:'BTC-USD',cat:'ü™ô'},{name:'Ethereum',  ticker:'ETH-USD',cat:'ü™ô'},
  {name:'S&P 500',   ticker:'^GSPC',  cat:'üìä'},{name:'Nasdaq 100',ticker:'^NDX',   cat:'üìä'},
  {name:'Dow Jones', ticker:'^DJI',   cat:'üìä'},{name:'Russell 2K',ticker:'^RUT',   cat:'üìä'},
  {name:'SPY', ticker:'SPY', cat:'ETF'},{name:'VOO', ticker:'VOO', cat:'ETF'},
  {name:'VTI', ticker:'VTI', cat:'ETF'},{name:'QQQ', ticker:'QQQ', cat:'ETF'},
  {name:'QQQM',ticker:'QQQM',cat:'ETF'},{name:'SPMO',ticker:'SPMO',cat:'ETF'},
  {name:'JEPQ',ticker:'JEPQ',cat:'ETF'},{name:'ITOT',ticker:'ITOT',cat:'ETF'},
  {name:'SCHD',ticker:'SCHD',cat:'ETF'},{name:'SCHG',ticker:'SCHG',cat:'ETF'},
  {name:'VGT', ticker:'VGT', cat:'ETF'},{name:'VHT', ticker:'VHT', cat:'ETF'},
  {name:'VFH', ticker:'VFH', cat:'ETF'},{name:'VEA', ticker:'VEA', cat:'ETF'},
  {name:'VTV', ticker:'VTV', cat:'ETF'},{name:'VTWO',ticker:'VTWO',cat:'ETF'},
  {name:'IWM', ticker:'IWM', cat:'ETF'},{name:'XLE', ticker:'XLE', cat:'ETF'},
  {name:'SMH', ticker:'SMH', cat:'ETF'},{name:'RSP', ticker:'RSP', cat:'ETF'},
  {name:'EEM', ticker:'EEM', cat:'ETF'},{name:'ILF', ticker:'ILF', cat:'ETF'},
  {name:'DIA', ticker:'DIA', cat:'ETF'},{name:'IOO', ticker:'IOO', cat:'ETF'},
  {name:'SPYM',ticker:'SPYM',cat:'ETF'},{name:'FEPI',ticker:'FEPI',cat:'ETF'},
  {name:'GLD', ticker:'GLD', cat:'ü•á'},{name:'IAU', ticker:'IAU', cat:'ü•á'},
  {name:'GDX', ticker:'GDX', cat:'ü•á'},{name:'UGL', ticker:'UGL', cat:'ü•á'},
  {name:'COPX',ticker:'COPX',cat:'‚õèÔ∏è'},{name:'REMX',ticker:'REMX',cat:'‚õèÔ∏è'},
  {name:'URNM',ticker:'URNM',cat:'‚öõÔ∏è'},{name:'URA', ticker:'URA', cat:'‚öõÔ∏è'},
  {name:'Apple',ticker:'AAPL',cat:'üíº'},
];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ESTADO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let currentSymbol  = '^NDX';
let favsOpen       = true;
let indVisible     = {sma20:true,sma50:true,sma100:true,sma200:true,st:false,rsi:false};
let lastData       = null;
let watchlist      = new Set();
let alertsByTicker = {};
let shownToasts    = new Set();
let savedXRange    = null;
let watchPanelOpen = false;

function saveWL(){try{localStorage.setItem('etf_wl',JSON.stringify([...watchlist]))}catch(e){}}
function loadWL(){try{const s=localStorage.getItem('etf_wl');if(s)watchlist=new Set(JSON.parse(s))}catch(e){}}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   INIT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
window.onload=()=>{
  loadWL();
  document.getElementById('favCount').innerText=`‚Äî ${ALL_ASSETS.length} activos`;
  document.getElementById('favChevron').style.transform='rotate(0deg)';
  buildFavGrid();
  updateWatchingCount();
  ALL_ASSETS.forEach(f=>loadRowData(f.ticker));
  loadSymbol('^NDX');
  startWatcher();
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CHART TOGGLE (nuevo, de Matrix)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleChart(){
  const body=document.getElementById('chartBody');
  const btn=document.getElementById('btnToggleChart');
  const visible=body.style.display!=='none';
  body.style.display=visible?'none':'block';
  btn.innerText=visible?'‚ñº Abrir gr√°fico':'‚ñ≤ Cerrar gr√°fico';
  if(!visible&&lastData)renderPlotly(lastData);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   TABLA
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function favId(t){return 'f_'+t.replace(/[^a-z0-9]/gi,'_');}
function formatPrice(p){
  if(p===null||p===undefined)return '‚Äî';
  return p>100?p.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}):p.toFixed(4);
}

function buildFavGrid(){
  const tbody=document.getElementById('favItems');
  tbody.innerHTML='';
  ALL_ASSETS.forEach(f=>{
    const id=favId(f.ticker),isW=watchlist.has(f.ticker);
    const tr=document.createElement('tr');
    tr.id='fc-'+id;tr.className='asset-row';
    tr.onclick=e=>{if(e.target.closest('.fav-star'))return;loadSymbol(f.ticker);};
    tr.innerHTML=`
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="fav-star ${isW?'watching':'idle'}" id="star-${id}" onclick="toggleWatch('${f.ticker}',event)">‚òÖ</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:#e0e0e0">${f.ticker}</div>
            <div style="font-size:10px;color:rgba(255,255,255,.3)">${f.cat} ${f.name}</div>
            <canvas id="spark-${id}" width="80" height="22" style="display:block;margin-top:3px;max-width:60px"></canvas>
          </div>
        </div>
      </td>
      <td style="text-align:center">
        <span id="tst-${id}" style="font-size:16px;font-weight:700;color:rgba(255,255,255,.2)">‚Äî</span>
      </td>
      <td style="text-align:right">
        <span id="tp-${id}" class="mono" style="font-size:12px;font-weight:600;color:#fff">‚Äî</span>
      </td>
      <td style="text-align:right">
        <span id="tc-${id}" style="font-size:12px;font-weight:700;color:rgba(255,255,255,.3)">‚Äî</span>
      </td>
      <td style="text-align:center">
        <span id="tr-${id}" style="font-size:11px;font-weight:700;padding:2px 7px;border-radius:5px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">‚Äî</span>
      </td>
      <td style="text-align:center;min-width:110px">
        <div id="tsma-${id}" style="display:flex;flex-wrap:wrap;gap:2px;justify-content:center">
          <span style="font-size:10px;color:rgba(255,255,255,.15)">‚Äî</span>
        </div>
      </td>
      <td style="text-align:center"><span id="tcr-${id}" style="font-size:16px;font-weight:700;color:rgba(255,255,255,.2)">‚Äî</span></td>
      <td style="text-align:center"><span id="tes-${id}">‚Äî</span></td>`;
    tbody.appendChild(tr);
  });
}

function refreshStars(){
  ALL_ASSETS.forEach(f=>{
    const s=document.getElementById('star-'+favId(f.ticker));
    if(!s)return;
    s.className='fav-star '+(watchlist.has(f.ticker)?'watching':'idle');
  });
}

function toggleWatch(ticker,e){
  e.stopPropagation();
  if(watchlist.has(ticker)){watchlist.delete(ticker);showToast(`Eliminado de vigilancia: ${ticker}`,'info',2500);}
  else{watchlist.add(ticker);showToast(`‚≠ê ${ticker} a√±adido a vigilancia`,'info',2500);}
  saveWL();refreshStars();updateWatchingCount();renderWatchPanel();
}

function updateWatchingCount(){
  const n=watchlist.size;
  document.getElementById('watchingCount').innerText=n>0?`‚Äî ${n} ‚òÖ`:'';
  document.getElementById('watchCount').innerText=n>0?`${n} activo${n>1?'s':''} en vigilancia`:'';
}

function toggleFavs(){
  favsOpen=!favsOpen;
  document.getElementById('favBody').classList.toggle('open',favsOpen);
  document.getElementById('favBody').classList.toggle('closed',!favsOpen);
  document.getElementById('favChevron').style.transform=favsOpen?'rotate(0deg)':'rotate(-90deg)';
  if(favsOpen)ALL_ASSETS.forEach(f=>loadRowData(f.ticker));
}

async function loadRowData(ticker){
  try{
    const[rowRes,spkRes]=await Promise.all([
      fetch(`/api/row/${encodeURIComponent(ticker)}`),
      fetch(`/api/sparkline/${encodeURIComponent(ticker)}`)
    ]);
    const d=await rowRes.json(),spk=await spkRes.json();
    if(d.error)return;
    const id=favId(ticker);

    drawSparkline(id,spk);

    // Tendencia SuperTrend
    const stEl=document.getElementById(`tst-${id}`);
    if(stEl){
      if(d.st_dir===1)stEl.innerHTML='<span style="color:#00e676">‚ñ≤</span>';
      else if(d.st_dir===-1)stEl.innerHTML='<span style="color:#ff4444">‚ñº</span>';
      else stEl.innerText='‚Äî';
    }

    const prEl=document.getElementById(`tp-${id}`);if(prEl)prEl.innerText=formatPrice(d.price);

    const chEl=document.getElementById(`tc-${id}`);
    if(chEl){const up=d.change_pct>=0;chEl.innerText=`${up?'+':''}${d.change_pct.toFixed(2)}%`;chEl.style.color=up?'#00e676':'#ff4444';}

    const rsiEl=document.getElementById(`tr-${id}`);
    if(rsiEl&&d.rsi!=null){
      rsiEl.innerText=d.rsi.toFixed(1);
      if(d.rsi<30){rsiEl.style.background='rgba(0,230,118,.15)';rsiEl.style.color='#00e676';}
      else if(d.rsi>70){rsiEl.style.background='rgba(255,68,68,.15)';rsiEl.style.color='#ff5252';}
      else{rsiEl.style.background='rgba(255,255,255,.06)';rsiEl.style.color='rgba(255,255,255,.5)';}
    }

    // SMAs ‚Äî cu√°les est√° tocando
    const smaCell=document.getElementById(`tsma-${id}`);
    if(smaCell){
      const THRESH=0.6;
      const defs=[{v:d.sma20,label:'SMA20'},{v:d.sma50,label:'SMA50'},{v:d.sma100,label:'SMA100'},{v:d.sma200,label:'SMA200'}];
      const near=defs.filter(s=>s.v&&Math.abs(d.price-s.v)/s.v*100<=THRESH);
      if(!near.length){
        smaCell.innerHTML='<span style="font-size:10px;color:rgba(255,255,255,.12)">‚Äî</span>';
      }else{
        smaCell.innerHTML=near.map(s=>{
          const pct=((d.price-s.v)/s.v*100).toFixed(2);
          const touching=Math.abs(parseFloat(pct))<=0.15;
          const col=touching?'#ff9800':'#ffa500';
          const bg=touching?'rgba(255,152,0,.28)':'rgba(255,165,0,.11)';
          return `<span class="sma-pill" style="background:${bg};color:${col}" title="${s.label}: $${s.v.toFixed(2)} (${pct}%)">${touching?'‚óè':'~'} ${s.label}</span>`;
        }).join('');
      }
    }

    // Cruce 100/200
    const crEl=document.getElementById(`tcr-${id}`);
    if(crEl&&d.sma100&&d.sma200){
      crEl.innerHTML=d.sma100>d.sma200
        ?'<span style="color:#00e676;font-size:16px" title="Cruce Dorado ‚Äî SMA100 sobre SMA200">‚ñ≤</span>'
        :'<span style="color:#ff4444;font-size:16px" title="Cruce de la Muerte ‚Äî SMA100 bajo SMA200">‚ñº</span>';
    }

    const esEl=document.getElementById(`tes-${id}`);
    if(esEl)esEl.innerHTML=calcularEstado(d);
  }catch(e){}
}

function calcularEstado(d){
  if(d.rsi!=null&&d.rsi>68)return '<span class="badge no_favorable">No ahora</span>';
  let pts=0;
  if(d.rsi!=null){
    if(d.rsi<30)pts+=3;else if(d.rsi<40)pts+=2;else if(d.rsi<50)pts+=1;
  }
  if(d.sma200&&Math.abs(d.price-d.sma200)/d.sma200*100<=0.8)pts+=4;
  else if(d.sma100&&Math.abs(d.price-d.sma100)/d.sma100*100<=0.8)pts+=3;
  else if(d.sma50&&Math.abs(d.price-d.sma50)/d.sma50*100<=0.8)pts+=2;
  else if(d.sma20&&Math.abs(d.price-d.sma20)/d.sma20*100<=0.8)pts+=1;
  if(d.sma200&&d.price<d.sma200)pts+=1;
  if(pts>=5)return '<span class="badge favorable">Favorable</span>';
  if(pts>=3)return '<span class="badge interesante">Interesante</span>';
  if(pts>=2)return '<span class="badge considerar">Considerar</span>';
  return '<span class="badge no_favorable">No ahora</span>';
}

function drawSparkline(id,spk){
  if(!spk||!spk.closes||spk.closes.length<2)return;
  const cvs=document.getElementById(`spark-${id}`);if(!cvs)return;
  const isMobile=window.innerWidth<900,dpr=window.devicePixelRatio||1,W=isMobile?50:80,H=isMobile?18:22;
  cvs.width=W*dpr;cvs.height=H*dpr;
  const ctx=cvs.getContext('2d');ctx.scale(dpr,dpr);
  const closes=spk.closes,mn=Math.min(...closes),mx=Math.max(...closes),rng=mx-mn||1;
  const up=spk.pct>=0,col=up?'#00e676':'#ff4444';
  const pts=closes.map((v,i)=>({x:i/(closes.length-1)*W,y:H-2-(v-mn)/rng*(H-5)}));
  const gr=ctx.createLinearGradient(0,0,0,H);
  gr.addColorStop(0,up?'rgba(0,230,118,.18)':'rgba(255,68,68,.18)');gr.addColorStop(1,'rgba(0,0,0,0)');
  ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fillStyle=gr;ctx.fill();
  ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.stroke();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   VIGILANCIA
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function startWatcher(){checkWatchlist();setInterval(checkWatchlist,5*60*1000);}

async function checkWatchlist(){
  if(watchlist.size===0){setWatchStatus('idle');renderWatchPanel();return;}
  const tickers=[...watchlist].join(',');
  try{
    const r=await fetch(`/api/watch?tickers=${encodeURIComponent(tickers)}`);
    const d=await r.json();
    const now=Date.now();
    (d.alertas||[]).forEach(a=>{
      const m=a.msg.match(/^\[([^\]]+)\]/),t=m?m[1]:'?';
      if(!alertsByTicker[t])alertsByTicker[t]=[];
      const isDup=alertsByTicker[t].some(x=>x.msg===a.msg&&now-x.ts<5*60*1000);
      if(!isDup)alertsByTicker[t].push({msg:a.msg,nivel:a.nivel,ts:now});
    });
    const week=7*24*3600*1000;
    Object.keys(alertsByTicker).forEach(t=>{
      alertsByTicker[t]=alertsByTicker[t].filter(x=>now-x.ts<week);
      if(!alertsByTicker[t].length)delete alertsByTicker[t];
    });
    const total=Object.values(alertsByTicker).reduce((s,a)=>s+a.length,0);
    setWatchStatus(total>0?'alert':'ok');
    renderWatchPanel();
    (d.alertas||[]).forEach(a=>{
      if(!shownToasts.has(a.msg)){shownToasts.add(a.msg);showToast(a.msg,a.nivel);setTimeout(()=>shownToasts.delete(a.msg),2*3600*1000);}
    });
    if(watchlist.has(currentSymbol))renderCurrentAlerts();
  }catch(e){setWatchStatus('err');}
}

function setWatchStatus(s){
  const dot=document.getElementById('watchDot'),lbl=document.getElementById('watchLabel');
  const m={ok:['#00e676','Activa'],alert:['#ff007f','¬°Alerta!'],err:['#555','Error'],idle:['rgba(255,255,255,.15)','En espera']};
  const[c,t]=m[s]||m.ok;dot.style.background=c;lbl.style.color=c;lbl.innerText=t;
}

function toggleWatchPanel(){
  watchPanelOpen=!watchPanelOpen;
  document.getElementById('watchBody').classList.toggle('open',watchPanelOpen);
  document.getElementById('watchBody').classList.toggle('closed',!watchPanelOpen);
  document.getElementById('watchChevron').style.transform=watchPanelOpen?'rotate(0deg)':'rotate(-90deg)';
}

function renderWatchPanel(){
  const emptyEl=document.getElementById('watchEmpty'),listEl=document.getElementById('watch-alerts-list'),countEl=document.getElementById('watchCount');
  if(watchlist.size===0){emptyEl.style.display='block';listEl.innerHTML='';countEl.innerText='';return;}
  emptyEl.style.display='none';
  const now=Date.now(),week=7*24*3600*1000;
  let html='',total=0;
  [...watchlist].forEach(ticker=>{
    const alerts=(alertsByTicker[ticker]||[]).filter(x=>now-x.ts<week);
    if(!alerts.length)return;
    total+=alerts.length;
    html+=`<div style="margin-bottom:6px">
      <div style="font-size:9px;font-weight:800;letter-spacing:.08em;color:rgba(255,255,255,.35);text-transform:uppercase;margin-bottom:3px;display:flex;justify-content:space-between">
        <span>${ticker}</span><span style="color:rgba(255,255,255,.2);font-weight:400">${alerts.length} alerta${alerts.length>1?'s':''}</span></div>`;
    alerts.slice().reverse().forEach(a=>{
      const fechaStr=new Date(a.ts).toLocaleDateString('es-ES',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      html+=`<div class="w-alerta ${a.nivel}" onclick="loadSymbol('${ticker}')">
        <span class="w-ticker">${ticker}</span>${a.msg.replace(/^\[[^\]]+\]\s*/,'')}
        <div style="font-size:8px;opacity:.45;margin-top:2px;display:flex;justify-content:space-between">
          <span>${fechaStr}</span><span>${relTime(a.ts)}</span>
        </div></div>`;
    });
    html+='</div>';
  });
  if(!html)html=`<div style="font-size:10px;color:rgba(255,255,255,.2);padding:4px 0">Sin alertas en los √∫ltimos 7 d√≠as.</div>`;
  listEl.innerHTML=html;
  countEl.innerText=total>0?`${total} alerta${total>1?'s':''} esta semana`:`${watchlist.size} activo${watchlist.size>1?'s':''} vigilados ‚Äî sin alertas`;
}

function relTime(ts){
  const d=Date.now()-ts;
  if(d<60000)return'ahora';if(d<3600000)return`${Math.floor(d/60000)}m`;
  if(d<86400000)return`${Math.floor(d/3600000)}h`;return`${Math.floor(d/86400000)}d`;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   GR√ÅFICO PLOTLY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function fetchData(sym){
  const r=await fetch(`/api/chart/${encodeURIComponent(sym)}?interval=1d`);
  const d=await r.json();if(d.error)throw new Error(d.error);return d;
}

const BG='#07070f';

function renderPlotly(apiData){
  const cd=apiData.chart;
  const dates=cd.candles.map(c=>new Date(c.x));
  const closes=cd.candles.map(c=>c.c);
  const last=closes[closes.length-1]||1;
  const yFmt=last>500?',.0f':last>1?',.2f':',.4f';
  const traces=[];

  // ‚îÄ‚îÄ Doble traza precio (√°rea s√≥lida + l√≠nea brillante, estilo Matrix) ‚îÄ‚îÄ
  traces.push({x:dates,y:closes,type:'scatter',mode:'none',name:'',
    fill:'tozeroy',fillcolor:'rgba(255,255,255,.10)',hoverinfo:'skip',showlegend:false});
  traces.push({x:dates,y:closes,type:'scatter',mode:'lines',name:'Precio 1D',
    line:{color:'rgba(255,255,255,.95)',width:1.8},
    fill:'tozeroy',fillcolor:'rgba(255,255,255,.055)',
    hovertemplate:'<b>%{x|%d %b %Y}</b><br><b>$%{y:,.2f}</b><extra></extra>'});

  const xy=arr=>({xs:arr.map(p=>new Date(p.x)),ys:arr.map(p=>p.y)});

  // ‚îÄ‚îÄ SMAs ‚îÄ‚îÄ
  [{key:'sma20',data:cd.sma20,col:'rgba(0,255,255,.85)',  w:1.2,name:'SMA 20'},
   {key:'sma50',data:cd.sma50,col:'rgba(255,255,0,.85)',  w:1.5,name:'SMA 50'},
   {key:'sma100',data:cd.sma100,col:'rgba(255,200,100,.85)',w:1.8,name:'SMA 100'},
   {key:'sma200',data:cd.sma200,col:'rgba(200,150,220,.9)', w:2.2,name:'SMA 200'},
  ].forEach(s=>{
    if(!indVisible[s.key]||!cd[s.key]||!cd[s.key].length)return;
    const{xs,ys}=xy(cd[s.key]);
    traces.push({x:xs,y:ys,type:'scatter',mode:'lines',name:s.name,
      line:{color:s.col,width:s.w},hovertemplate:`<b>${s.name}</b>: $%{y:,.2f}<extra></extra>`});
  });

  // ‚îÄ‚îÄ SuperTrend ‚îÄ‚îÄ
  if(indVisible.st&&cd.st_buy&&cd.st_sell){
    const stB=xy(cd.st_buy),stS=xy(cd.st_sell);
    if(stB.xs.length)traces.push({x:stB.xs,y:stB.ys,type:'scatter',mode:'markers',name:'ST‚ñ≤',
      marker:{color:'rgba(0,255,100,.8)',size:3,symbol:'circle'},hovertemplate:'ST‚ñ≤: $%{y:,.2f}<extra></extra>'});
    if(stS.xs.length)traces.push({x:stS.xs,y:stS.ys,type:'scatter',mode:'markers',name:'ST‚ñº',
      marker:{color:'rgba(255,50,50,.8)',size:3,symbol:'circle'},hovertemplate:'ST‚ñº: $%{y:,.2f}<extra></extra>'});
  }

  // ‚îÄ‚îÄ RSI markers ‚îÄ‚îÄ
  if(indVisible.rsi&&cd.rsi_os&&cd.rsi_ob){
    const ros=xy(cd.rsi_os),rob=xy(cd.rsi_ob);
    if(ros.xs.length)traces.push({x:ros.xs,y:ros.ys,type:'scatter',mode:'markers',name:'RSI<30',
      marker:{color:'#00e676',size:12,symbol:'triangle-up',line:{color:'#07070f',width:1.5}},
      hovertemplate:'üü¢ RSI Sobreventa<br>$%{y:,.2f}<extra></extra>'});
    if(rob.xs.length)traces.push({x:rob.xs,y:rob.ys,type:'scatter',mode:'markers',name:'RSI>70',
      marker:{color:'#ff007f',size:12,symbol:'triangle-down',line:{color:'#07070f',width:1.5}},
      hovertemplate:'üî¥ RSI Sobrecompra<br>$%{y:,.2f}<extra></extra>'});
  }

  // ‚îÄ‚îÄ Smart Y-range: escala solo a las velas visibles (de Matrix) ‚îÄ‚îÄ
  const calcYRange=(xRange)=>{
    const x0=new Date(xRange[0]).getTime(),x1=new Date(xRange[1]).getTime();
    const vis=cd.candles.filter(c=>c.x>=x0&&c.x<=x1);
    if(!vis.length)return null;
    let mn=Math.min(...vis.map(c=>c.l||c.c)),mx=Math.max(...vis.map(c=>c.h||c.c));
    // Incluir SMAs visibles
    ['sma20','sma50','sma100','sma200'].forEach(k=>{
      if(!cd[k])return;
      cd[k].forEach(p=>{if(p.x>=x0&&p.x<=x1){mn=Math.min(mn,p.y);mx=Math.max(mx,p.y);}});
    });
    const pad=(mx-mn)*0.08;
    return[mn-pad,mx+pad];
  };

  const layout={
    paper_bgcolor:BG,plot_bgcolor:'#0a0a12',margin:{t:12,r:70,b:50,l:50},
    hovermode:'x unified',
    hoverlabel:{bgcolor:'rgba(10,10,22,.95)',bordercolor:'rgba(255,255,255,.1)',font:{family:'Space Mono,monospace',size:11,color:'#e0e0e0'}},
    showlegend:false,
    xaxis:{type:'date',gridcolor:'rgba(255,255,255,.03)',linecolor:'rgba(255,255,255,.06)',
      tickfont:{color:'rgba(255,255,255,.4)',size:9},showspikes:true,spikecolor:'rgba(255,255,255,.1)',
      spikedash:'dot',spikethickness:1,rangeslider:{visible:false}},
    yaxis:{gridcolor:'rgba(255,255,255,.03)',linecolor:'rgba(255,255,255,.06)',
      tickfont:{color:'rgba(255,255,255,.4)',size:9},side:'right',tickformat:yFmt},
    dragmode:'pan',font:{family:'Syne,sans-serif'}
  };

  // ‚îÄ‚îÄ Rango X: 2 meses por defecto (ETF=1D, m√°s contexto que Matrix) ‚îÄ‚îÄ
  const xEnd=dates[dates.length-1];
  const xStart2m=xEnd?new Date(xEnd.getTime()-60*24*60*60*1000):null;
  const xRangeToUse=savedXRange||(xStart2m?[xStart2m.toISOString(),xEnd.toISOString()]:null);
  if(xRangeToUse)layout.xaxis.range=xRangeToUse;

  const yRange=xRangeToUse?calcYRange(xRangeToUse):null;
  if(yRange)layout.yaxis.range=yRange;

  Plotly.react('plotDiv',traces,layout,{responsive:true,scrollZoom:true,displayModeBar:false,doubleClick:'reset'});

  // Guardar rango + recalcular Y al hacer pan/zoom
  const div=document.getElementById('plotDiv');
  if(div._relayoutHandler)div.removeListener('plotly_relayout',div._relayoutHandler);
  div._relayoutHandler=ed=>{
    if(ed['xaxis.range[0]']&&ed['xaxis.range[1]']){
      savedXRange=[ed['xaxis.range[0]'],ed['xaxis.range[1]']];
      const yr=calcYRange(savedXRange);
      if(yr)Plotly.relayout('plotDiv',{'yaxis.range':yr});
    }else if(ed['xaxis.autorange']===true){
      savedXRange=null;
    }
  };
  div.on('plotly_relayout',div._relayoutHandler);

  const rsiWrap=document.getElementById('rsiWrap');
  if(indVisible.rsi){rsiWrap.style.display='block';renderRSIPanel(cd,dates);}
  else{rsiWrap.style.display='none';}
}

function renderRSIPanel(cd,dates){
  const closes=cd.candles.map(c=>c.c).filter(v=>v!=null);
  const rsiDates=cd.candles.map(c=>new Date(c.x));
  const period=14,rsiVals=new Array(closes.length).fill(null);
  if(closes.length>period){
    let gains=0,losses=0;
    for(let i=1;i<=period;i++){const d=closes[i]-closes[i-1];if(d>=0)gains+=d;else losses-=d;}
    let avgGain=gains/period,avgLoss=losses/period;
    rsiVals[period]=avgLoss===0?100:100-(100/(1+avgGain/avgLoss));
    for(let i=period+1;i<closes.length;i++){
      const d=closes[i]-closes[i-1];
      avgGain=(avgGain*(period-1)+Math.max(d,0))/period;
      avgLoss=(avgLoss*(period-1)+Math.max(-d,0))/period;
      rsiVals[i]=avgLoss===0?100:100-(100/(1+avgGain/avgLoss));
    }
  }
  const xNorm=[],yNorm=[];
  rsiDates.forEach((d,i)=>{const v=rsiVals[i];if(v==null)return;xNorm.push(d);yNorm.push(v);});
  const d0=rsiDates[0]||new Date(),dN=rsiDates[rsiDates.length-1]||new Date();

  Plotly.react('rsiDiv',[
    {x:xNorm,y:yNorm.map(v=>v!=null&&v<30?v:null),type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',line:{color:'transparent',width:0},fill:'tozeroy',fillcolor:'rgba(0,230,118,.12)'},
    {x:xNorm,y:yNorm.map(v=>v!=null&&v>70?v:null),type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',fill:'toself',fillcolor:'rgba(255,0,127,.10)',line:{color:'transparent',width:0}},
    {x:xNorm,y:yNorm,type:'scatter',mode:'lines',name:'RSI 14',line:{color:'rgba(180,130,220,.9)',width:1.5},hovertemplate:'<b>RSI</b>: %{y:.1f}<extra></extra>'},
    {x:[d0,dN],y:[30,30],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',line:{color:'rgba(0,230,118,.5)',width:1,dash:'dot'}},
    {x:[d0,dN],y:[70,70],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',line:{color:'rgba(255,0,127,.5)',width:1,dash:'dot'}},
    {x:[d0,dN],y:[50,50],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',line:{color:'rgba(255,255,255,.08)',width:1,dash:'dot'}},
  ],{
    paper_bgcolor:BG,plot_bgcolor:'rgba(255,255,255,.01)',margin:{t:8,r:70,b:40,l:50},showlegend:false,
    xaxis:{type:'date',gridcolor:'rgba(255,255,255,.03)',linecolor:'rgba(255,255,255,.05)',tickfont:{color:'rgba(255,255,255,.3)',size:9},rangeslider:{visible:false}},
    yaxis:{range:[0,100],gridcolor:'rgba(255,255,255,.03)',tickfont:{color:'rgba(255,255,255,.2)',size:8},side:'right',tickvals:[0,30,50,70,100]},
    shapes:[
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:0,y1:30,fillcolor:'rgba(0,230,118,.04)',line:{width:0}},
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:70,y1:100,fillcolor:'rgba(255,0,127,.04)',line:{width:0}}
    ],font:{family:'Syne,sans-serif'},dragmode:'pan'
  },{responsive:true,scrollZoom:false,displayModeBar:false});
}

function toggleInd(key){
  indVisible[key]=!indVisible[key];
  document.getElementById('tog-'+key).classList.toggle('off',!indVisible[key]);
  if(lastData)renderPlotly(lastData);
}

function zoomChart(factor){
  const div=document.getElementById('plotDiv');
  if(!div||!div.layout||!div.layout.xaxis)return;
  const xr=div.layout.xaxis.range;if(!xr||xr.length<2)return;
  const s=new Date(xr[0]).getTime(),e=new Date(xr[1]).getTime();
  const center=(s+e)/2,half=((e-s)/2)/factor;
  savedXRange=[new Date(center-half).toISOString(),new Date(center+half).toISOString()];
  Plotly.relayout('plotDiv',{'xaxis.range':savedXRange});
}

function resetZoom2m(){
  if(!lastData)return;
  const dates=lastData.chart.candles.map(c=>new Date(c.x));
  const ld=dates[dates.length-1];
  if(!ld)return;
  savedXRange=[new Date(ld.getTime()-60*24*60*60*1000).toISOString(),ld.toISOString()];
  renderPlotly(lastData);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CARGA S√çMBOLO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadSymbol(sym){
  currentSymbol=sym;savedXRange=null;
  document.getElementById('symbolInput').value=sym;
  document.querySelectorAll('.asset-row').forEach(r=>r.classList.remove('active-sym'));
  const el=document.getElementById('fc-'+favId(sym));if(el)el.classList.add('active-sym');
  document.getElementById('loadWrap').style.display='flex';
  try{
    const data=await fetchData(sym);
    lastData=data;
    document.getElementById('loadWrap').style.display='none';
    if(document.getElementById('chartBody').style.display!=='none')renderPlotly(data);
    updateSidebar(data);
    renderCurrentAlerts();
  }catch(e){
    document.getElementById('loadWrap').style.display='none';
    showToast('‚ùå '+e.message,'bearish');
  }
}

function renderCurrentAlerts(){
  const fromWatch=watchlist.has(currentSymbol)?(alertsByTicker[currentSymbol]||[]):[];
  const fromData=lastData?(lastData.alertas||[]):[];
  const all=fromWatch.length?fromWatch.map(a=>({msg:a.msg,nivel:a.nivel})):fromData;
  renderAlertas(all);
}

function doSearch(){const s=document.getElementById('symbolInput').value.trim().toUpperCase();if(s)loadSymbol(s);}

function abrirTradingView(){
  const map={
    '^DJI':'DJ:DJI','^NDX':'NASDAQ:NDX','^GSPC':'SP:SPX','^RUT':'TVC:RUT',
    'YM=F':'CME_MINI:YM1!','NQ=F':'CME_MINI:NQ1!','GC=F':'TVC:GOLD','SI=F':'TVC:SILVER','CL=F':'TVC:USOIL',
    'USDJPY=X':'FX:USDJPY','GBPJPY=X':'FX:GBPJPY','EURUSD=X':'FX:EURUSD','AUDUSD=X':'FX:AUDUSD',
    '^TNX':'TVC:US10Y','^TYX':'TVC:US20Y','DX=F':'TVC:DXY',
    'BTC-USD':'BINANCE:BTCUSDT','ETH-USD':'BINANCE:ETHUSDT',
    'SPY':'AMEX:SPY','VOO':'AMEX:VOO','VTI':'AMEX:VTI','QQQ':'NASDAQ:QQQ','QQQM':'NASDAQ:QQQM',
    'GLD':'AMEX:GLD','IAU':'AMEX:IAU','GDX':'AMEX:GDX','IWM':'AMEX:IWM','SMH':'NASDAQ:SMH',
    'XLE':'AMEX:XLE','SCHD':'NASDAQ:SCHD','SCHG':'NASDAQ:SCHG','VGT':'AMEX:VGT',
    'EEM':'AMEX:EEM','DIA':'AMEX:DIA','AAPL':'NASDAQ:AAPL',
  };
  window.open(`https://www.tradingview.com/chart/?symbol=${encodeURIComponent(map[currentSymbol]||currentSymbol)}`,'_blank');
}

function updateSidebar(data){
  document.getElementById('dispSym').innerText=DISPLAY_NAMES[currentSymbol]||currentSymbol;
  document.getElementById('dispPrice').innerText=formatPrice(data.last_price);
  const chEl=document.getElementById('dispChange'),pre=data.change>=0?'+':'';
  chEl.innerText=`${pre}${data.change.toFixed(2)} (${pre}${data.change_pct.toFixed(2)}%)`;
  chEl.style.color=data.change>=0?'#00e676':'#ff4444';
  updateRSI(data.rsi_current);
  document.getElementById('alertSymLabel').innerText=currentSymbol;
}

function updateRSI(v){
  v=parseFloat(v);if(isNaN(v))return;
  document.getElementById('rsiVal').innerText=v.toFixed(1);
  document.getElementById('rsiCursor').style.left=`calc(${Math.min(Math.max(v,0),100)}% - 5px)`;
  const lbl=document.getElementById('rsiLbl'),val=document.getElementById('rsiVal');
  if(v<30){lbl.innerText='SV';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(0,230,118,.12);color:#00e676;font-weight:700';val.style.color='#00e676';}
  else if(v>70){lbl.innerText='SC';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,68,68,.12);color:#ff5252;font-weight:700';val.style.color='#ff5252';}
  else{lbl.innerText='N';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);font-weight:700';val.style.color='#fff';}
}

function renderAlertas(alertas){
  const box=document.getElementById('alertBox'),list=document.getElementById('alertList');
  if(!alertas||!alertas.length){box.style.display='none';return;}
  box.style.display='block';
  list.innerHTML=alertas.map(a=>`<div class="alerta-item ${a.nivel}">${a.msg.replace(/^\[[^\]]+\]\s*/,'')}</div>`).join('');
}

function showToast(msg,nivel,ms=6000){
  const c=document.getElementById('toasts'),t=document.createElement('div');
  t.className=`toast ${nivel}`;t.innerText=msg;c.appendChild(t);setTimeout(()=>t.remove(),ms);
}
</script>
</body>
</html>
