<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Expande Tu Futuro</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€ RESET & BASE â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{-webkit-text-size-adjust:100%}
body{font-family:'Inter',sans-serif;background:#07070f;color:#e0e0e0;
  min-height:100vh;overflow-x:hidden;width:100%}
.mono{font-family:'JetBrains Mono',monospace}
.card{background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.07);border-radius:14px}

/* â”€â”€ WRAPPER â”€â”€ */
#app{width:100%;max-width:1600px;margin:0 auto;
  padding:10px 12px;display:flex;flex-direction:column;gap:10px}

/* â”€â”€ HEADER â”€â”€ */
#hdr{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
#hdr-logo{width:30px;height:30px;border-radius:9px;background:#ff007f;
  box-shadow:0 0 14px rgba(255,0,127,.4);display:flex;align-items:center;
  justify-content:center;flex-shrink:0}
#hdr-title{font-size:14px;font-weight:800;letter-spacing:-.2px;white-space:nowrap}
#hdr-search{display:flex;align-items:center;gap:6px;flex:1;min-width:0}
#symbolInput{flex:1;min-width:0;background:#111;border:1px solid rgba(255,255,255,.1);
  border-radius:9px;padding:8px 12px;font-size:13px;color:#e0e0e0;
  font-family:'Inter',sans-serif;transition:border-color .2s;width:100%}
#symbolInput:focus{outline:none;border-color:rgba(255,0,127,.5)}
#btnSearch{padding:8px 14px;border-radius:9px;background:#ff007f;color:#fff;
  font-size:13px;font-weight:700;border:none;cursor:pointer;
  font-family:'Inter',sans-serif;white-space:nowrap;flex-shrink:0}

/* â”€â”€ MAIN LAYOUT: mobile=col, desktop=row â”€â”€ */
#main{display:flex;flex-direction:column;gap:10px;width:100%}
@media(min-width:900px){
  #main{display:grid;grid-template-columns:170px 1fr;align-items:flex-start}
  #sidebar{width:170px}
  #chart-card{width:100%;min-width:0}
}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{display:flex;flex-direction:column;gap:8px;width:100%}

/* Precio widget */
#price-widget{padding:13px}
#dispSym{font-size:10px;font-weight:800;letter-spacing:.12em;color:#ff007f;margin-bottom:2px}
#dispPrice{font-size:20px;font-weight:700;line-height:1.2;color:#fff}
#dispChange{font-size:11px;margin-top:4px;font-weight:600}
#rsiRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
#rsiBar{height:5px;border-radius:3px;position:relative;margin-top:5px;
  background:linear-gradient(to right,
    rgba(0,230,118,.4) 0%,rgba(0,230,118,.4) 30%,
    rgba(255,255,255,.06) 30%,rgba(255,255,255,.06) 70%,
    rgba(255,68,68,.4) 70%,rgba(255,68,68,.4) 100%)}
#rsiCursor{position:absolute;top:50%;width:10px;height:10px;border-radius:50%;
  background:#fff;box-shadow:0 0 5px rgba(255,255,255,.5);
  transform:translate(-50%,-50%);transition:left .4s;left:50%}

/* Vigilancia panel */
#watch-panel{padding:11px}
#watch-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
#watchDot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);
  display:inline-block;flex-shrink:0}
#watch-alerts-list{display:flex;flex-direction:column;gap:5px;
  max-height:260px;overflow-y:auto}
.w-alerta{padding:6px 9px;border-radius:8px;font-size:10px;font-weight:500;line-height:1.45;
  cursor:pointer;transition:filter .15s}
.w-alerta:hover{filter:brightness(1.3)}
.w-alerta .w-ticker{font-weight:800;font-size:10px;margin-right:4px}
.w-alerta.bullish{background:rgba(0,230,118,.07);color:#00e676}
.w-alerta.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.w-alerta.info{background:rgba(255,0,127,.07);color:#ff69b4}

/* Alertas sÃ­mbolo activo */
#alertBox{padding:11px;display:none}
.alerta-item{padding:5px 9px;border-radius:7px;font-size:10px;font-weight:500;line-height:1.4}
.alerta-item.bullish{background:rgba(0,230,118,.07);color:#00e676}
.alerta-item.bearish{background:rgba(255,68,68,.07);color:#ff5252}
.alerta-item.info{background:rgba(255,0,127,.07);color:#ff69b4}

/* â”€â”€ CHART CARD â”€â”€ */
#chart-card{padding:13px;display:flex;flex-direction:column;gap:9px;width:100%}
#chartArea{width:100%;margin:0 auto}

/* Controles barra: indicadores */
#ind-bar{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.btn-ind{padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;
  transition:all .15s;border:1px solid transparent;font-family:'Inter',sans-serif;
  white-space:nowrap}
.btn-ind.off{opacity:.25;filter:grayscale(.7)}

/* â”€â”€ CHART HEIGHTS â€” misma config que Matrix Lab â”€â”€ */
#plotDiv{width:100%;height:min(120vw,600px)}
#rsiWrap{display:block}
#rsiDiv{width:100%;height:min(30vw,150px)}
@media(min-width:900px){
  #plotDiv{height:750px}
  #rsiDiv{height:180px}
}

/* Loading â€” overlay sobre el grÃ¡fico */
#loadWrap{display:none;position:absolute;inset:0;align-items:center;justify-content:center;
  flex-direction:column;gap:12px;color:rgba(255,255,255,.3);
  background:rgba(7,7,15,.75);z-index:10;border-radius:14px}
.spin{width:32px;height:32px;border:3px solid rgba(255,0,127,.15);
  border-top-color:#ff007f;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ TABLA DE ACTIVOS â”€â”€ */
#favs-panel{padding:0;overflow:hidden}
#favs-hdr{display:flex;align-items:center;justify-content:space-between;cursor:pointer;
  user-select:none;background:none;border:none;width:100%;color:inherit;
  font-family:'Inter',sans-serif;padding:14px 16px}
.acc-body{overflow:hidden;transition:max-height .35s ease,opacity .25s ease}
.acc-body.closed{max-height:0!important;opacity:0;pointer-events:none}
.acc-body.open{max-height:5000px;opacity:1}

/* Tabla */
#assetsTable{width:100%;border-collapse:collapse;min-width:750px}
#assetsTable thead tr{border-bottom:1px solid rgba(255,255,255,.07)}
#assetsTable thead th{
  padding:8px 12px;
  text-align:left;
  font-size:10px;font-weight:700;
  letter-spacing:.08em;color:rgba(255,255,255,.3);
  text-transform:uppercase;white-space:nowrap;
  background:#07070f;
  position:sticky;top:0;z-index:2}
#assetsTable thead th.right{text-align:right}
#assetsTable thead th.center{text-align:center}

.asset-row{border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;transition:background .12s}
.asset-row:hover{background:rgba(255,255,255,.03)!important}
.asset-row.active-sym{background:rgba(255,0,127,.04)!important;border-left:3px solid #ff007f}
.asset-row td{padding:9px 12px;white-space:nowrap;vertical-align:middle}

/* Estrella vigilancia */
.fav-star{font-size:13px;cursor:pointer;user-select:none;transition:transform .15s;line-height:1}
.fav-star.watching{color:#ff007f;text-shadow:0 0 8px rgba(255,0,127,.6)}
.fav-star.idle{color:rgba(255,255,255,.14)}
.fav-star:hover{transform:scale(1.4)}

/* Indicador SMA flecha */
.sma-arrow{font-size:12px;font-weight:700}
.sma-arrow.up{color:#00e676}
.sma-arrow.dn{color:#ff4444}

/* â”€â”€ TOASTS â”€â”€ */
#toasts{position:fixed;top:12px;right:12px;z-index:9999;
  display:flex;flex-direction:column;gap:7px;pointer-events:none;max-width:calc(100vw - 24px)}
.toast{padding:9px 14px;border-radius:10px;font-size:12px;font-weight:500;
  pointer-events:auto;animation:fadeIn .25s ease;line-height:1.45;word-break:break-word}
.toast.bullish{background:rgba(0,230,118,.13);color:#00e676;border:1px solid rgba(0,230,118,.25)}
.toast.bearish{background:rgba(255,68,68,.13);color:#ff5252;border:1px solid rgba(255,68,68,.25)}
.toast.info{background:rgba(255,0,127,.13);color:#ff69b4;border:1px solid rgba(255,0,127,.25)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}

::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
</style>
</head>
<body>
<div id="app">

  <!-- HEADER -->
  <div id="hdr">
    <div id="hdr-logo">
      <svg width="15" height="15" fill="none" stroke="#fff" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
              d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
      </svg>
    </div>
    <span id="hdr-title">EXPANDE <span style="color:#ff007f">TU FUTURO</span></span>
    <div id="hdr-search">
      <input id="symbolInput" type="text" placeholder="AAPL Â· BTC-USD Â· ^GSPC Â· SPYâ€¦"
             autocomplete="off" autocorrect="off" autocapitalize="off"
             onkeydown="if(event.key==='Enter')doSearch()">
      <button id="btnSearch" onclick="doSearch()">Buscar</button>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">

    <!-- SIDEBAR -->
    <div id="sidebar">

      <!-- Precio + RSI -->
      <div class="card" id="price-widget">
        <div id="dispSym">---</div>
        <div id="dispPrice" class="mono">---</div>
        <div id="dispChange">--</div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.05)">
          <div id="rsiRow">
            <span style="font-size:10px;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:.08em">RSI 14</span>
            <div style="display:flex;align-items:center;gap:4px">
              <span id="rsiVal" class="mono" style="font-size:13px;font-weight:700">--</span>
              <span id="rsiLbl" style="font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;
                background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">--</span>
            </div>
          </div>
          <div id="rsiBar"><div id="rsiCursor"></div></div>
        </div>
      </div>

      <!-- Alertas sÃ­mbolo activo -->
      <div id="alertBox" class="card">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;
          color:rgba(255,255,255,.2);font-weight:700;margin-bottom:6px">
          âš¡ Alertas â€” <span id="alertSymLabel" style="color:#ff007f"></span></div>
        <div id="alertList" style="display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto"></div>
      </div>

      <!-- VIGILANCIA -->
      <div class="card" id="watch-panel">
        <div id="watch-hdr">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:11px;font-weight:700">ğŸ”” Vigilancia</span>
            <span id="watchDot"></span>
          </div>
          <span id="watchLabel" style="font-size:10px;font-weight:600;color:rgba(255,255,255,.2)">--</span>
        </div>
        <div id="watchEmpty" style="font-size:10px;line-height:1.6;color:rgba(255,255,255,.2)">
          Marca â˜… en cualquier activo para aÃ±adirlo. Alertas cuando precio toca SMA o cruzan SMA100/SMA200.
        </div>
        <div id="watch-alerts-list"></div>
        <div id="watchCount" style="font-size:10px;margin-top:6px;color:rgba(255,0,127,.5);font-weight:600"></div>
      </div>

    </div><!-- /sidebar -->

    <!-- CHART CARD -->
    <div class="card" id="chart-card" style="position:relative">

      <!-- Barra de indicadores â€” igual que Matrix Lab con botones zoom -->
      <div id="ind-bar">
        <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
          color:rgba(255,255,255,.18);font-weight:700;margin-right:2px">Ind:</span>
        <button class="btn-ind" id="tog-sma20"
          style="background:rgba(0,255,255,.1);color:#00ffff;border-color:rgba(0,255,255,.3)"
          onclick="toggleInd('sma20')">SMA20</button>
        <button class="btn-ind" id="tog-sma50"
          style="background:rgba(255,255,0,.1);color:#ffff00;border-color:rgba(255,255,0,.3)"
          onclick="toggleInd('sma50')">SMA50</button>
        <button class="btn-ind" id="tog-sma100"
          style="background:rgba(255,200,100,.1);color:#ffc864;border-color:rgba(255,200,100,.3)"
          onclick="toggleInd('sma100')">SMA100</button>
        <button class="btn-ind" id="tog-sma200"
          style="background:rgba(200,150,220,.1);color:#c896dc;border-color:rgba(200,150,220,.3)"
          onclick="toggleInd('sma200')">SMA200</button>
        <button class="btn-ind off" id="tog-st"
          style="background:rgba(0,255,100,.1);color:#00e676;border-color:rgba(0,255,100,.3)"
          onclick="toggleInd('st')">SuperT</button>
        <button class="btn-ind off" id="tog-rsi"
          style="background:rgba(255,0,127,.1);color:#ff69b4;border-color:rgba(255,0,127,.3)"
          onclick="toggleInd('rsi')">RSI</button>
        <!-- Botones zoom â€” igual que Matrix Lab -->
        <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
          <button class="btn-ind" onclick="zoomChart(1.2)"
            style="background:rgba(255,255,255,.05);color:#fff;padding:4px 10px;font-size:14px">+</button>
          <button class="btn-ind" onclick="zoomChart(0.8)"
            style="background:rgba(255,255,255,.05);color:#fff;padding:4px 10px;font-size:14px">-</button>
          <span style="font-size:9px;color:rgba(255,255,255,.2);white-space:nowrap;margin-left:4px">
            Doble clic reset
          </span>
        </div>
      </div>

      <!-- Loading -->
      <div id="loadWrap" style="display:none;position:absolute;inset:0;display:none;
        align-items:center;justify-content:center;flex-direction:column;gap:12px;
        color:rgba(255,255,255,.3);background:rgba(7,7,15,.75);z-index:10;border-radius:14px">
        <div class="spin"></div>
        <span style="font-size:12px">Cargandoâ€¦</span>
      </div>

      <!-- GrÃ¡ficas -->
      <div id="chartArea" style="display:flex;flex-direction:column">
        <div id="plotDiv"></div>
        <div id="rsiWrap">
          <div style="padding:3px 60px 1px 8px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;
              color:rgba(255,255,255,.18);font-weight:700">RSI seÃ±ales extremas</span>
            <span style="font-size:9px;color:rgba(255,255,255,.2)">
              <span style="color:rgba(0,230,118,.8)">â–²&lt;30</span>
              &nbsp;
              <span style="color:rgba(255,0,127,.8)">â–¼&gt;70</span>
            </span>
          </div>
          <div id="rsiDiv"></div>
        </div>
      </div>

    </div><!-- /chart-card -->

  </div><!-- /main -->

  <!-- TABLA DE ACTIVOS -->
  <div class="card" id="favs-panel">
    <button id="favs-hdr" onclick="toggleFavs()">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:#ff007f;font-size:14px">â˜…</span>
        <span style="font-size:13px;font-weight:700">Todos los activos</span>
        <span id="favCount" style="font-size:10px;color:rgba(255,255,255,.25)"></span>
        <span id="watchingCount" style="font-size:10px;color:#ff007f;font-weight:700"></span>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:10px;color:rgba(255,255,255,.18)">â˜… vigilancia Â· clic fila = grÃ¡fico</span>
        <span id="favChevron" style="color:rgba(255,255,255,.3);font-size:11px;
          transition:transform .3s;display:inline-block;transform:rotate(-90deg)">â–¼</span>
      </div>
    </button>

    <div id="favBody" class="acc-body closed">
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
        <table id="assetsTable">
          <thead>
            <tr>
              <th>â˜… Activo</th>
              <th class="right">Precio</th>
              <th class="right">Cambio %</th>
              <th class="center">RSI 14</th>
              <th class="center">SMA20</th>
              <th class="center">SMA50</th>
              <th class="center">SMA100</th>
              <th class="center">SMA200</th>
              <th class="center">Cruce 100/200</th>
              <th class="center">Tendencia</th>
            </tr>
          </thead>
          <tbody id="favItems"></tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /app -->
<div id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATÃLOGO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_ASSETS = [
  {name:'Bitcoin',    ticker:'BTC-USD', cat:'ğŸª™'},
  {name:'Ethereum',   ticker:'ETH-USD', cat:'ğŸª™'},
  {name:'S&P 500',    ticker:'^GSPC',   cat:'ğŸ“Š'},
  {name:'Nasdaq 100', ticker:'^NDX',    cat:'ğŸ“Š'},
  {name:'Dow Jones',  ticker:'^DJI',    cat:'ğŸ“Š'},
  {name:'Russell 2K', ticker:'^RUT',    cat:'ğŸ“Š'},
  {name:'SPY',        ticker:'SPY',     cat:'ETF'},
  {name:'VOO',        ticker:'VOO',     cat:'ETF'},
  {name:'VTI',        ticker:'VTI',     cat:'ETF'},
  {name:'QQQ',        ticker:'QQQ',     cat:'ETF'},
  {name:'QQQM',       ticker:'QQQM',    cat:'ETF'},
  {name:'SPMO',       ticker:'SPMO',    cat:'ETF'},
  {name:'JEPQ',       ticker:'JEPQ',    cat:'ETF'},
  {name:'ITOT',       ticker:'ITOT',    cat:'ETF'},
  {name:'SCHD',       ticker:'SCHD',    cat:'ETF'},
  {name:'SCHG',       ticker:'SCHG',    cat:'ETF'},
  {name:'VGT',        ticker:'VGT',     cat:'ETF'},
  {name:'VHT',        ticker:'VHT',     cat:'ETF'},
  {name:'VFH',        ticker:'VFH',     cat:'ETF'},
  {name:'VEA',        ticker:'VEA',     cat:'ETF'},
  {name:'VTV',        ticker:'VTV',     cat:'ETF'},
  {name:'VTWO',       ticker:'VTWO',    cat:'ETF'},
  {name:'IWM',        ticker:'IWM',     cat:'ETF'},
  {name:'XLE',        ticker:'XLE',     cat:'ETF'},
  {name:'SMH',        ticker:'SMH',     cat:'ETF'},
  {name:'RSP',        ticker:'RSP',     cat:'ETF'},
  {name:'EEM',        ticker:'EEM',     cat:'ETF'},
  {name:'ILF',        ticker:'ILF',     cat:'ETF'},
  {name:'DIA',        ticker:'DIA',     cat:'ETF'},
  {name:'IOO',        ticker:'IOO',     cat:'ETF'},
  {name:'SPYM',       ticker:'SPYM',    cat:'ETF'},
  {name:'FEPI',       ticker:'FEPI',    cat:'ETF'},
  {name:'GLD',        ticker:'GLD',     cat:'ğŸ¥‡'},
  {name:'IAU',        ticker:'IAU',     cat:'ğŸ¥‡'},
  {name:'GDX',        ticker:'GDX',     cat:'ğŸ¥‡'},
  {name:'UGL',        ticker:'UGL',     cat:'ğŸ¥‡'},
  {name:'COPX',       ticker:'COPX',    cat:'â›ï¸'},
  {name:'REMX',       ticker:'REMX',    cat:'â›ï¸'},
  {name:'URNM',       ticker:'URNM',    cat:'âš›ï¸'},
  {name:'URA',        ticker:'URA',     cat:'âš›ï¸'},
  {name:'Apple',      ticker:'AAPL',    cat:'ğŸ’¼'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSymbol  = 'BTC-USD';
let favsOpen       = false;
// SuperT y RSI desactivados por defecto (igual que Matrix Lab)
let indVisible     = {sma20:true, sma50:true, sma100:true, sma200:true, st:false, rsi:false};
let lastData       = null;
let watchlist      = new Set();
let alertsByTicker = {};
let shownToasts    = new Set();

function saveWL(){ try{localStorage.setItem('etf_wl',JSON.stringify([...watchlist]))}catch(e){} }
function loadWL(){ try{const s=localStorage.getItem('etf_wl');if(s)watchlist=new Set(JSON.parse(s))}catch(e){} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = () => {
  loadWL();
  document.getElementById('favCount').innerText = `â€” ${ALL_ASSETS.length} activos`;
  buildFavGrid();
  updateWatchingCount();
  loadSymbol('BTC-USD');
  startWatcher();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLA DE ACTIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function favId(t){ return 'f_'+t.replace(/[^a-z0-9]/gi,'_'); }

function buildFavGrid(){
  const tbody = document.getElementById('favItems');
  tbody.innerHTML = '';
  ALL_ASSETS.forEach(f => {
    const id  = favId(f.ticker);
    const isW = watchlist.has(f.ticker);
    const tr  = document.createElement('tr');
    tr.id        = 'fc-'+id;
    tr.className = 'asset-row';
    tr.onclick   = e => { if(e.target.closest('.fav-star'))return; loadSymbol(f.ticker); };

    tr.innerHTML = `
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="fav-star ${isW?'watching':'idle'}" id="star-${id}"
            onclick="toggleWatch('${f.ticker}',event)">â˜…</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:#e0e0e0">${f.ticker}</div>
            <div style="font-size:10px;color:rgba(255,255,255,.3)">${f.cat} ${f.name}</div>
          </div>
        </div>
      </td>
      <td style="text-align:right">
        <span id="tp-${id}" class="mono" style="font-size:12px;font-weight:600;color:#fff">â€”</span>
      </td>
      <td style="text-align:right">
        <span id="tc-${id}" style="font-size:12px;font-weight:700;color:rgba(255,255,255,.3)">â€”</span>
      </td>
      <td style="text-align:center">
        <span id="tr-${id}" style="font-size:11px;font-weight:700;padding:2px 7px;
          border-radius:5px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">â€”</span>
      </td>
      <td style="text-align:center"><span id="ts20-${id}"  class="sma-arrow">â€”</span></td>
      <td style="text-align:center"><span id="ts50-${id}"  class="sma-arrow">â€”</span></td>
      <td style="text-align:center"><span id="ts100-${id}" class="sma-arrow">â€”</span></td>
      <td style="text-align:center"><span id="ts200-${id}" class="sma-arrow">â€”</span></td>
      <td style="text-align:center">
        <span id="tcr-${id}" style="font-size:11px;font-weight:700;color:rgba(255,255,255,.25)">â€”</span>
      </td>
      <td style="text-align:center">
        <span id="tst-${id}" style="font-size:11px;font-weight:700;color:rgba(255,255,255,.25)">â€”</span>
      </td>`;
    tbody.appendChild(tr);
  });
}

function refreshStars(){
  ALL_ASSETS.forEach(f => {
    const star = document.getElementById('star-'+favId(f.ticker));
    if(!star) return;
    const isW = watchlist.has(f.ticker);
    star.className = 'fav-star '+(isW?'watching':'idle');
  });
}

function toggleWatch(ticker, e){
  e.stopPropagation();
  if(watchlist.has(ticker)){
    watchlist.delete(ticker);
    showToast(`Eliminado de vigilancia: ${ticker}`, 'info', 2500);
  } else {
    watchlist.add(ticker);
    showToast(`â­ ${ticker} aÃ±adido a vigilancia`, 'info', 2500);
  }
  saveWL(); refreshStars(); updateWatchingCount(); renderWatchPanel();
}

function updateWatchingCount(){
  const n = watchlist.size;
  document.getElementById('watchingCount').innerText = n>0 ? `â€” ${n} â˜…` : '';
  document.getElementById('watchCount').innerText    = n>0 ? `${n} activo${n>1?'s':''} en vigilancia` : '';
}

async function loadRowData(ticker){
  try {
    const r = await fetch(`/api/row/${encodeURIComponent(ticker)}`);
    const d = await r.json();
    if(d.error) return;
    const id = favId(ticker);

    const priceEl = document.getElementById(`tp-${id}`);
    if(priceEl) priceEl.innerText = d.price > 100
      ? d.price.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})
      : d.price.toFixed(4);

    const chEl = document.getElementById(`tc-${id}`);
    if(chEl){
      const up = d.change_pct >= 0;
      chEl.innerText = `${up?'+':''}${d.change_pct.toFixed(2)}%`;
      chEl.style.color = up ? '#00e676' : '#ff4444';
    }

    const rsiEl = document.getElementById(`tr-${id}`);
    if(rsiEl && d.rsi != null){
      rsiEl.innerText = d.rsi.toFixed(1);
      if(d.rsi < 30){ rsiEl.style.background='rgba(0,230,118,.15)'; rsiEl.style.color='#00e676'; }
      else if(d.rsi > 70){ rsiEl.style.background='rgba(255,68,68,.15)'; rsiEl.style.color='#ff5252'; }
      else { rsiEl.style.background='rgba(255,255,255,.06)'; rsiEl.style.color='rgba(255,255,255,.5)'; }
    }

    [['20','ts20'],['50','ts50'],['100','ts100'],['200','ts200']].forEach(([p,pfx])=>{
      const el = document.getElementById(`${pfx}-${id}`);
      if(!el) return;
      const sma = d[`sma${p}`];
      if(!sma){ el.innerText='â€”'; return; }
      const above = d.price > sma;
      el.className = 'sma-arrow '+(above?'up':'dn');
      el.innerHTML = above ? 'â–²' : 'â–¼';
      el.title = `SMA${p}: ${sma.toFixed(2)}`;
    });

    const crEl = document.getElementById(`tcr-${id}`);
    if(crEl && d.sma100 && d.sma200){
      crEl.innerHTML = d.sma100 > d.sma200
        ? '<span style="color:#00e676;font-weight:800">Golden</span>'
        : '<span style="color:#ff4444;font-weight:800">Death</span>';
    }

    const stEl = document.getElementById(`tst-${id}`);
    if(stEl){
      if(d.st_dir === 1)
        stEl.innerHTML = '<span style="color:#00e676">â–² Alcista</span>';
      else if(d.st_dir === -1)
        stEl.innerHTML = '<span style="color:#ff4444">â–¼ Bajista</span>';
      else stEl.innerText = 'â€”';
    }

    // Borde alerta si en watchlist
    const row = document.getElementById('fc-'+id);
    if(row){
      const now=Date.now(), week=7*24*3600*1000;
      const alerts=(alertsByTicker[ticker]||[]).filter(x=>now-x.ts<week);
      row.style.borderLeft = (watchlist.has(ticker)&&alerts.length)
        ? '3px solid #ff007f' : '3px solid transparent';
    }
  } catch(e){}
}

function toggleFavs(){
  favsOpen = !favsOpen;
  document.getElementById('favBody').classList.toggle('open',favsOpen);
  document.getElementById('favBody').classList.toggle('closed',!favsOpen);
  document.getElementById('favChevron').style.transform = favsOpen?'rotate(0deg)':'rotate(-90deg)';
  if(favsOpen) setTimeout(()=>ALL_ASSETS.forEach(f=>loadRowData(f.ticker)), 120);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIGILANCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWatcher(){ checkWatchlist(); setInterval(checkWatchlist, 5*60*1000); }

async function checkWatchlist(){
  if(watchlist.size===0){ setWatchStatus('idle'); renderWatchPanel(); return; }
  const tickers = [...watchlist].join(',');
  try {
    const r = await fetch(`/api/watch?tickers=${encodeURIComponent(tickers)}`);
    const d = await r.json();
    const now = Date.now();
    (d.alertas||[]).forEach(a => {
      const m = a.msg.match(/^\[([^\]]+)\]/);
      const t = m?m[1]:'?';
      if(!alertsByTicker[t]) alertsByTicker[t]=[];
      const isDup = alertsByTicker[t].some(x=>x.msg===a.msg && now-x.ts<5*60*1000);
      if(!isDup) alertsByTicker[t].push({msg:a.msg, nivel:a.nivel, ts:now});
    });
    const week=7*24*3600*1000;
    Object.keys(alertsByTicker).forEach(t=>{
      alertsByTicker[t]=alertsByTicker[t].filter(x=>now-x.ts<week);
      if(!alertsByTicker[t].length) delete alertsByTicker[t];
    });
    const total=Object.values(alertsByTicker).reduce((s,a)=>s+a.length,0);
    setWatchStatus(total>0?'alert':'ok');
    renderWatchPanel();
    (d.alertas||[]).forEach(a=>{
      if(!shownToasts.has(a.msg)){
        shownToasts.add(a.msg);
        showToast(a.msg, a.nivel);
        setTimeout(()=>shownToasts.delete(a.msg), 2*3600*1000);
      }
    });
    if(watchlist.has(currentSymbol)) renderCurrentAlerts();
  } catch(e){ setWatchStatus('err'); }
}

function setWatchStatus(s){
  const dot=document.getElementById('watchDot'), lbl=document.getElementById('watchLabel');
  const m={ok:['#00e676','Activa'],alert:['#ff007f','Â¡Alerta!'],err:['#555','Error'],idle:['rgba(255,255,255,.15)','En espera']};
  const[c,t]=m[s]||m.ok;
  dot.style.background=c; lbl.style.color=c; lbl.innerText=t;
}

function renderWatchPanel(){
  const emptyEl=document.getElementById('watchEmpty');
  const listEl=document.getElementById('watch-alerts-list');
  const countEl=document.getElementById('watchCount');
  if(watchlist.size===0){ emptyEl.style.display='block'; listEl.innerHTML=''; countEl.innerText=''; return; }
  emptyEl.style.display='none';
  const now=Date.now(), week=7*24*3600*1000;
  let html='', total=0;
  [...watchlist].forEach(ticker=>{
    const alerts=(alertsByTicker[ticker]||[]).filter(x=>now-x.ts<week);
    if(!alerts.length) return;
    total+=alerts.length;
    html+=`<div style="margin-bottom:6px">
      <div style="font-size:9px;font-weight:800;letter-spacing:.08em;color:rgba(255,255,255,.35);
        text-transform:uppercase;margin-bottom:3px;display:flex;justify-content:space-between">
        <span>${ticker}</span><span style="color:rgba(255,255,255,.2);font-weight:400">${alerts.length} alerta${alerts.length>1?'s':''}</span>
      </div>`;
    alerts.slice().reverse().forEach(a=>{
      html+=`<div class="w-alerta ${a.nivel}" onclick="loadSymbol('${ticker}')">
        <span class="w-ticker">${ticker}</span>${a.msg.replace(/^\[[^\]]+\]\s*/,'')}
        <span style="float:right;font-size:9px;opacity:.5;margin-left:4px">${relTime(a.ts)}</span>
      </div>`;
    });
    html+='</div>';
  });
  if(!html) html=`<div style="font-size:10px;color:rgba(255,255,255,.2);padding:4px 0">Sin alertas en los Ãºltimos 7 dÃ­as.</div>`;
  listEl.innerHTML=html;
  countEl.innerText=total>0 ? `${total} alerta${total>1?'s':''} esta semana`
    : `${watchlist.size} activo${watchlist.size>1?'s':''} vigilados â€” sin alertas recientes`;
}

function relTime(ts){
  const d=Date.now()-ts;
  if(d<60000)return'ahora';
  if(d<3600000)return`${Math.floor(d/60000)}m`;
  if(d<86400000)return`${Math.floor(d/3600000)}h`;
  return`${Math.floor(d/86400000)}d`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchData(sym){
  const r=await fetch(`/api/chart/${encodeURIComponent(sym)}?interval=1d`);
  const d=await r.json();
  if(d.error) throw new Error(d.error);
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTLY â€” configuraciÃ³n idÃ©ntica a Matrix Lab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BG = '#07070f';

function renderPlotly(apiData){
  const cd    = apiData.chart;
  const dates = cd.candles.map(c=>new Date(c.x));
  const closes= cd.candles.map(c=>c.c);
  const last  = closes[closes.length-1]||1;
  const yFmt  = last>500?',.0f':last>1?',.2f':',.4f';
  const traces= [];

  // Precio lÃ­nea
  traces.push({
    x:dates, y:closes,
    type:'scatter', mode:'lines', name:'Precio',
    line:{color:'rgba(255,255,255,1)',width:1,shape:'linear'},
    fill:'tozeroy', fillcolor:'rgba(255,255,255,.08)',
    hovertemplate:'<b>%{x|%d %b %Y}</b><br><b>$%{y:,.2f}</b><extra></extra>',
  });

  const xy = arr => ({xs:arr.map(p=>new Date(p.x)), ys:arr.map(p=>p.y)});

  // SMAs
  [{key:'sma20',data:cd.sma20,col:'rgba(0,255,255,.85)',  w:1.2,name:'SMA 20'},
   {key:'sma50',data:cd.sma50,col:'rgba(255,255,0,.85)',  w:1.5,name:'SMA 50'},
   {key:'sma100',data:cd.sma100,col:'rgba(255,200,100,.85)',w:1.8,name:'SMA 100'},
   {key:'sma200',data:cd.sma200,col:'rgba(200,150,220,.9)', w:2.2,name:'SMA 200'},
  ].forEach(s=>{
    if(!indVisible[s.key]) return;
    const{xs,ys}=xy(s.data);
    traces.push({x:xs,y:ys,type:'scatter',mode:'lines',name:s.name,
      line:{color:s.col,width:s.w},
      hovertemplate:`<b>${s.name}</b>: $%{y:,.2f}<extra></extra>`});
  });

  // Supertrend
  if(indVisible.st){
    const stB=xy(cd.st_buy), stS=xy(cd.st_sell);
    if(stB.xs.length) traces.push({x:stB.xs,y:stB.ys,type:'scatter',mode:'markers',name:'STâ–²',
      marker:{color:'rgba(0,255,100,.8)',size:3,symbol:'circle'},
      hovertemplate:'STâ–²: $%{y:,.2f}<extra></extra>'});
    if(stS.xs.length) traces.push({x:stS.xs,y:stS.ys,type:'scatter',mode:'markers',name:'STâ–¼',
      marker:{color:'rgba(255,50,50,.8)',size:3,symbol:'circle'},
      hovertemplate:'STâ–¼: $%{y:,.2f}<extra></extra>'});
  }

  // RSI seÃ±ales
  if(indVisible.rsi){
    const ros=xy(cd.rsi_os), rob=xy(cd.rsi_ob);
    if(ros.xs.length) traces.push({x:ros.xs,y:ros.ys,type:'scatter',mode:'markers',name:'RSI<30',
      marker:{color:'#00e676',size:9,symbol:'triangle-up',line:{color:'#07070f',width:1.5}},
      hovertemplate:'ğŸŸ¢ Sobreventa<br>$%{y:,.2f}<extra></extra>'});
    if(rob.xs.length) traces.push({x:rob.xs,y:rob.ys,type:'scatter',mode:'markers',name:'RSI>70',
      marker:{color:'#ff007f',size:9,symbol:'triangle-down',line:{color:'#07070f',width:1.5}},
      hovertemplate:'ğŸ”´ Sobrecompra<br>$%{y:,.2f}<extra></extra>'});
  }

  // Layout â€” igual que Matrix Lab
  const layout = {
    paper_bgcolor: BG,
    plot_bgcolor:  '#0a0a12',   // â† Matrix Lab usa este mÃ¡s oscuro
    margin: {t:12, r:60, b:50, l:50},
    hovermode:'x unified',
    hoverlabel:{bgcolor:'rgba(10,10,22,.95)',bordercolor:'rgba(255,255,255,.1)',
      font:{family:'JetBrains Mono,monospace',size:11,color:'#e0e0e0'}},
    showlegend:false,
    xaxis:{
      type:'date',
      gridcolor:'rgba(255,255,255,.04)',
      linecolor:'rgba(255,255,255,.07)',
      tickcolor:'rgba(255,255,255,.2)',
      tickfont:{color:'rgba(255,255,255,.45)',size:9},
      showspikes:true,spikecolor:'rgba(255,255,255,.1)',spikedash:'dot',spikethickness:1,
      rangeslider:{visible:false}
    },
    yaxis:{
      gridcolor:'rgba(255,255,255,.04)',
      linecolor:'rgba(255,255,255,.07)',
      tickfont:{color:'rgba(255,255,255,.4)',size:9},
      side:'right', tickformat:yFmt
    },
    dragmode:'pan', font:{family:'Inter,sans-serif'}
  };

  // Preservar rango actual o mostrar Ãºltimos 2 meses (igual que Matrix Lab)
  const div = document.getElementById('plotDiv');
  if(div && div.layout && div.layout.xaxis && div.layout.xaxis.range){
    layout.xaxis.range = div.layout.xaxis.range;
  } else {
    const lastDate = dates[dates.length-1];
    if(lastDate){
      const twoMonthsAgo = new Date(lastDate.getTime() - 60*24*60*60*1000);
      layout.xaxis.range = [twoMonthsAgo.toISOString(), lastDate.toISOString()];
    }
  }

  Plotly.react('plotDiv', traces, layout,
    {responsive:true, scrollZoom:true, displayModeBar:false, doubleClick:'reset'});

  // Panel RSI
  const rsiWrap = document.getElementById('rsiWrap');
  if(indVisible.rsi){
    rsiWrap.style.display='block';
    renderRSIPanel(cd, dates);
  } else {
    rsiWrap.style.display='none';
  }
}

function renderRSIPanel(cd, dates){
  const d0=dates[0]||new Date(), dN=dates[dates.length-1]||new Date();
  const ros=cd.rsi_os.map(p=>new Date(p.x));
  const rob=cd.rsi_ob.map(p=>new Date(p.x));
  const rt=[
    {x:[d0,dN],y:[30,30],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',
     line:{color:'rgba(0,230,118,.3)',width:1,dash:'dot'}},
    {x:[d0,dN],y:[70,70],type:'scatter',mode:'lines',showlegend:false,hoverinfo:'skip',
     line:{color:'rgba(255,0,127,.3)',width:1,dash:'dot'}},
    {x:ros,y:ros.map(()=>20),type:'scatter',mode:'markers',name:'SV',
     marker:{color:'#00e676',size:6,symbol:'triangle-up',line:{color:'#07070f',width:1}},
     hovertemplate:'ğŸŸ¢ Sobreventa<extra></extra>'},
    {x:rob,y:rob.map(()=>80),type:'scatter',mode:'markers',name:'SC',
     marker:{color:'#ff007f',size:6,symbol:'triangle-down',line:{color:'#07070f',width:1}},
     hovertemplate:'ğŸ”´ Sobrecompra<extra></extra>'},
  ];
  const rl={
    paper_bgcolor:BG, plot_bgcolor:'rgba(255,255,255,.01)',
    margin:{t:8,r:60,b:40,l:50}, showlegend:false,
    xaxis:{type:'date',gridcolor:'rgba(255,255,255,.03)',linecolor:'rgba(255,255,255,.05)',
      tickfont:{color:'rgba(255,255,255,.3)',size:9},tickformat:'%d %b',rangeslider:{visible:false}},
    yaxis:{range:[0,100],gridcolor:'rgba(255,255,255,.03)',
      tickfont:{color:'rgba(255,255,255,.2)',size:8},side:'right',tickvals:[30,50,70]},
    shapes:[
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:0,y1:30,fillcolor:'rgba(0,230,118,.04)',line:{width:0}},
      {type:'rect',xref:'paper',yref:'y',x0:0,x1:1,y0:70,y1:100,fillcolor:'rgba(255,0,127,.04)',line:{width:0}}
    ],
    font:{family:'Inter,sans-serif'}, dragmode:'pan'
  };
  Plotly.react('rsiDiv',rt,rl,{responsive:true,scrollZoom:false,displayModeBar:false});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleInd(key){
  indVisible[key] = !indVisible[key];
  document.getElementById('tog-'+key).classList.toggle('off', !indVisible[key]);
  if(lastData) renderPlotly(lastData);
}

// Zoom â€” igual que Matrix Lab
function zoomChart(factor){
  const div = document.getElementById('plotDiv');
  if(!div||!div.layout||!div.layout.xaxis) return;
  const xRange = div.layout.xaxis.range;
  if(!xRange||xRange.length<2) return;
  const start  = new Date(xRange[0]).getTime();
  const end    = new Date(xRange[1]).getTime();
  const center = (start+end)/2;
  const half   = ((end-start)/2)/factor;
  Plotly.relayout('plotDiv',{'xaxis.range':[
    new Date(center-half).toISOString(),
    new Date(center+half).toISOString()
  ]});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGA DE SÃMBOLO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSymbol(sym){
  currentSymbol = sym;
  document.getElementById('symbolInput').value = sym;
  document.querySelectorAll('.asset-row').forEach(r=>r.classList.remove('active-sym'));
  const el = document.getElementById('fc-'+favId(sym));
  if(el) el.classList.add('active-sym');

  document.getElementById('loadWrap').style.display='flex';
  try {
    const data = await fetchData(sym);
    lastData = data;
    document.getElementById('loadWrap').style.display='none';
    renderPlotly(data);
    updateSidebar(data);
    renderCurrentAlerts();
  } catch(e){
    document.getElementById('loadWrap').style.display='none';
    showToast('âŒ '+e.message,'bearish');
  }
}

function renderCurrentAlerts(){
  const fromWatch = watchlist.has(currentSymbol)?(alertsByTicker[currentSymbol]||[]):[];
  const fromData  = lastData?(lastData.alertas||[]):[];
  const all = fromWatch.length ? fromWatch.map(a=>({msg:a.msg,nivel:a.nivel})) : fromData;
  renderAlertas(all);
}

function doSearch(){
  const s = document.getElementById('symbolInput').value.trim().toUpperCase();
  if(s) loadSymbol(s);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSidebar(data){
  document.getElementById('dispSym').innerText = currentSymbol;
  document.getElementById('dispPrice').innerText =
    data.last_price.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
  const chEl = document.getElementById('dispChange');
  const pre  = data.change>=0?'+':'';
  chEl.innerText  = `${pre}${data.change.toFixed(2)} (${pre}${data.change_pct.toFixed(2)}%)`;
  chEl.style.color = data.change>=0?'#00e676':'#ff4444';
  updateRSI(data.rsi_current);
  document.getElementById('alertSymLabel').innerText = currentSymbol;
}

function updateRSI(v){
  v = parseFloat(v); if(isNaN(v)) return;
  document.getElementById('rsiVal').innerText = v.toFixed(1);
  document.getElementById('rsiCursor').style.left = `calc(${Math.min(Math.max(v,0),100)}% - 5px)`;
  const lbl=document.getElementById('rsiLbl'), val=document.getElementById('rsiVal');
  if(v<30){
    lbl.innerText='SV';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(0,230,118,.12);color:#00e676;font-weight:700';
    val.style.color='#00e676';
  } else if(v>70){
    lbl.innerText='SC';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,68,68,.12);color:#ff5252;font-weight:700';
    val.style.color='#ff5252';
  } else {
    lbl.innerText='N';lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);font-weight:700';
    val.style.color='#fff';
  }
}

function renderAlertas(alertas){
  const box=document.getElementById('alertBox'), list=document.getElementById('alertList');
  if(!alertas||!alertas.length){ box.style.display='none'; return; }
  box.style.display='block';
  list.innerHTML=alertas.map(a=>`<div class="alerta-item ${a.nivel}">${a.msg.replace(/^\[[^\]]+\]\s*/,'')}</div>`).join('');
}

function showToast(msg,nivel,ms=6000){
  const c=document.getElementById('toasts');
  const t=document.createElement('div');
  t.className=`toast ${nivel}`; t.innerText=msg;
  c.appendChild(t); setTimeout(()=>t.remove(),ms);
}
</script>
</body>
</html>
