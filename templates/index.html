<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expande Tu Futuro</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js stack â€” unpkg (evita bloqueo de Tracking Prevention) -->
<script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://unpkg.com/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
<script src="https://unpkg.com/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
<script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://unpkg.com/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #07070f; color: #e0e0e0; min-height: 100vh; }
.mono { font-family: 'JetBrains Mono', monospace; }
.card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 14px; }

.btn-p { padding: 3px 14px; border-radius: 7px; font-size: 12px; font-weight: 600;
         color: rgba(255,255,255,0.3); transition: all .15s; cursor: pointer; background: transparent; border: none; }
.btn-p:hover:not(.active) { color: #fff; background: rgba(255,255,255,0.06); }
.btn-p.active { background: #ff007f; color: #fff; }

.btn-zoom { padding: 3px 10px; border-radius: 7px; font-size: 11px; font-weight: 600;
            color: rgba(255,255,255,0.3); cursor: pointer; transition: all .15s;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }
.btn-zoom:hover { color: #fff; background: rgba(255,255,255,0.08); }

#chartWrap { position: relative; height: 520px; cursor: grab; }
#chartWrap:active { cursor: grabbing; }
#mainChart { position: absolute; inset: 0; width: 100% !important; height: 100% !important; }

/* Toasts */
#toasts { position: fixed; top: 16px; right: 16px; z-index: 1000;
          display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.toast { padding: 11px 16px; border-radius: 11px; font-size: 13px; font-weight: 500;
         max-width: 340px; backdrop-filter: blur(14px); pointer-events: auto;
         animation: slideIn .25s ease; line-height: 1.45; }
.toast.bullish { background: rgba(0,230,118,.12); color: #00e676; border: 1px solid rgba(0,230,118,.25); }
.toast.bearish  { background: rgba(255,68,68,.12);  color: #ff5252; border: 1px solid rgba(255,68,68,.25); }
.toast.info     { background: rgba(255,0,127,.12);  color: #ff69b4; border: 1px solid rgba(255,0,127,.25); }
@keyframes slideIn { from { opacity:0; transform:translateX(12px); } to { opacity:1; transform:none; } }

.alerta-item { padding: 7px 10px; border-radius: 9px; font-size: 11.5px; font-weight: 500; line-height: 1.4; }
.alerta-item.bullish { background: rgba(0,230,118,.07); color: #00e676; }
.alerta-item.bearish  { background: rgba(255,68,68,.07);  color: #ff5252; }
.alerta-item.info     { background: rgba(255,0,127,.07);  color: #ff69b4; }

.fav-row { display: flex; align-items: center; justify-content: space-between;
           padding: 7px 10px; border-radius: 9px; cursor: pointer;
           transition: background .15s; gap: 10px; }
.fav-row:hover { background: rgba(255,255,255,.04); }
.fav-row.active-sym { background: rgba(255,0,127,.07); }

/* AcordeÃ³n favoritos */
.fav-body { overflow: hidden; transition: max-height .3s ease, opacity .25s ease; }
.fav-body.open  { max-height: 400px; opacity: 1; }
.fav-body.closed { max-height: 0; opacity: 0; }

input:focus { outline: none; border-color: rgba(255,0,127,.5) !important; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 4px; }
</style>
</head>
<body>

<div id="toasts"></div>

<div class="max-w-[1400px] mx-auto p-4 lg:p-5 flex flex-col gap-4">

  <!-- HEADER -->
  <header class="flex items-center justify-between gap-3 flex-wrap">
    <div class="flex items-center gap-2.5">
      <div class="w-8 h-8 rounded-lg flex items-center justify-center shrink-0"
           style="background:#ff007f;box-shadow:0 0 16px rgba(255,0,127,.35)">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
      </div>
      <span class="text-base font-bold tracking-tight">EXPANDE
        <span style="color:#ff007f">TU FUTURO</span></span>
    </div>
    <div class="flex items-center gap-2 flex-1 max-w-sm">
      <input id="symbolInput" type="text" placeholder="AAPL Â· BTC-USD Â· ^GSPC Â· SPYâ€¦"
             class="flex-1 bg-[#111] border border-white/10 rounded-lg px-3 py-2 text-sm transition-all"
             onkeydown="if(event.key==='Enter') doSearch()">
      <button onclick="doSearch()"
              class="px-4 py-2 rounded-lg text-sm font-semibold text-white shrink-0 hover:brightness-110 transition-all"
              style="background:#ff007f">Buscar</button>
    </div>
  </header>

  <!-- FILA PRINCIPAL: Precio+RSI | GrÃ¡fica -->
  <div class="flex flex-col lg:flex-row gap-4">

    <!-- COLUMNA IZQUIERDA: Precio + RSI + Alertas -->
    <div class="lg:w-[190px] shrink-0 flex flex-col gap-3">

      <!-- Precio + RSI -->
      <div class="card p-4">
        <div id="displaySymbol" class="text-[11px] font-bold tracking-widest mb-1" style="color:#ff007f">---</div>
        <div id="displayPrice" class="mono text-2xl font-semibold leading-tight">---</div>
        <div id="displayChange" class="text-xs mt-1.5 font-medium">--</div>
        <div class="mt-3 pt-3 border-t border-white/5">
          <div class="flex items-center justify-between mb-1.5">
            <span class="text-[10px] text-white/25 uppercase tracking-wider">RSI 14</span>
            <div class="flex items-center gap-1.5">
              <span id="rsiVal" class="mono text-sm font-bold text-white">--</span>
              <span id="rsiLbl" class="text-[9px] px-1.5 py-0.5 rounded font-bold"
                    style="background:rgba(255,255,255,.06);color:rgba(255,255,255,.3)">--</span>
            </div>
          </div>
          <div class="relative h-1.5 rounded-full"
               style="background:linear-gradient(to right,#00e67630 0%,#00e67630 30%,rgba(255,255,255,.05) 30%,rgba(255,255,255,.05) 70%,#ff174430 70%,#ff174430 100%)">
            <div id="rsiCur" class="absolute top-1/2 w-2 h-2 rounded-full bg-white shadow"
                 style="left:50%;transform:translate(-50%,-50%);transition:left .4s"></div>
          </div>
        </div>
      </div>

      <!-- Alertas (solo en desktop junto al grÃ¡fico) -->
      <div id="alertBox" class="card p-3 hidden">
        <div class="text-[10px] uppercase tracking-widest text-white/20 font-semibold mb-2 px-1">âš¡ Alertas</div>
        <div id="alertList" class="flex flex-col gap-1.5 max-h-48 overflow-y-auto"></div>
      </div>
    </div>

    <!-- GRÃFICA -->
    <div class="flex-1 card p-4 flex flex-col gap-3">
      <!-- Controles superiores -->
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="flex flex-col gap-1.5">
          <div class="text-[9px] uppercase tracking-widest text-white/20 font-semibold px-1">Intervalo de vela</div>
          <div class="flex gap-0.5 bg-white/5 p-0.5 rounded-xl">
            <button class="btn-p active" data-i="1d"  onclick="setInterval_('1d')">1D</button>
            <button class="btn-p"        data-i="1wk" onclick="setInterval_('1wk')">1S</button>
            <button class="btn-p"        data-i="1mo" onclick="setInterval_('1mo')">1M</button>
            <button class="btn-p"        data-i="3mo" onclick="setInterval_('3mo')">3M</button>
          </div>
        </div>
        <div class="flex flex-col gap-1.5 items-end">
          <div class="text-[9px] uppercase tracking-widest text-white/20 font-semibold px-1">Zoom Â· Arrastra para mover</div>
          <div class="flex gap-1">
            <button class="btn-zoom" onclick="zoomIn()">ï¼‹</button>
            <button class="btn-zoom" onclick="zoomOut()">ï¼</button>
            <button class="btn-zoom" onclick="resetZoom()">âŸ³</button>
          </div>
        </div>
      </div>

      <!-- Leyenda -->
      <div class="flex items-center gap-3 flex-wrap" style="font-size:10px;color:rgba(255,255,255,.22)">
        <span>ğŸ•¯ Velas</span>
        <span><span style="color:#00ffff">â”€</span> SMA20</span>
        <span><span style="color:#ffff00">â”€</span> SMA50</span>
        <span><span style="color:#fff176">â”€</span> SMA100</span>
        <span><span style="color:#ce93d8">â”€</span> SMA200</span>
        <span><span style="color:#00ff00">â—</span> STâ–² <span style="color:#ff3333">â—</span> STâ–¼</span>
        <span><span style="color:#ff007f">â—</span> RSI extremo</span>
      </div>

      <!-- Canvas wrapper con altura fija -->
      <div id="chartWrap"><canvas id="mainChart"></canvas></div>
    </div>
  </div>

  <!-- FILA INFERIOR: Favoritos + Vigilancia -->
  <div class="flex flex-col lg:flex-row gap-4">

    <!-- FAVORITOS (plegados por defecto) -->
    <div class="flex-1 card p-4">
      <button onclick="toggleFavs()"
              class="w-full flex items-center justify-between bg-transparent border-0 cursor-pointer"
              style="color:inherit">
        <div class="flex items-center gap-2">
          <span style="color:#ff007f;font-size:14px">â˜…</span>
          <span class="text-sm font-semibold">Favoritos</span>
          <span class="text-[10px] text-white/25 ml-1">â€” click para expandir</span>
        </div>
        <span id="favChevron" class="text-white/30 transition-transform duration-300 text-xs" style="transform:rotate(-90deg)">â–¼</span>
      </button>

      <!-- Body plegado por defecto -->
      <div id="favBody" class="fav-body closed">
        <div id="favItems" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2 mt-3"></div>
      </div>
    </div>

    <!-- VIGILANCIA -->
    <div class="lg:w-[260px] shrink-0 card p-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-semibold">ğŸ”” Vigilancia</span>
        <div class="flex items-center gap-1.5">
          <span id="watchDot" class="w-2 h-2 rounded-full" style="background:rgba(255,255,255,.15)"></span>
          <span id="watchLabel" class="text-xs font-semibold" style="color:rgba(255,255,255,.2)">--</span>
        </div>
      </div>
      <p class="text-[11px] leading-5" style="color:rgba(255,255,255,.25)">
        Comprueba favoritos cada 5 min. Emite alerta cuando el precio toca cualquier SMA o se producen cruces relevantes.
      </p>
    </div>

  </div>

</div><!-- end max-w -->

<script>
// â”€â”€ VERIFICACIÃ“N DE DEPENDENCIAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function checkDeps() {
  const missing = [];
  if (typeof Chart === 'undefined') missing.push('Chart.js');
  if (typeof luxon === 'undefined') missing.push('Luxon (adaptador de fechas)');
  if (missing.length) {
    const wrap = document.getElementById('chartWrap');
    if (wrap) wrap.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:12px;color:rgba(255,255,255,.4);padding:24px">
        <div style="font-size:32px">âš ï¸</div>
        <div style="font-size:14px;font-weight:600;color:rgba(255,100,100,.8)">Scripts bloqueados: ${missing.join(', ')}</div>
        <div style="font-size:12px;text-align:center;max-width:340px;line-height:1.7;color:rgba(255,255,255,.3)">
          El Tracking Prevention de Edge/Safari bloqueÃ³ las librerÃ­as.<br>
          SoluciÃ³n: ve a <strong style="color:#ff007f">ConfiguraciÃ³n del sitio â†’ Permisos</strong>
          y desactiva la protecciÃ³n contra rastreo para esta URL, o prueba en Chrome.
        </div>
      </div>`;
    return;
  }
})();

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSymbol   = 'BTC-USD';
let currentInterval = '1d';
let mainChart       = null;
let sparkCharts     = {};
let favsOpen        = false;   // â† plegado por defecto
let shownAlerts     = new Set();

const FAVS = [
  { name:'Bitcoin',    ticker:'BTC-USD' },
  { name:'Ethereum',   ticker:'ETH-USD' },
  { name:'S&P 500',    ticker:'^GSPC'   },
  { name:'Nasdaq 100', ticker:'^NDX'    },
  { name:'Apple',      ticker:'AAPL'    },
  { name:'SPY',        ticker:'SPY'     },
  { name:'Oro',        ticker:'GLD'     },
];

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  buildFavs();
  loadSymbol('BTC-USD');
  startWatcher();
};

// â”€â”€ TOGGLE FAVORITOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFavs() {
  favsOpen = !favsOpen;
  const body    = document.getElementById('favBody');
  const chevron = document.getElementById('favChevron');
  if (favsOpen) {
    body.classList.remove('closed');
    body.classList.add('open');
    chevron.style.transform = 'rotate(0deg)';
  } else {
    body.classList.remove('open');
    body.classList.add('closed');
    chevron.style.transform = 'rotate(-90deg)';
  }
}

// â”€â”€ FAVORITOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function favId(ticker) { return ticker.replace(/[^a-z0-9]/gi,'_'); }

function buildFavs() {
  const c = document.getElementById('favItems');
  c.innerHTML = '';
  FAVS.forEach(f => {
    const id  = favId(f.ticker);
    const row = document.createElement('div');
    row.className = 'fav-row card';
    row.id        = 'fav-' + id;
    row.onclick   = () => loadSymbol(f.ticker);
    row.innerHTML = `
      <div class="flex flex-col gap-1 w-full">
        <div class="flex items-center justify-between">
          <span class="text-xs font-semibold truncate">${f.name}</span>
          <span id="pct-${id}" class="mono text-[9px] text-white/25 shrink-0">â€¦</span>
        </div>
        <canvas id="spark-${id}" height="28" style="width:100%;max-width:100%"></canvas>
        <div class="mono text-[9px] text-white/20">${f.ticker}</div>
      </div>`;
    c.appendChild(row);
    loadSparkline(f.ticker);
  });
}

async function loadSparkline(ticker) {
  try {
    const res = await fetch(`/api/sparkline/${ticker}`);
    const d   = await res.json();
    if (!d.closes || d.closes.length < 2) return;
    const id  = favId(ticker);
    const cvs = document.getElementById(`spark-${id}`);
    if (!cvs) return;
    if (sparkCharts[ticker]) sparkCharts[ticker].destroy();
    const up = d.pct >= 0;
    sparkCharts[ticker] = new Chart(cvs.getContext('2d'), {
      type: 'line',
      data: {
        labels: d.closes.map((_,i) => i),
        datasets: [{ data: d.closes,
          borderColor: up ? '#00e676' : '#ff4444',
          backgroundColor: up ? 'rgba(0,230,118,.07)' : 'rgba(255,68,68,.07)',
          borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0 }]
      },
      options: { responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        scales:{ x:{display:false}, y:{display:false} } }
    });
    const pEl = document.getElementById(`pct-${id}`);
    if (pEl) { pEl.style.color = up ? '#00e676' : '#ff4444'; pEl.innerText = `${up?'+':''}${d.pct.toFixed(2)}%`; }
  } catch(e) {}
}

// â”€â”€ VIGILANCIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startWatcher() {
  checkAllFavs();
  setInterval(checkAllFavs, 5 * 60 * 1000);
}

async function checkAllFavs() {
  const tickers = FAVS.map(f => f.ticker).join(',');
  try {
    const res  = await fetch(`/api/watch?tickers=${encodeURIComponent(tickers)}`);
    const data = await res.json();
    setWatchStatus(data.alertas && data.alertas.length > 0 ? 'alert' : 'ok');
    (data.alertas || []).forEach(a => {
      if (!shownAlerts.has(a.msg)) {
        shownAlerts.add(a.msg);
        showToast(a.msg, a.nivel);
        setTimeout(() => shownAlerts.delete(a.msg), 2 * 60 * 60 * 1000);
      }
    });
  } catch(e) { setWatchStatus('err'); }
}

function setWatchStatus(state) {
  const dot   = document.getElementById('watchDot');
  const label = document.getElementById('watchLabel');
  const m = { ok:['#00e676','Activa'], alert:['#ff007f','Â¡Alerta!'], err:['#555','Error'] };
  const [c, t] = m[state] || m.ok;
  dot.style.background = c; label.style.color = c; label.innerText = t;
}

// â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchData(symbol, interval) {
  const res = await fetch(`/api/chart/${encodeURIComponent(symbol)}?interval=${interval}`);
  const d   = await res.json();
  if (d.error) throw new Error(d.error);
  return d;
}

// â”€â”€ RENDER CANDLESTICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChart(data) {
  // Destruir chart previo
  if (mainChart) { mainChart.destroy(); mainChart = null; }

  const wrap = document.getElementById('chartWrap');
  // Reemplazar canvas para evitar errores de reutilizaciÃ³n
  wrap.innerHTML = '<canvas id="mainChart"></canvas>';
  const canvas = document.getElementById('mainChart');
  canvas.style.position = 'absolute';
  canvas.style.inset = '0';
  canvas.style.width = '100%';
  canvas.style.height = '100%';

  const ctx = canvas.getContext('2d');
  const cd  = data.chart;

  const scatterDS = (pts, color, radius, label) => ({
    type: 'scatter', label,
    data: pts,
    backgroundColor: color,
    borderColor: 'transparent',
    pointRadius: radius,
    pointHoverRadius: radius + 2,
    showLine: false,
  });

  const lineDS = (pts, color, width, label, dash=[]) => ({
    type: 'line', label,
    data: pts,
    borderColor: color,
    backgroundColor: 'transparent',
    borderWidth: width,
    borderDash: dash,
    fill: false,
    tension: 0.1,
    pointRadius: 0,
    parsing: false,
  });

  const datasets = [
    {
      type: 'candlestick',
      label: 'Precio',
      data: cd.candles,
      color: { up:'#26a69a', down:'#ef5350', unchanged:'#999' },
      borderColor: { up:'#26a69a', down:'#ef5350', unchanged:'#999' },
    },
    lineDS(cd.sma20,  'rgba(0,255,255,0.7)',    1,   'SMA 20'),
    lineDS(cd.sma50,  'rgba(255,255,0,0.7)',    1.5, 'SMA 50'),
    lineDS(cd.sma100, 'rgba(255,241,118,0.7)',  2,   'SMA 100'),
    lineDS(cd.sma200, 'rgba(206,147,216,0.85)', 2.5, 'SMA 200'),
    scatterDS(cd.st_buy,  '#00ff00', 3, 'ST â–²'),
    scatterDS(cd.st_sell, '#ff3333', 3, 'ST â–¼'),
    scatterDS(cd.rsi_os,  '#ff007f', 6, 'RSI <30'),
    scatterDS(cd.rsi_ob,  '#ff007f', 6, 'RSI >70'),
  ];

  mainChart = new Chart(ctx, {
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 300 },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(8,8,20,.93)',
          borderColor: 'rgba(255,255,255,.07)',
          borderWidth: 1,
          titleColor: '#fff',
          bodyColor: 'rgba(255,255,255,.55)',
          padding: 10,
          callbacks: {
            label: ctx => {
              const r = ctx.raw;
              if (!r) return null;
              if (r.o !== undefined) {
                const fmt = v => v?.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) ?? '-';
                return [` O: ${fmt(r.o)}`, ` H: ${fmt(r.h)}`, ` L: ${fmt(r.l)}`, ` C: ${fmt(r.c)}`];
              }
              if (r.y != null) return ` ${ctx.dataset.label}: ${r.y.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
              return null;
            }
          }
        },
        zoom: {
          pan:  { enabled: true, mode: 'x', speed: 10 },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { displayFormats: { day:'dd MMM', week:'dd MMM', month:'MMM yy', quarter:'MMM yy' } },
          grid: { display: false },
          ticks: { color: 'rgba(255,255,255,.22)', font:{ size:10 }, maxTicksLimit: 10 }
        },
        y: {
          display: true, position: 'right',
          grid: { color: 'rgba(255,255,255,.03)' },
          ticks: {
            color: 'rgba(255,255,255,.28)', font:{ size:10 },
            callback: v => v >= 1000 ? v.toLocaleString() : v >= 1 ? v.toFixed(2) : v.toFixed(4)
          }
        }
      }
    }
  });

  // Panel lateral
  document.getElementById('displaySymbol').innerText = currentSymbol;
  document.getElementById('displayPrice').innerText  =
    data.last_price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  const chEl = document.getElementById('displayChange');
  const pre  = data.change >= 0 ? '+' : '';
  chEl.innerText   = `${pre}${data.change.toFixed(2)} (${pre}${data.change_pct.toFixed(2)}%)`;
  chEl.style.color = data.change >= 0 ? '#00e676' : '#ff4444';

  updateRSI(data.rsi_current);
  renderAlertas(data.alertas || []);

  // Marcar favorito activo
  document.querySelectorAll('.fav-row').forEach(r => r.classList.remove('active-sym'));
  const el = document.getElementById('fav-' + favId(currentSymbol));
  if (el) el.classList.add('active-sym');
}

// â”€â”€ ZOOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function zoomIn()    { if(mainChart) mainChart.zoom(1.25); }
function zoomOut()   { if(mainChart) mainChart.zoom(0.8);  }
function resetZoom() { if(mainChart) mainChart.resetZoom(); }

// â”€â”€ RSI WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRSI(v) {
  v = parseFloat(v);
  if (isNaN(v)) return;
  document.getElementById('rsiVal').innerText = v.toFixed(1);
  document.getElementById('rsiCur').style.left = `calc(${Math.min(Math.max(v,0),100)}% - 4px)`;
  const lbl = document.getElementById('rsiLbl');
  const val = document.getElementById('rsiVal');
  if (v < 30) {
    lbl.innerText='SV'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(0,230,118,.12);color:#00e676;font-weight:700;';
    val.style.color='#00e676';
  } else if (v > 70) {
    lbl.innerText='SC'; lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,68,68,.12);color:#ff5252;font-weight:700;';
    val.style.color='#ff5252';
  } else {
    lbl.innerText='N';  lbl.style.cssText='font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);font-weight:700;';
    val.style.color='#fff';
  }
}

// â”€â”€ ALERTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAlertas(alertas) {
  const box  = document.getElementById('alertBox');
  const list = document.getElementById('alertList');
  if (!alertas.length) { box.classList.add('hidden'); return; }
  box.classList.remove('hidden');
  list.innerHTML = alertas.map(a =>
    `<div class="alerta-item ${a.nivel}">${a.msg}</div>`).join('');
}

function showToast(msg, nivel, ms=7000) {
  const c = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = `toast ${nivel}`;
  t.innerText = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), ms);
}

// â”€â”€ CONTROL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSymbol(sym) {
  currentSymbol = sym;
  document.getElementById('symbolInput').value = sym;
  try {
    const data = await fetchData(sym, currentInterval);
    renderChart(data);
  } catch(e) {
    showToast('âŒ ' + e.message, 'bearish');
  }
}

function doSearch() {
  const sym = document.getElementById('symbolInput').value.trim().toUpperCase();
  if (sym) loadSymbol(sym);
}

function setInterval_(i) {
  currentInterval = i;
  document.querySelectorAll('.btn-p').forEach(b => b.classList.toggle('active', b.dataset.i === i));
  loadSymbol(currentSymbol);
}
</script>
</body>
</html>
